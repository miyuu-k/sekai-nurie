<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>せかいぬりえ - 修正版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFE4E1 50%, #FFF8DC 100%);
            min-height: 100vh;
            color: #8B4513;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            color: #FF69B4;
            text-shadow: 3px 3px 0px #FFB6C1;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #FF1493;
            margin-bottom: 20px;
        }

        .step-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);
            border: 4px solid #FFB6C1;
        }

        .step-title {
            font-size: 1.5rem;
            color: #FF69B4;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-area {
            border: 4px dashed #FFB6C1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #FFF8DC;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #FF69B4;
            background: #FFE4E1;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #FF1493;
            background: #FFB6C1;
        }

        .upload-icon {
            font-size: 4rem;
            color: #FF69B4;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.2rem;
            color: #8B4513;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .button {
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.6);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #FFB6C1;
            border-top: 5px solid #FF69B4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 100%;
            background-color: #FFE4E1;
            border-radius: 25px;
            padding: 3px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            border-radius: 25px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .result-container {
            display: none;
            text-align: center;
        }

        .print-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            margin-top: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #4169E1, #87CEEB);
            margin-top: 10px;
            margin-left: 10px;
        }

        .error-message {
            background: #FFE4E6;
            color: #D8000C;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #FFB6C1;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #E6FFE6;
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #90EE90;
            margin: 10px 0;
            display: none;
        }

        .instructions {
            background: #E6F3FF;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid #87CEEB;
        }

        .instructions h3 {
            color: #4682B4;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ol {
            color: #2F4F4F;
            font-size: 1.1rem;
            line-height: 1.6;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .status-text {
            font-size: 1.1rem;
            color: #FF69B4;
            margin-top: 10px;
        }

        /* APIキー設定用スタイル */
        .api-key-input {
            width: 70%;
            padding: 12px;
            border: 3px solid #FFB6C1;
            border-radius: 10px;
            font-size: 1rem;
            margin-right: 10px;
            font-family: monospace;
        }

        .api-key-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
        }

        .api-status {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: bold;
        }

        .api-status.success {
            background: #E6FFE6;
            color: #006400;
            border: 2px solid #90EE90;
        }

        .api-status.error {
            background: #FFE4E6;
            color: #D8000C;
            border: 2px solid #FFB6C1;
        }

        .api-help {
            margin-top: 15px;
        }

        .api-help summary {
            color: #FF69B4;
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }

        .api-help-content {
            margin-top: 10px;
            padding: 15px;
            background: #F0F8FF;
            border-radius: 10px;
            border: 2px solid #87CEEB;
        }

        @media (max-width: 600px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .step-container {
                padding: 20px;
            }

            .download-button {
                margin-left: 0;
                margin-top: 10px;
            }

            .api-key-input {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">🌈 せかいぬりえ 🎨</h1>
            <p class="subtitle">写真に忠実で かわいい ぬりえを つくろう！</p>
        </div>

        <div class="instructions">
            <h3>🎯 つかいかた</h3>
            <ol>
                <li>OpenAI APIキーを設定してね</li>
                <li>すきな写真を えらんでね</li>
                <li>「ぬりえにする」ボタンを おしてね</li>
                <li>ちょっと まっててね（30秒くらい）</li>
                <li>できあがったら プリントして ぬりえを たのしもう！</li>
            </ol>
        </div>

        <!-- APIキー設定セクション -->
        <div class="step-container" id="apiKeyContainer">
            <h2 class="step-title">🔑 OpenAI APIキー設定</h2>
            <p style="color: #8B4513; margin-bottom: 15px; line-height: 1.6;">
                より高品質で写真に忠実な線画を生成するために、OpenAI APIキーを設定してください。<br>
                <small style="color: #666;">※ APIキーはブラウザにのみ保存され、外部に送信されません</small>
            </p>
            
            <div style="margin-bottom: 20px;">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-proj-...">
                <button onclick="setApiKey()" class="api-key-button">🔧 設定</button>
            </div>
            
            <div id="apiKeyStatus" class="api-status"></div>
            
            <details class="api-help">
                <summary>📖 APIキーの取得方法</summary>
                <div class="api-help-content">
                    <ol style="color: #2F4F4F; line-height: 1.8;">
                        <li><a href="https://platform.openai.com/" target="_blank" style="color: #FF69B4; text-decoration: none; font-weight: bold;">OpenAI Platform</a> にアクセス</li>
                        <li>アカウントを作成・ログイン</li>
                        <li>左メニューの「API Keys」をクリック</li>
                        <li>「Create new secret key」をクリック</li>
                        <li>生成されたキー（sk-proj-で始まる）をコピー</li>
                        <li>上記の入力欄に貼り付けて「設定」をクリック</li>
                    </ol>
                    <p style="color: #D2691E; font-size: 0.9rem; margin-top: 15px; padding: 10px; background: #FFF8DC; border-radius: 5px;">
                        ⚠️ <strong>重要:</strong> APIキーは大切に管理してください。他人と共有しないでください。<br>
                        💰 DALL-E 3の利用料金: 1回あたり約3-8円程度
                    </p>
                </div>
            </details>
        </div>

        <!-- 画像アップロードセクション -->
        <div class="step-container" id="uploadContainer" style="opacity: 0.5; pointer-events: none;">
            <h2 class="step-title">📸 写真を えらんでね</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📱</div>
                <div class="upload-text">ここを タップして 写真を えらんでね</div>
                <div style="font-size: 0.9rem; color: #666;">JPEG、PNG、HEIC対応</div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div id="previewContainer" style="text-align: center; margin-top: 20px;">
                <!-- プレビュー画像がここに表示される -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button" id="generateButton" disabled>
                    🎨 忠実で かわいい ぬりえにする！
                </button>
            </div>
        </div>

        <!-- ローディング表示 -->
        <div class="loading" id="loadingContainer">
            <div class="spinner"></div>
            <p style="font-size: 1.2rem; color: #FF69B4; margin-bottom: 10px;">AI が 写真に忠実な ぬりえを つくっているよ... ✨</p>
            <div class="status-text" id="statusText">しゃしんを かいせきしています...</div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <!-- 結果表示 -->
        <div class="step-container result-container" id="resultContainer">
            <h2 class="step-title">🎉 できあがり！</h2>
            <div id="resultImage">
                <!-- 生成されたぬりえがここに表示される -->
            </div>
            <div>
                <button class="button print-button" onclick="printColoring()">
                    🖨️ プリントする
                </button>
                <button class="button download-button" onclick="downloadColoring()">
                    💾 ダウンロード
                </button>
            </div>
            <button class="button" onclick="resetApp()" style="margin-top: 20px; background: linear-gradient(45deg, #FFA500, #FFD700);">
                🔄 あたらしく つくる
            </button>
        </div>
    </div>

    <script>
        // グローバル変数
        let selectedFile = null;
        let generatedImageUrl = null;
        let OPENAI_API_KEY = '';

        // DOM要素の取得
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const generateButton = document.getElementById('generateButton');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultContainer = document.getElementById('resultContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statusText = document.getElementById('statusText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const uploadContainer = document.getElementById('uploadContainer');

        // APIキー管理
        function setApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (!apiKey) {
                showApiKeyStatus('APIキーを入力してください', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showApiKeyStatus('正しいAPIキー形式ではありません（sk-で始まる必要があります）', 'error');
                return;
            }
            
            OPENAI_API_KEY = apiKey;
            apiKeyInput.value = '';
            showApiKeyStatus('APIキーが設定されました！ 写真を選択してください 🎉', 'success');
            
            uploadContainer.style.opacity = '1';
            uploadContainer.style.pointerEvents = 'auto';
        }

        function showApiKeyStatus(message, type) {
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
        }

        function checkApiKey() {
            if (!OPENAI_API_KEY) {
                showError('まず OpenAI APIキーを設定してください 🔑');
                return false;
            }
            return true;
        }

        // ファイルアップロード関連
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            console.log('Selected file:', file.name, file.type, file.size);

            // ファイル形式チェック
            if (!file.type.startsWith('image/')) {
                showError('画像ファイルを選択してください');
                return;
            }

            // ファイルサイズチェック (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('ファイルが大きすぎます（10MB以下にしてください）');
                return;
            }

            selectedFile = file;
            hideError();
            showPreview(file);
            showSuccess('写真が選択されました！ 🌟');
            generateButton.disabled = false;
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <img src="${e.target.result}" alt="選択した画像" class="image-preview">
                    <p style="color: #FF69B4; font-size: 1.1rem; margin-top: 10px;">
                        この写真で 忠実で超かわいい ぬりえを つくるよ！ 🎨
                    </p>
                `;
            };
            reader.readAsDataURL(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // ファイルをBase64に変換
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // プログレスバー更新
        function updateProgress(percent, message) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            statusText.textContent = message;
        }

        // メイン処理：ぬりえ生成（完全忠実版に置き換え）
        generateButton.addEventListener('click', generateColoring);

        // バランス調整版のgenerateColoring関数（忠実+デフォルメ+簡素化）

async function generateColoring() {
    console.log('=== バランス調整版 DALL-E 3 ===');
    
    if (!checkApiKey()) return;
    
    if (!selectedFile) {
        showError('まず 写真を選択してください！');
        return;
    }

    // ローディング表示
    loadingContainer.style.display = 'block';
    generateButton.disabled = true;
    resultContainer.style.display = 'none';
    hideError();
    progressContainer.style.display = 'block';
    updateProgress(0, 'しゃしんを あっぷろーどしています...');

    try {
        // 画像をBase64に変換
        updateProgress(10, 'しゃしんを じゅんびしています...');
        const imageData = await fileToBase64(selectedFile);
        
        // === STAGE 1: 構図中心の分析 ===
        updateProgress(25, 'AI が 構図を かいせきしています（段階1/3）...');
        console.log('STAGE 1: Composition-focused analysis...');
        
        const compositionResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: `この画像をぬりえ用に分析してください。詳細すぎるリアルな描写ではなく、6歳児向けの基本要素に注目してください：

【基本構成（シンプル重視）】
- 被写体：何？（人/動物/物体）性別・年齢・基本ポーズ
- 位置：どこにいる？（中央/左/右、座る/立つの基本動作）
- 背景：主要な要素のみ（窓/ドア/家具等の大きな要素）
- サイズ感：画面での大きさ（大/中/小）

【6歳児向け簡素化ポイント】
- 複雑な毛並みや模様は「シンプルな色分け」として記録
- 細かいディテールは「基本形状」として記録
- 背景は「大きな要素」のみ抽出

【デフォルメ化方針】
- 可愛らしくできる要素（目・表情・体型）を特定
- kawaii化可能な部分を記録

正確性は保ちつつも、6歳児が塗りやすい「基本要素」中心で分析してください。`
                            },
                            {
                                type: "image_url",
                                image_url: {
                                    url: imageData
                                }
                            }
                        ]
                    }
                ],
                max_tokens: 300
            }),
        });

        let basicAnalysis = "a cute subject";
        if (compositionResponse.ok) {
            const compositionResult = await compositionResponse.json();
            if (compositionResult.choices && compositionResult.choices[0]) {
                basicAnalysis = compositionResult.choices[0].message.content.trim();
                console.log('STAGE 1 - Basic analysis:', basicAnalysis);
            }
        }

        // === STAGE 2: バランス設計 ===
        updateProgress(45, 'AI が バランスを 設計しています（段階2/3）...');
        console.log('STAGE 2: Balance design...');
        
        const balanceResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: `以下の分析から、「忠実+デフォルメ+簡素化」のバランスを取ったDALL-E 3プロンプトを設計してください：

【分析結果】
${basicAnalysis}

【バランス設計方針】
🎯 忠実性（保持する要素）：
- 基本構図・被写体の位置・サイズ感
- 主要な背景要素（窓・家具等）
- 被写体の基本ポーズ・向き
- 性別・年齢・人数

🎨 デフォルメ化（可愛く調整）：
- 目を大きく丸く（kawaii化）
- 体型をやや丸く・ふんわり
- 表情を優しく・笑顔に
- 全体的にchibi風味

📏 簡素化（6歳児向け）：
- 毛並み・模様は大きな色分け区域に
- 細かいディテールは太い線の基本形状に
- 背景は主要要素のみのシンプル構成
- 線数を最小限に（太い線で区切り）

【出力形式】
"A coloring book page showing [忠実な基本構図] with [kawaii要素] simplified for ages 3-6"

【禁止事項】
- 性別・人数・基本ポーズの変更
- 主要背景要素の削除
- 過度にリアルな線画
- 6歳児に複雑すぎる線

バランスの取れた設計を作成してください。`
                            }
                        ]
                    }
                ],
                max_tokens: 200
            }),
        });

        let balancedDescription = basicAnalysis;
        if (balanceResponse.ok) {
            const balanceResult = await balanceResponse.json();
            if (balanceResult.choices && balanceResult.choices[0]) {
                balancedDescription = balanceResult.choices[0].message.content.trim();
                console.log('STAGE 2 - Balanced description:', balancedDescription);
            }
        }

        // === STAGE 3: 最終調整 ===
        updateProgress(60, 'AI が 最終調整を しています（段階3/3）...');
        console.log('STAGE 3: Final adjustment...');
        
        const adjustmentResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: `以下のプロンプトが「忠実すぎてリアル」「簡素すぎて可愛くない」「複雑すぎて6歳児に不適切」のいずれかになっていないか調整してください：

【現在のプロンプト】
${balancedDescription}

【調整基準】
✅ 適切なバランス：
- 元写真の基本構図は保持
- kawaii要素で可愛さアップ
- 6歳児が塗りやすい太い線・大きな区域

❌ 避けるべき状態：
- リアルすぎる毛並み・模様の描写
- 細かすぎる線・小さすぎる塗り区域
- 可愛さのないただの線画
- 元写真と全く違う構図

【調整指示】
問題がある場合は修正版を出力
適切な場合は「調整完了：バランス良好」

目標：6歳児が喜んで塗れる、可愛くて忠実なぬりえ`
                            }
                        ]
                    }
                ],
                max_tokens: 250
            }),
        });

        let finalDescription = balancedDescription;
        if (adjustmentResponse.ok) {
            const adjustmentResult = await adjustmentResponse.json();
            if (adjustmentResult.choices && adjustmentResult.choices[0]) {
                const adjustmentOutput = adjustmentResult.choices[0].message.content.trim();
                console.log('STAGE 3 - Adjustment result:', adjustmentOutput);
                
                if (!adjustmentOutput.includes('調整完了：バランス良好')) {
                    finalDescription = adjustmentOutput;
                    console.log('STAGE 3 - Applied balance adjustment');
                }
            }
        }

        updateProgress(75, 'かわいくて ぬりやすい ぬりえを つくっています... ✨');

        // === 最終プロンプト構築（バランス重視） ===
        let finalPrompt = `${finalDescription}

BALANCED COLORING BOOK REQUIREMENTS:

🎯 FAITHFULNESS (Preserve Core Elements):
- Basic composition and subject positioning from original
- Main background elements (windows, furniture, etc.)
- Subject's basic pose and orientation
- Number of people/animals and their genders

🎨 KAWAII DEFORMATION (Make it Cute for Kids):
- Enlarge eyes to be big and round (kawaii style)
- Make body proportions slightly rounder and softer
- Add gentle, friendly facial expressions
- Slight chibi-style proportions (bigger head ratio)
- Make everything look fluffy and huggable

📏 SIMPLIFICATION (Perfect for Ages 3-6):
- Convert complex fur patterns to simple color zones (2-3 large areas max)
- Use thick outlines (6-7px) with minimal internal lines
- Background elements as simple geometric shapes
- Large coloring areas - avoid tiny details or thin lines
- Maximum 5-6 main coloring sections per subject

STYLE BALANCE:
🖤 Pure black outlines on pure white background
👶 Chunky crayon-friendly thick lines
😊 Kawaii cute expressions while keeping original mood
📐 Simple geometric shapes replacing complex details
🏠 Background simplified to essential large elements only

FORBIDDEN (Maintain Balance):
- Overly realistic fur/hair textures (too complex for kids)
- Tiny intricate details or thin lines (too hard to color)
- Changing basic composition or subject identity
- Making it so simple it loses cuteness
- Adding colors or shading

GOAL: Create a coloring page that makes parents say "That's our photo made cute and simple!" while making kids say "I want to color this adorable picture!"

The result should be recognizably faithful to the original but transformed into an irresistibly cute, easy-to-color masterpiece perfect for young children.`;

        console.log('Generating balanced faithful coloring page...');

        // === DALL-E 3 生成 ===
        const dalle3Response = await fetch('https://api.openai.com/v1/images/generations', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: "dall-e-3",
                prompt: finalPrompt,
                n: 1,
                size: "1024x1024",
                quality: "standard"
            }),
        });

        if (!dalle3Response.ok) {
            const errorData = await dalle3Response.json();
            throw new Error(`API Error: ${dalle3Response.status} - ${errorData.error?.message}`);
        }

        const dalle3Result = await dalle3Response.json();

        if (dalle3Result.data && dalle3Result.data.length > 0) {
            updateProgress(100, 'かわいくて ぬりやすい ぬりえが できました！');
            generatedImageUrl = dalle3Result.data[0].url;
            showResult(dalle3Result.data[0].url, 'DALL-E-3-Balanced', '🎯 忠実で可愛くて塗りやすい ぬりえです！');
        } else {
            throw new Error('No image generated');
        }

    } catch (error) {
        console.error('Balanced version error:', error);
        
        let errorMessage = error.message;
        if (error.message.includes('401')) {
            errorMessage = 'OpenAI APIキーが正しく設定されていません 🔑';
        } else if (error.message.includes('429')) {
            errorMessage = 'API使用量の上限に達しました ⏰';
        } else if (error.message.includes('network')) {
            errorMessage = 'ネットワーク接続に問題があります 🌐';
        }
        
        showError(`エラーが発生しました 😢\n\n${errorMessage}\n\nもういちど ためしてね！`);
    } finally {
        loadingContainer.style.display = 'none';
        generateButton.disabled = false;
        progressContainer.style.display = 'none';
    }
}

        function showResult(imageUrl, model, message) {
            document.getElementById('resultImage').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #FF69B4; font-size: 1.3rem; margin-bottom: 15px;">🎉 超かわいい ぬりえが できたよ！</p>
                    <p style="color: #FF69B4; font-size: 1rem; margin-bottom: 10px;">${message}</p>
                    <img src="${imageUrl}" alt="生成されたぬりえ" style="max-width: 100%; max-height: 500px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 3px solid #FFB6C1;">
                    <p style="color: #8B4513; font-size: 1rem; margin-top: 10px;">
                        写真から作った オリジナル ぬりえだよ！ 🌈<br>
                        <small>(${model}で せいせい)</small>
                    </p>
                </div>
            `;
            
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function printColoring() {
            if (!generatedImageUrl) {
                showError('プリントする がぞうが ありません');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>せかいぬりえ - プリント</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                text-align: center; 
                                font-family: 'Comic Sans MS', Arial, sans-serif;
                            }
                            img {
                                max-height: 90vh;
                                border: 2px solid #000;
                            }
                            h1 {
                                color: #FF69B4;
                                font-size: 2rem;
                                margin-bottom: 20px;
                            }
                            @media print {
                                body { margin: 10px; }
                                h1 { font-size: 1.5rem; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>🌈 せかいぬりえ 🎨</h1>
                        <img src="${generatedImageUrl}" alt="ぬりえ">
                        <p style="margin-top: 20px; color: #8B4513;">たのしく ぬってね！</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            
            // 画像読み込み完了後にプリント
            const img = printWindow.document.querySelector('img');
            img.onload = () => {
                setTimeout(() => printWindow.print(), 500);
            };
        }

        function downloadColoring() {
            if (!generatedImageUrl) {
                showError('ダウンロードする がぞうが ありません');
                return;
            }

            // 画像をダウンロード
            const link = document.createElement('a');
            link.href = generatedImageUrl;
            link.download = `せかいぬりえ_${new Date().getTime()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('ぬりえを ダウンロードしました！ 📥');
        }

        function resetApp() {
            selectedFile = null;
            generatedImageUrl = null;
            fileInput.value = '';
            previewContainer.innerHTML = '';
            resultContainer.style.display = 'none';
            loadingContainer.style.display = 'none';
            generateButton.disabled = true;
            hideError();
            
            // トップにスクロール
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 初期化
        console.log('Fixed simple version initialized');
    </script>
</body>
</html>