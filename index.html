<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>せかいぬりえ - 修正版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFE4E1 50%, #FFF8DC 100%);
            min-height: 100vh;
            color: #8B4513;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            color: #FF69B4;
            text-shadow: 3px 3px 0px #FFB6C1;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #FF1493;
            margin-bottom: 20px;
        }

        .step-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);
            border: 4px solid #FFB6C1;
        }

        .step-title {
            font-size: 1.5rem;
            color: #FF69B4;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-area {
            border: 4px dashed #FFB6C1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #FFF8DC;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #FF69B4;
            background: #FFE4E1;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #FF1493;
            background: #FFB6C1;
        }

        .upload-icon {
            font-size: 4rem;
            color: #FF69B4;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.2rem;
            color: #8B4513;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .button {
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.6);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #FFB6C1;
            border-top: 5px solid #FF69B4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 100%;
            background-color: #FFE4E1;
            border-radius: 25px;
            padding: 3px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            border-radius: 25px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .result-container {
            display: none;
            text-align: center;
        }

        .print-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            margin-top: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #4169E1, #87CEEB);
            margin-top: 10px;
            margin-left: 10px;
        }

        .error-message {
            background: #FFE4E6;
            color: #D8000C;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #FFB6C1;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #E6FFE6;
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #90EE90;
            margin: 10px 0;
            display: none;
        }

        .instructions {
            background: #E6F3FF;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid #87CEEB;
        }

        .instructions h3 {
            color: #4682B4;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ol {
            color: #2F4F4F;
            font-size: 1.1rem;
            line-height: 1.6;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .status-text {
            font-size: 1.1rem;
            color: #FF69B4;
            margin-top: 10px;
        }

        /* APIキー設定用スタイル */
        .api-key-input {
            width: 70%;
            padding: 12px;
            border: 3px solid #FFB6C1;
            border-radius: 10px;
            font-size: 1rem;
            margin-right: 10px;
            font-family: monospace;
        }

        .api-key-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
        }

        .api-status {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: bold;
        }

        .api-status.success {
            background: #E6FFE6;
            color: #006400;
            border: 2px solid #90EE90;
        }

        .api-status.error {
            background: #FFE4E6;
            color: #D8000C;
            border: 2px solid #FFB6C1;
        }

        .api-help {
            margin-top: 15px;
        }

        .api-help summary {
            color: #FF69B4;
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }

        .api-help-content {
            margin-top: 10px;
            padding: 15px;
            background: #F0F8FF;
            border-radius: 10px;
            border: 2px solid #87CEEB;
        }

        @media (max-width: 600px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .step-container {
                padding: 20px;
            }

            .download-button {
                margin-left: 0;
                margin-top: 10px;
            }

            .api-key-input {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">🌈 せかいぬりえ 🎨</h1>
            <p class="subtitle">写真に忠実で かわいい ぬりえを つくろう！</p>
        </div>

        <div class="instructions">
            <h3>🎯 つかいかた</h3>
            <ol>
                <li>OpenAI APIキーを設定してね</li>
                <li>すきな写真を えらんでね</li>
                <li>「ぬりえにする」ボタンを おしてね</li>
                <li>ちょっと まっててね（30秒くらい）</li>
                <li>できあがったら プリントして ぬりえを たのしもう！</li>
            </ol>
        </div>

        <!-- APIキー設定セクション -->
        <div class="step-container" id="apiKeyContainer">
            <h2 class="step-title">🔑 OpenAI APIキー設定</h2>
            <p style="color: #8B4513; margin-bottom: 15px; line-height: 1.6;">
                より高品質で写真に忠実な線画を生成するために、OpenAI APIキーを設定してください。<br>
                <small style="color: #666;">※ APIキーはブラウザにのみ保存され、外部に送信されません</small>
            </p>
            
            <div style="margin-bottom: 20px;">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-proj-...">
                <button onclick="setApiKey()" class="api-key-button">🔧 設定</button>
            </div>
            
            <div id="apiKeyStatus" class="api-status"></div>
            
            <details class="api-help">
                <summary>📖 APIキーの取得方法</summary>
                <div class="api-help-content">
                    <ol style="color: #2F4F4F; line-height: 1.8;">
                        <li><a href="https://platform.openai.com/" target="_blank" style="color: #FF69B4; text-decoration: none; font-weight: bold;">OpenAI Platform</a> にアクセス</li>
                        <li>アカウントを作成・ログイン</li>
                        <li>左メニューの「API Keys」をクリック</li>
                        <li>「Create new secret key」をクリック</li>
                        <li>生成されたキー（sk-proj-で始まる）をコピー</li>
                        <li>上記の入力欄に貼り付けて「設定」をクリック</li>
                    </ol>
                    <p style="color: #D2691E; font-size: 0.9rem; margin-top: 15px; padding: 10px; background: #FFF8DC; border-radius: 5px;">
                        ⚠️ <strong>重要:</strong> APIキーは大切に管理してください。他人と共有しないでください。<br>
                        💰 DALL-E 3の利用料金: 1回あたり約3-8円程度
                    </p>
                </div>
            </details>
        </div>

        <!-- 画像アップロードセクション -->
        <div class="step-container" id="uploadContainer" style="opacity: 0.5; pointer-events: none;">
            <h2 class="step-title">📸 写真を えらんでね</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📱</div>
                <div class="upload-text">ここを タップして 写真を えらんでね</div>
                <div style="font-size: 0.9rem; color: #666;">JPEG、PNG、HEIC対応</div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div id="previewContainer" style="text-align: center; margin-top: 20px;">
                <!-- プレビュー画像がここに表示される -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button" id="generateButton" disabled>
                    🎨 忠実で かわいい ぬりえにする！
                </button>
            </div>
        </div>

        <!-- ローディング表示 -->
        <div class="loading" id="loadingContainer">
            <div class="spinner"></div>
            <p style="font-size: 1.2rem; color: #FF69B4; margin-bottom: 10px;">AI が 写真に忠実な ぬりえを つくっているよ... ✨</p>
            <div class="status-text" id="statusText">しゃしんを かいせきしています...</div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <!-- 結果表示 -->
        <div class="step-container result-container" id="resultContainer">
            <h2 class="step-title">🎉 できあがり！</h2>
            <div id="resultImage">
                <!-- 生成されたぬりえがここに表示される -->
            </div>
            <div>
                <button class="button print-button" onclick="printColoring()">
                    🖨️ プリントする
                </button>
                <button class="button download-button" onclick="downloadColoring()">
                    💾 ダウンロード
                </button>
            </div>
            <button class="button" onclick="resetApp()" style="margin-top: 20px; background: linear-gradient(45deg, #FFA500, #FFD700);">
                🔄 あたらしく つくる
            </button>
        </div>
    </div>

    <script>
        // グローバル変数
        let selectedFile = null;
        let generatedImageUrl = null;
        let OPENAI_API_KEY = '';

        // DOM要素の取得
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const generateButton = document.getElementById('generateButton');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultContainer = document.getElementById('resultContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statusText = document.getElementById('statusText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const uploadContainer = document.getElementById('uploadContainer');

        // APIキー管理
        function setApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (!apiKey) {
                showApiKeyStatus('APIキーを入力してください', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showApiKeyStatus('正しいAPIキー形式ではありません（sk-で始まる必要があります）', 'error');
                return;
            }
            
            OPENAI_API_KEY = apiKey;
            apiKeyInput.value = '';
            showApiKeyStatus('APIキーが設定されました！ 写真を選択してください 🎉', 'success');
            
            uploadContainer.style.opacity = '1';
            uploadContainer.style.pointerEvents = 'auto';
        }

        function showApiKeyStatus(message, type) {
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
        }

        function checkApiKey() {
            if (!OPENAI_API_KEY) {
                showError('まず OpenAI APIキーを設定してください 🔑');
                return false;
            }
            return true;
        }

        // ファイルアップロード関連
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            console.log('Selected file:', file.name, file.type, file.size);

            // ファイル形式チェック
            if (!file.type.startsWith('image/')) {
                showError('画像ファイルを選択してください');
                return;
            }

            // ファイルサイズチェック (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('ファイルが大きすぎます（10MB以下にしてください）');
                return;
            }

            selectedFile = file;
            hideError();
            showPreview(file);
            showSuccess('写真が選択されました！ 🌟');
            generateButton.disabled = false;
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <img src="${e.target.result}" alt="選択した画像" class="image-preview">
                    <p style="color: #FF69B4; font-size: 1.1rem; margin-top: 10px;">
                        この写真で 忠実で超かわいい ぬりえを つくるよ！ 🎨
                    </p>
                `;
            };
            reader.readAsDataURL(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // ファイルをBase64に変換
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // プログレスバー更新
        function updateProgress(percent, message) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            statusText.textContent = message;
        }

        // メイン処理：ぬりえ生成（完全忠実版に置き換え）
        generateButton.addEventListener('click', generateColoring);

        async function generateColoring() {
            console.log('=== 完全忠実版 DALL-E 3 (3段階解析) ===');
            
            if (!checkApiKey()) return;
            
            if (!selectedFile) {
                showError('まず 写真を選択してください！');
                return;
            }

            // ローディング表示
            loadingContainer.style.display = 'block';
            generateButton.disabled = true;
            resultContainer.style.display = 'none';
            hideError();
            progressContainer.style.display = 'block';
            updateProgress(0, 'しゃしんを あっぷろーどしています...');

            try {
                // 画像をBase64に変換
                updateProgress(10, 'しゃしんを じゅんびしています...');
                const imageData = await fileToBase64(selectedFile);
                
                // === STAGE 1: 詳細構成分析 ===
                updateProgress(25, 'AI が しゃしんを 詳しく かいせきしています（段階1/3）...');
                console.log('STAGE 1: Detailed composition analysis...');
                
                const compositionResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `この画像を忠実性重視で詳細に分析してください：

【被写体の詳細】
- 人物：何人？各人の性別（男性/女性）・年齢層（子ども/大人/高齢者）・服装・髪型・表情は？
- 動物：何匹？種類・色・模様・ポーズ・表情・向きは？
- 物体：何個？種類・形・サイズ・配置・状態は？

【構図・ポーズ・サイズの詳細】
- 各人物・動物のポーズ：座る/立つ/寝る/歩く等
- 向き：正面/横向き/後ろ向き/斜め向き
- 視線方向：カメラ目線/横を見る/上を見る等
- 体の見えている範囲：全身/上半身/頭部のみ/手のみ等
- 被写体のサイズ：画面に占める割合（大きい/中ぐらい/小さい）
- 被写体の位置：中央/左/右/上/下

【環境・背景の詳細】
- 場所：室内/屋外/具体的な場所
- 背景要素：家具/建物/自然/窓/ドア等
- 背景との位置関係

【重要な特徴】
- 特に目立つ要素や特徴的な部分
- 構図の特徴（クローズアップ/全身/遠景等）

【忠実性チェックポイント】
- 絶対に変更してはいけない要素を特定

正確性を最重視し、推測を避けて見えるものだけを客観的に記述してください。構図とサイズ感も重要です。`
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: imageData
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 400
                    }),
                });

                let detailedAnalysis = "a subject";
                if (compositionResponse.ok) {
                    const compositionResult = await compositionResponse.json();
                    if (compositionResult.choices && compositionResult.choices[0]) {
                        detailedAnalysis = compositionResult.choices[0].message.content.trim();
                        console.log('STAGE 1 - Detailed analysis:', detailedAnalysis);
                    }
                } else {
                    console.warn('Stage 1 failed, continuing...');
                }

                // === STAGE 2: 忠実性最適化プロンプト生成 ===
                updateProgress(40, 'AI が ぬりえ用 設計を 最適化しています（段階2/3）...');
                console.log('STAGE 2: Faithfulness optimization...');
                
                const optimizationResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `以下の詳細分析結果から、構図・サイズ・配置まで忠実なDALL-E 3用プロンプトを設計してください：

【分析結果】
${detailedAnalysis}

【忠実性保証要件】
1. 人物の性別・年齢・人数を絶対に変更しない
2. 物体の種類・数量を絶対に変更しない  
3. ポーズ・向き・姿勢を絶対に変更しない
4. 体の見えている範囲を絶対に変更しない
5. 被写体のサイズ感・画面占有率を保持
6. 被写体の位置・配置を保持
7. 背景要素の基本構成を保持
8. 勝手な要素追加を絶対に禁止

【出力形式】
"A coloring book page showing [具体的で忠実な描写、構図・サイズ・配置を含む]"

【特別注意事項】
- 男性→女性、女性→男性の性別変更は絶対禁止
- きゅうり→なす等の物体変更は絶対禁止
- 野菜等に勝手に目や表情をつけることは絶対禁止
- 手のみの写真で勝手に全身を追加することは絶対禁止
- 人数や動物の数を勝手に変更することは絶対禁止
- 被写体のサイズ感や位置を勝手に変更することは絶対禁止

元画像の構図・サイズ・配置に最大限忠実でありながら、子ども向けぬりえに適した記述を作成してください。`
                                    }
                                ]
                            }
                        ],
                        max_tokens: 200
                    }),
                });

                let optimizedDescription = detailedAnalysis;
                if (optimizationResponse.ok) {
                    const optimizationResult = await optimizationResponse.json();
                    if (optimizationResult.choices && optimizationResult.choices[0]) {
                        optimizedDescription = optimizationResult.choices[0].message.content.trim();
                        console.log('STAGE 2 - Optimized description:', optimizedDescription);
                    }
                } else {
                    console.warn('Stage 2 failed, using Stage 1 result...');
                }

                // === STAGE 3: 最終検証とプロンプト完成 ===
                updateProgress(55, 'AI が 最終検証を しています（段階3/3）...');
                console.log('STAGE 3: Final verification...');
                
                const verificationResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `以下のプロンプトに忠実性の問題がないか最終検証し、必要に応じて修正してください：

【現在のプロンプト】
${optimizedDescription}

【検証項目】
1. 性別の記述は正確か？（男性↔女性の混同なし）
2. 人数・物体数の記述は正確か？
3. ポーズ・向きの記述は具体的か？
4. 余計な装飾（目や表情）の追加指示がないか？
5. 体の見えている範囲は正確か？
6. 被写体のサイズ感・位置は保持されているか？
7. 構図の特徴は保持されているか？

【問題があった場合の修正指示】
- 曖昧な表現を具体的にする
- 禁止事項を明確に追加する
- 数量や性別を数字や明確な語で指定する
- サイズ感や配置を明確に指定する

【出力】
修正が必要な場合：修正版プロンプト
修正不要な場合：「検証完了：問題なし」

目標：元画像の構図・サイズ・配置まで100%忠実なぬりえページの生成`
                                    }
                                ]
                            }
                        ],
                        max_tokens: 250
                    }),
                });

                let finalDescription = optimizedDescription;
                if (verificationResponse.ok) {
                    const verificationResult = await verificationResponse.json();
                    if (verificationResult.choices && verificationResult.choices[0]) {
                        const verificationOutput = verificationResult.choices[0].message.content.trim();
                        console.log('STAGE 3 - Verification result:', verificationOutput);
                        
                        if (!verificationOutput.includes('検証完了：問題なし')) {
                            finalDescription = verificationOutput;
                            console.log('STAGE 3 - Applied corrections');
                        }
                    }
                } else {
                    console.warn('Stage 3 failed, using Stage 2 result...');
                }

                // === 特別ケース対策 ===
                const analysis = detailedAnalysis.toLowerCase();
                let specialCasePrompt = null;

                // パパと娘ケース
                if ((analysis.includes('男性') && analysis.includes('女の子')) || 
                    (analysis.includes('father') && analysis.includes('daughter')) ||
                    (analysis.includes('パパ') && analysis.includes('娘'))) {
                    specialCasePrompt = `CRITICAL: This must show exactly one adult man and one young girl child. Do not change the man to a woman. Do not change the girl to a boy. Keep exactly these two people with their correct genders and the same size relationship.`;
                }
                
                // 野菜複数本ケース
                else if (analysis.includes('きゅうり') && (analysis.includes('本') || analysis.includes('個'))) {
                    const countMatch = analysis.match(/(\d+)本|(\d+)個/);
                    const number = countMatch ? (countMatch[1] || countMatch[2]) : 'multiple';
                    specialCasePrompt = `CRITICAL: Show exactly ${number} cucumber vegetables only. Do not change cucumbers to other vegetables. Do not add faces or eyes to the vegetables. Keep them as simple vegetable shapes with the same size and arrangement.`;
                }
                
                // 手のみケース
                else if ((analysis.includes('手') && (analysis.includes('のみ') || analysis.includes('だけ'))) ||
                         (analysis.includes('hand') && !analysis.includes('full body'))) {
                    specialCasePrompt = `CRITICAL: Show only the hand part visible in the original image. Do not add full body or person. Keep it as just a hand drawing with the same size and position.`;
                }

                updateProgress(70, 'かわいくて超忠実な ぬりえを つくっています... ✨');

                // === 最終プロンプト構築 ===
                let finalPrompt = `${finalDescription}

CRITICAL FAITHFULNESS REQUIREMENTS:
🎯 PRESERVE EXACTLY AS ANALYZED:
- Number and gender of people (NEVER change male to female or vice versa)
- Number and type of objects (NEVER change cucumber to eggplant, etc.)
- Exact poses and orientations described in analysis
- Body parts visible (full body, upper body, hands only, etc.)
- Subject size and position in frame (large/medium/small, center/left/right)
- Basic composition and layout from original image
- Background elements and their relationship to subjects

🚫 ABSOLUTELY FORBIDDEN:
- Changing genders (男性→女性, 女性→男性)
- Changing object types (きゅうり→なす, cat→dog, etc.)
- Adding extra objects or characters not in original
- Adding facial features to inanimate objects (no eyes on vegetables/food)
- Changing poses, orientations, or viewing angles
- Changing subject size or position in composition
- Adding colors, patterns, or shading (pure black and white only)
- Changing the number of subjects (people, animals, objects)
- Altering the basic composition or framing

✅ MINIMAL ALLOWED MODIFICATIONS:
- Simplify complex details into basic geometric shapes
- Make facial expressions slightly gentler (but keep same direction/mood)
- Round very sharp edges for safety
- Thicken outlines to 5-6px for easy coloring
- Simplify clothing patterns (but keep basic style and type)

COMPOSITION REQUIREMENTS:
📐 Maintain exact framing and composition of original
📏 Preserve subject size relative to frame
📍 Keep subject positioning (center/left/right/top/bottom)
🏠 Maintain basic background elements and spatial relationships

STYLE REQUIREMENTS:
🖤 Pure black outlines (5-6px thick) on pure white background
👶 Simple enough for ages 3-6 to color with chunky crayons
📖 Classic coloring book page style
😊 Gentle, child-friendly expressions (maintain original mood)
🎨 Minimal kawaii touches that don't alter core subject identity

${specialCasePrompt ? '\n' + specialCasePrompt : ''}

GOAL: Create a version so faithful that parents immediately recognize it as "their exact photo turned into a coloring page" with the same composition, size, and layout rather than "a different cute drawing inspired by their photo."`;

                console.log('Generating ultra-faithful coloring page with composition preservation...');
                console.log('Final prompt length:', finalPrompt.length);

                // === DALL-E 3 生成 ===
                const dalle3Response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "dall-e-3",
                        prompt: finalPrompt,
                        n: 1,
                        size: "1024x1024",
                        quality: "standard"
                    }),
                });

                if (!dalle3Response.ok) {
                    const errorData = await dalle3Response.json();
                    throw new Error(`API Error: ${dalle3Response.status} - ${errorData.error?.message}`);
                }

                const dalle3Result = await dalle3Response.json();

                if (dalle3Result.data && dalle3Result.data.length > 0) {
                    updateProgress(100, '超忠実で かわいい ぬりえが できました！');
                    generatedImageUrl = dalle3Result.data[0].url;
                    showResult(dalle3Result.data[0].url, 'DALL-E-3-Ultra-Faithful', '🎯 元の写真に超忠実な ぬりえです（構図・サイズも保持）！');
                } else {
                    throw new Error('No image generated');
                }

            } catch (error) {
                console.error('Complete faithful version error:', error);
                
                let errorMessage = error.message;
                if (error.message.includes('401')) {
                    errorMessage = 'OpenAI APIキーが正しく設定されていません 🔑';
                } else if (error.message.includes('429')) {
                    errorMessage = 'API使用量の上限に達しました ⏰';
                } else if (error.message.includes('network')) {
                    errorMessage = 'ネットワーク接続に問題があります 🌐';
                }
                
                showError(`エラーが発生しました 😢\n\n${errorMessage}\n\nもういちど ためしてね！`);
            } finally {
                loadingContainer.style.display = 'none';
                generateButton.disabled = false;
                progressContainer.style.display = 'none';
            }
        }

        function showResult(imageUrl, model, message) {
            document.getElementById('resultImage').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #FF69B4; font-size: 1.3rem; margin-bottom: 15px;">🎉 超かわいい ぬりえが できたよ！</p>
                    <p style="color: #FF69B4; font-size: 1rem; margin-bottom: 10px;">${message}</p>
                    <img src="${imageUrl}" alt="生成されたぬりえ" style="max-width: 100%; max-height: 500px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 3px solid #FFB6C1;">
                    <p style="color: #8B4513; font-size: 1rem; margin-top: 10px;">
                        写真から作った オリジナル ぬりえだよ！ 🌈<br>
                        <small>(${model}で せいせい)</small>
                    </p>
                </div>
            `;
            
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function printColoring() {
            if (!generatedImageUrl) {
                showError('プリントする がぞうが ありません');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>せかいぬりえ - プリント</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                text-align: center; 
                                font-family: 'Comic Sans MS', Arial, sans-serif;
                            }
                            img {
                                max-height: 90vh;
                                border: 2px solid #000;
                            }
                            h1 {
                                color: #FF69B4;
                                font-size: 2rem;
                                margin-bottom: 20px;
                            }
                            @media print {
                                body { margin: 10px; }
                                h1 { font-size: 1.5rem; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>🌈 せかいぬりえ 🎨</h1>
                        <img src="${generatedImageUrl}" alt="ぬりえ">
                        <p style="margin-top: 20px; color: #8B4513;">たのしく ぬってね！</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            
            // 画像読み込み完了後にプリント
            const img = printWindow.document.querySelector('img');
            img.onload = () => {
                setTimeout(() => printWindow.print(), 500);
            };
        }

        function downloadColoring() {
            if (!generatedImageUrl) {
                showError('ダウンロードする がぞうが ありません');
                return;
            }

            // 画像をダウンロード
            const link = document.createElement('a');
            link.href = generatedImageUrl;
            link.download = `せかいぬりえ_${new Date().getTime()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('ぬりえを ダウンロードしました！ 📥');
        }

        function resetApp() {
            selectedFile = null;
            generatedImageUrl = null;
            fileInput.value = '';
            previewContainer.innerHTML = '';
            resultContainer.style.display = 'none';
            loadingContainer.style.display = 'none';
            generateButton.disabled = true;
            hideError();
            
            // トップにスクロール
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 初期化
        console.log('Fixed simple version initialized');
    </script>
</body>
</html>