<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã›ã‹ã„ã¬ã‚Šãˆ - ä¿®æ­£ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFE4E1 50%, #FFF8DC 100%);
            min-height: 100vh;
            color: #8B4513;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            color: #FF69B4;
            text-shadow: 3px 3px 0px #FFB6C1;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #FF1493;
            margin-bottom: 20px;
        }

        .step-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);
            border: 4px solid #FFB6C1;
        }

        .step-title {
            font-size: 1.5rem;
            color: #FF69B4;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-area {
            border: 4px dashed #FFB6C1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #FFF8DC;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #FF69B4;
            background: #FFE4E1;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #FF1493;
            background: #FFB6C1;
        }

        .upload-icon {
            font-size: 4rem;
            color: #FF69B4;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.2rem;
            color: #8B4513;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .button {
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.6);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #FFB6C1;
            border-top: 5px solid #FF69B4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 100%;
            background-color: #FFE4E1;
            border-radius: 25px;
            padding: 3px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            border-radius: 25px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .result-container {
            display: none;
            text-align: center;
        }

        .print-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            margin-top: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #4169E1, #87CEEB);
            margin-top: 10px;
            margin-left: 10px;
        }

        .error-message {
            background: #FFE4E6;
            color: #D8000C;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #FFB6C1;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #E6FFE6;
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #90EE90;
            margin: 10px 0;
            display: none;
        }

        .instructions {
            background: #E6F3FF;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid #87CEEB;
        }

        .instructions h3 {
            color: #4682B4;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ol {
            color: #2F4F4F;
            font-size: 1.1rem;
            line-height: 1.6;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .status-text {
            font-size: 1.1rem;
            color: #FF69B4;
            margin-top: 10px;
        }

        /* APIã‚­ãƒ¼è¨­å®šç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .api-key-input {
            width: 70%;
            padding: 12px;
            border: 3px solid #FFB6C1;
            border-radius: 10px;
            font-size: 1rem;
            margin-right: 10px;
            font-family: monospace;
        }

        .api-key-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
        }

        .api-status {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: bold;
        }

        .api-status.success {
            background: #E6FFE6;
            color: #006400;
            border: 2px solid #90EE90;
        }

        .api-status.error {
            background: #FFE4E6;
            color: #D8000C;
            border: 2px solid #FFB6C1;
        }

        .api-help {
            margin-top: 15px;
        }

        .api-help summary {
            color: #FF69B4;
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }

        .api-help-content {
            margin-top: 10px;
            padding: 15px;
            background: #F0F8FF;
            border-radius: 10px;
            border: 2px solid #87CEEB;
        }

        @media (max-width: 600px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .step-container {
                padding: 20px;
            }

            .download-button {
                margin-left: 0;
                margin-top: 10px;
            }

            .api-key-input {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸŒˆ ã›ã‹ã„ã¬ã‚Šãˆ ğŸ¨</h1>
            <p class="subtitle">å†™çœŸã«å¿ å®Ÿã§ ã‹ã‚ã„ã„ ã¬ã‚Šãˆã‚’ ã¤ãã‚ã†ï¼</p>
        </div>

        <div class="instructions">
            <h3>ğŸ¯ ã¤ã‹ã„ã‹ãŸ</h3>
            <ol>
                <li>OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ã­</li>
                <li>ã™ããªå†™çœŸã‚’ ãˆã‚‰ã‚“ã§ã­</li>
                <li>ã€Œã¬ã‚Šãˆã«ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ ãŠã—ã¦ã­</li>
                <li>ã¡ã‚‡ã£ã¨ ã¾ã£ã¦ã¦ã­ï¼ˆ30ç§’ãã‚‰ã„ï¼‰</li>
                <li>ã§ãã‚ãŒã£ãŸã‚‰ ãƒ—ãƒªãƒ³ãƒˆã—ã¦ ã¬ã‚Šãˆã‚’ ãŸã®ã—ã‚‚ã†ï¼</li>
            </ol>
        </div>

        <!-- APIã‚­ãƒ¼è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="step-container" id="apiKeyContainer">
            <h2 class="step-title">ğŸ”‘ OpenAI APIã‚­ãƒ¼è¨­å®š</h2>
            <p style="color: #8B4513; margin-bottom: 15px; line-height: 1.6;">
                ã‚ˆã‚Šé«˜å“è³ªã§å†™çœŸã«å¿ å®Ÿãªç·šç”»ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ã€OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
                <small style="color: #666;">â€» APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“</small>
            </p>
            
            <div style="margin-bottom: 20px;">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-proj-...">
                <button onclick="setApiKey()" class="api-key-button">ğŸ”§ è¨­å®š</button>
            </div>
            
            <div id="apiKeyStatus" class="api-status"></div>
            
            <details class="api-help">
                <summary>ğŸ“– APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•</summary>
                <div class="api-help-content">
                    <ol style="color: #2F4F4F; line-height: 1.8;">
                        <li><a href="https://platform.openai.com/" target="_blank" style="color: #FF69B4; text-decoration: none; font-weight: bold;">OpenAI Platform</a> ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                        <li>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³</li>
                        <li>å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€ŒAPI Keysã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ã€ŒCreate new secret keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ï¼ˆsk-proj-ã§å§‹ã¾ã‚‹ï¼‰ã‚’ã‚³ãƒ”ãƒ¼</li>
                        <li>ä¸Šè¨˜ã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ã€Œè¨­å®šã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    </ol>
                    <p style="color: #D2691E; font-size: 0.9rem; margin-top: 15px; padding: 10px; background: #FFF8DC; border-radius: 5px;">
                        âš ï¸ <strong>é‡è¦:</strong> APIã‚­ãƒ¼ã¯å¤§åˆ‡ã«ç®¡ç†ã—ã¦ãã ã•ã„ã€‚ä»–äººã¨å…±æœ‰ã—ãªã„ã§ãã ã•ã„ã€‚<br>
                        ğŸ’° DALL-E 3ã®åˆ©ç”¨æ–™é‡‘: 1å›ã‚ãŸã‚Šç´„3-8å††ç¨‹åº¦
                    </p>
                </div>
            </details>
        </div>

        <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="step-container" id="uploadContainer" style="opacity: 0.5; pointer-events: none;">
            <h2 class="step-title">ğŸ“¸ å†™çœŸã‚’ ãˆã‚‰ã‚“ã§ã­</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“±</div>
                <div class="upload-text">ã“ã“ã‚’ ã‚¿ãƒƒãƒ—ã—ã¦ å†™çœŸã‚’ ãˆã‚‰ã‚“ã§ã­</div>
                <div style="font-size: 0.9rem; color: #666;">JPEGã€PNGã€HEICå¯¾å¿œ</div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div id="previewContainer" style="text-align: center; margin-top: 20px;">
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button" id="generateButton" disabled>
                    ğŸ¨ å¿ å®Ÿã§ ã‹ã‚ã„ã„ ã¬ã‚Šãˆã«ã™ã‚‹ï¼
                </button>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div class="loading" id="loadingContainer">
            <div class="spinner"></div>
            <p style="font-size: 1.2rem; color: #FF69B4; margin-bottom: 10px;">AI ãŒ å†™çœŸã«å¿ å®Ÿãª ã¬ã‚Šãˆã‚’ ã¤ãã£ã¦ã„ã‚‹ã‚ˆ... âœ¨</p>
            <div class="status-text" id="statusText">ã—ã‚ƒã—ã‚“ã‚’ ã‹ã„ã›ãã—ã¦ã„ã¾ã™...</div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div class="step-container result-container" id="resultContainer">
            <h2 class="step-title">ğŸ‰ ã§ãã‚ãŒã‚Šï¼</h2>
            <div id="resultImage">
                <!-- ç”Ÿæˆã•ã‚ŒãŸã¬ã‚ŠãˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
            <div>
                <button class="button print-button" onclick="printColoring()">
                    ğŸ–¨ï¸ ãƒ—ãƒªãƒ³ãƒˆã™ã‚‹
                </button>
                <button class="button download-button" onclick="downloadColoring()">
                    ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
            <button class="button" onclick="resetApp()" style="margin-top: 20px; background: linear-gradient(45deg, #FFA500, #FFD700);">
                ğŸ”„ ã‚ãŸã‚‰ã—ã ã¤ãã‚‹
            </button>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let selectedFile = null;
        let generatedImageUrl = null;
        let OPENAI_API_KEY = '';

        // DOMè¦ç´ ã®å–å¾—
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const generateButton = document.getElementById('generateButton');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultContainer = document.getElementById('resultContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statusText = document.getElementById('statusText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const uploadContainer = document.getElementById('uploadContainer');

        // APIã‚­ãƒ¼ç®¡ç†
        function setApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (!apiKey) {
                showApiKeyStatus('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showApiKeyStatus('æ­£ã—ã„APIã‚­ãƒ¼å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆsk-ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰', 'error');
                return;
            }
            
            OPENAI_API_KEY = apiKey;
            apiKeyInput.value = '';
            showApiKeyStatus('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸï¼ å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ ğŸ‰', 'success');
            
            uploadContainer.style.opacity = '1';
            uploadContainer.style.pointerEvents = 'auto';
        }

        function showApiKeyStatus(message, type) {
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
        }

        function checkApiKey() {
            if (!OPENAI_API_KEY) {
                showError('ã¾ãš OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ ğŸ”‘');
                return false;
            }
            return true;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            console.log('Selected file:', file.name, file.type, file.size);

            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (!file.type.startsWith('image/')) {
                showError('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰');
                return;
            }

            selectedFile = file;
            hideError();
            showPreview(file);
            showSuccess('å†™çœŸãŒé¸æŠã•ã‚Œã¾ã—ãŸï¼ ğŸŒŸ');
            generateButton.disabled = false;
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <img src="${e.target.result}" alt="é¸æŠã—ãŸç”»åƒ" class="image-preview">
                    <p style="color: #FF69B4; font-size: 1.1rem; margin-top: 10px;">
                        ã“ã®å†™çœŸã§ å¿ å®Ÿã§è¶…ã‹ã‚ã„ã„ ã¬ã‚Šãˆã‚’ ã¤ãã‚‹ã‚ˆï¼ ğŸ¨
                    </p>
                `;
            };
            reader.readAsDataURL(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        function updateProgress(percent, message) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            statusText.textContent = message;
        }

        // ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šã¬ã‚Šãˆç”Ÿæˆï¼ˆå®Œå…¨å¿ å®Ÿç‰ˆã«ç½®ãæ›ãˆï¼‰
        generateButton.addEventListener('click', generateColoring);

        async function generateColoring() {
            console.log('=== å®Œå…¨å¿ å®Ÿç‰ˆ DALL-E 3 (3æ®µéšè§£æ) ===');
            
            if (!checkApiKey()) return;
            
            if (!selectedFile) {
                showError('ã¾ãš å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ï¼');
                return;
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            loadingContainer.style.display = 'block';
            generateButton.disabled = true;
            resultContainer.style.display = 'none';
            hideError();
            progressContainer.style.display = 'block';
            updateProgress(0, 'ã—ã‚ƒã—ã‚“ã‚’ ã‚ã£ã·ã‚ãƒ¼ã©ã—ã¦ã„ã¾ã™...');

            try {
                // ç”»åƒã‚’Base64ã«å¤‰æ›
                updateProgress(10, 'ã—ã‚ƒã—ã‚“ã‚’ ã˜ã‚…ã‚“ã³ã—ã¦ã„ã¾ã™...');
                const imageData = await fileToBase64(selectedFile);
                
                // === STAGE 1: è©³ç´°æ§‹æˆåˆ†æ ===
                updateProgress(25, 'AI ãŒ ã—ã‚ƒã—ã‚“ã‚’ è©³ã—ã ã‹ã„ã›ãã—ã¦ã„ã¾ã™ï¼ˆæ®µéš1/3ï¼‰...');
                console.log('STAGE 1: Detailed composition analysis...');
                
                const compositionResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `ã“ã®ç”»åƒã‚’å¿ å®Ÿæ€§é‡è¦–ã§è©³ç´°ã«åˆ†æã—ã¦ãã ã•ã„ï¼š

ã€è¢«å†™ä½“ã®è©³ç´°ã€‘
- äººç‰©ï¼šä½•äººï¼Ÿå„äººã®æ€§åˆ¥ï¼ˆç”·æ€§/å¥³æ€§ï¼‰ãƒ»å¹´é½¢å±¤ï¼ˆå­ã©ã‚‚/å¤§äºº/é«˜é½¢è€…ï¼‰ãƒ»æœè£…ãƒ»é«ªå‹ãƒ»è¡¨æƒ…ã¯ï¼Ÿ
- å‹•ç‰©ï¼šä½•åŒ¹ï¼Ÿç¨®é¡ãƒ»è‰²ãƒ»æ¨¡æ§˜ãƒ»ãƒãƒ¼ã‚ºãƒ»è¡¨æƒ…ãƒ»å‘ãã¯ï¼Ÿ
- ç‰©ä½“ï¼šä½•å€‹ï¼Ÿç¨®é¡ãƒ»å½¢ãƒ»ã‚µã‚¤ã‚ºãƒ»é…ç½®ãƒ»çŠ¶æ…‹ã¯ï¼Ÿ

ã€æ§‹å›³ãƒ»ãƒãƒ¼ã‚ºãƒ»ã‚µã‚¤ã‚ºã®è©³ç´°ã€‘
- å„äººç‰©ãƒ»å‹•ç‰©ã®ãƒãƒ¼ã‚ºï¼šåº§ã‚‹/ç«‹ã¤/å¯ã‚‹/æ­©ãç­‰
- å‘ãï¼šæ­£é¢/æ¨ªå‘ã/å¾Œã‚å‘ã/æ–œã‚å‘ã
- è¦–ç·šæ–¹å‘ï¼šã‚«ãƒ¡ãƒ©ç›®ç·š/æ¨ªã‚’è¦‹ã‚‹/ä¸Šã‚’è¦‹ã‚‹ç­‰
- ä½“ã®è¦‹ãˆã¦ã„ã‚‹ç¯„å›²ï¼šå…¨èº«/ä¸ŠåŠèº«/é ­éƒ¨ã®ã¿/æ‰‹ã®ã¿ç­‰
- è¢«å†™ä½“ã®ã‚µã‚¤ã‚ºï¼šç”»é¢ã«å ã‚ã‚‹å‰²åˆï¼ˆå¤§ãã„/ä¸­ãã‚‰ã„/å°ã•ã„ï¼‰
- è¢«å†™ä½“ã®ä½ç½®ï¼šä¸­å¤®/å·¦/å³/ä¸Š/ä¸‹

ã€ç’°å¢ƒãƒ»èƒŒæ™¯ã®è©³ç´°ã€‘
- å ´æ‰€ï¼šå®¤å†…/å±‹å¤–/å…·ä½“çš„ãªå ´æ‰€
- èƒŒæ™¯è¦ç´ ï¼šå®¶å…·/å»ºç‰©/è‡ªç„¶/çª“/ãƒ‰ã‚¢ç­‰
- èƒŒæ™¯ã¨ã®ä½ç½®é–¢ä¿‚

ã€é‡è¦ãªç‰¹å¾´ã€‘
- ç‰¹ã«ç›®ç«‹ã¤è¦ç´ ã‚„ç‰¹å¾´çš„ãªéƒ¨åˆ†
- æ§‹å›³ã®ç‰¹å¾´ï¼ˆã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—/å…¨èº«/é æ™¯ç­‰ï¼‰

ã€å¿ å®Ÿæ€§ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã€‘
- çµ¶å¯¾ã«å¤‰æ›´ã—ã¦ã¯ã„ã‘ãªã„è¦ç´ ã‚’ç‰¹å®š

æ­£ç¢ºæ€§ã‚’æœ€é‡è¦–ã—ã€æ¨æ¸¬ã‚’é¿ã‘ã¦è¦‹ãˆã‚‹ã‚‚ã®ã ã‘ã‚’å®¢è¦³çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚æ§‹å›³ã¨ã‚µã‚¤ã‚ºæ„Ÿã‚‚é‡è¦ã§ã™ã€‚`
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: imageData
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 400
                    }),
                });

                let detailedAnalysis = "a subject";
                if (compositionResponse.ok) {
                    const compositionResult = await compositionResponse.json();
                    if (compositionResult.choices && compositionResult.choices[0]) {
                        detailedAnalysis = compositionResult.choices[0].message.content.trim();
                        console.log('STAGE 1 - Detailed analysis:', detailedAnalysis);
                    }
                } else {
                    console.warn('Stage 1 failed, continuing...');
                }

                // === STAGE 2: å¿ å®Ÿæ€§æœ€é©åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ ===
                updateProgress(40, 'AI ãŒ ã¬ã‚Šãˆç”¨ è¨­è¨ˆã‚’ æœ€é©åŒ–ã—ã¦ã„ã¾ã™ï¼ˆæ®µéš2/3ï¼‰...');
                console.log('STAGE 2: Faithfulness optimization...');
                
                const optimizationResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `ä»¥ä¸‹ã®è©³ç´°åˆ†æçµæœã‹ã‚‰ã€æ§‹å›³ãƒ»ã‚µã‚¤ã‚ºãƒ»é…ç½®ã¾ã§å¿ å®ŸãªDALL-E 3ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ï¼š

ã€åˆ†æçµæœã€‘
${detailedAnalysis}

ã€å¿ å®Ÿæ€§ä¿è¨¼è¦ä»¶ã€‘
1. äººç‰©ã®æ€§åˆ¥ãƒ»å¹´é½¢ãƒ»äººæ•°ã‚’çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„
2. ç‰©ä½“ã®ç¨®é¡ãƒ»æ•°é‡ã‚’çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„  
3. ãƒãƒ¼ã‚ºãƒ»å‘ããƒ»å§¿å‹¢ã‚’çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„
4. ä½“ã®è¦‹ãˆã¦ã„ã‚‹ç¯„å›²ã‚’çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„
5. è¢«å†™ä½“ã®ã‚µã‚¤ã‚ºæ„Ÿãƒ»ç”»é¢å æœ‰ç‡ã‚’ä¿æŒ
6. è¢«å†™ä½“ã®ä½ç½®ãƒ»é…ç½®ã‚’ä¿æŒ
7. èƒŒæ™¯è¦ç´ ã®åŸºæœ¬æ§‹æˆã‚’ä¿æŒ
8. å‹æ‰‹ãªè¦ç´ è¿½åŠ ã‚’çµ¶å¯¾ã«ç¦æ­¢

ã€å‡ºåŠ›å½¢å¼ã€‘
"A coloring book page showing [å…·ä½“çš„ã§å¿ å®Ÿãªæå†™ã€æ§‹å›³ãƒ»ã‚µã‚¤ã‚ºãƒ»é…ç½®ã‚’å«ã‚€]"

ã€ç‰¹åˆ¥æ³¨æ„äº‹é …ã€‘
- ç”·æ€§â†’å¥³æ€§ã€å¥³æ€§â†’ç”·æ€§ã®æ€§åˆ¥å¤‰æ›´ã¯çµ¶å¯¾ç¦æ­¢
- ãã‚…ã†ã‚Šâ†’ãªã™ç­‰ã®ç‰©ä½“å¤‰æ›´ã¯çµ¶å¯¾ç¦æ­¢
- é‡èœç­‰ã«å‹æ‰‹ã«ç›®ã‚„è¡¨æƒ…ã‚’ã¤ã‘ã‚‹ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢
- æ‰‹ã®ã¿ã®å†™çœŸã§å‹æ‰‹ã«å…¨èº«ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢
- äººæ•°ã‚„å‹•ç‰©ã®æ•°ã‚’å‹æ‰‹ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢
- è¢«å†™ä½“ã®ã‚µã‚¤ã‚ºæ„Ÿã‚„ä½ç½®ã‚’å‹æ‰‹ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ç¦æ­¢

å…ƒç”»åƒã®æ§‹å›³ãƒ»ã‚µã‚¤ã‚ºãƒ»é…ç½®ã«æœ€å¤§é™å¿ å®Ÿã§ã‚ã‚ŠãªãŒã‚‰ã€å­ã©ã‚‚å‘ã‘ã¬ã‚Šãˆã«é©ã—ãŸè¨˜è¿°ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`
                                    }
                                ]
                            }
                        ],
                        max_tokens: 200
                    }),
                });

                let optimizedDescription = detailedAnalysis;
                if (optimizationResponse.ok) {
                    const optimizationResult = await optimizationResponse.json();
                    if (optimizationResult.choices && optimizationResult.choices[0]) {
                        optimizedDescription = optimizationResult.choices[0].message.content.trim();
                        console.log('STAGE 2 - Optimized description:', optimizedDescription);
                    }
                } else {
                    console.warn('Stage 2 failed, using Stage 1 result...');
                }

                // === STAGE 3: æœ€çµ‚æ¤œè¨¼ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Œæˆ ===
                updateProgress(55, 'AI ãŒ æœ€çµ‚æ¤œè¨¼ã‚’ ã—ã¦ã„ã¾ã™ï¼ˆæ®µéš3/3ï¼‰...');
                console.log('STAGE 3: Final verification...');
                
                const verificationResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¿ å®Ÿæ€§ã®å•é¡ŒãŒãªã„ã‹æœ€çµ‚æ¤œè¨¼ã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

ã€ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‘
${optimizedDescription}

ã€æ¤œè¨¼é …ç›®ã€‘
1. æ€§åˆ¥ã®è¨˜è¿°ã¯æ­£ç¢ºã‹ï¼Ÿï¼ˆç”·æ€§â†”å¥³æ€§ã®æ··åŒãªã—ï¼‰
2. äººæ•°ãƒ»ç‰©ä½“æ•°ã®è¨˜è¿°ã¯æ­£ç¢ºã‹ï¼Ÿ
3. ãƒãƒ¼ã‚ºãƒ»å‘ãã®è¨˜è¿°ã¯å…·ä½“çš„ã‹ï¼Ÿ
4. ä½™è¨ˆãªè£…é£¾ï¼ˆç›®ã‚„è¡¨æƒ…ï¼‰ã®è¿½åŠ æŒ‡ç¤ºãŒãªã„ã‹ï¼Ÿ
5. ä½“ã®è¦‹ãˆã¦ã„ã‚‹ç¯„å›²ã¯æ­£ç¢ºã‹ï¼Ÿ
6. è¢«å†™ä½“ã®ã‚µã‚¤ã‚ºæ„Ÿãƒ»ä½ç½®ã¯ä¿æŒã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
7. æ§‹å›³ã®ç‰¹å¾´ã¯ä¿æŒã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ

ã€å•é¡ŒãŒã‚ã£ãŸå ´åˆã®ä¿®æ­£æŒ‡ç¤ºã€‘
- æ›–æ˜§ãªè¡¨ç¾ã‚’å…·ä½“çš„ã«ã™ã‚‹
- ç¦æ­¢äº‹é …ã‚’æ˜ç¢ºã«è¿½åŠ ã™ã‚‹
- æ•°é‡ã‚„æ€§åˆ¥ã‚’æ•°å­—ã‚„æ˜ç¢ºãªèªã§æŒ‡å®šã™ã‚‹
- ã‚µã‚¤ã‚ºæ„Ÿã‚„é…ç½®ã‚’æ˜ç¢ºã«æŒ‡å®šã™ã‚‹

ã€å‡ºåŠ›ã€‘
ä¿®æ­£ãŒå¿…è¦ãªå ´åˆï¼šä¿®æ­£ç‰ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
ä¿®æ­£ä¸è¦ãªå ´åˆï¼šã€Œæ¤œè¨¼å®Œäº†ï¼šå•é¡Œãªã—ã€

ç›®æ¨™ï¼šå…ƒç”»åƒã®æ§‹å›³ãƒ»ã‚µã‚¤ã‚ºãƒ»é…ç½®ã¾ã§100%å¿ å®Ÿãªã¬ã‚Šãˆãƒšãƒ¼ã‚¸ã®ç”Ÿæˆ`
                                    }
                                ]
                            }
                        ],
                        max_tokens: 250
                    }),
                });

                let finalDescription = optimizedDescription;
                if (verificationResponse.ok) {
                    const verificationResult = await verificationResponse.json();
                    if (verificationResult.choices && verificationResult.choices[0]) {
                        const verificationOutput = verificationResult.choices[0].message.content.trim();
                        console.log('STAGE 3 - Verification result:', verificationOutput);
                        
                        if (!verificationOutput.includes('æ¤œè¨¼å®Œäº†ï¼šå•é¡Œãªã—')) {
                            finalDescription = verificationOutput;
                            console.log('STAGE 3 - Applied corrections');
                        }
                    }
                } else {
                    console.warn('Stage 3 failed, using Stage 2 result...');
                }

                // === ç‰¹åˆ¥ã‚±ãƒ¼ã‚¹å¯¾ç­– ===
                const analysis = detailedAnalysis.toLowerCase();
                let specialCasePrompt = null;

                // ãƒ‘ãƒ‘ã¨å¨˜ã‚±ãƒ¼ã‚¹
                if ((analysis.includes('ç”·æ€§') && analysis.includes('å¥³ã®å­')) || 
                    (analysis.includes('father') && analysis.includes('daughter')) ||
                    (analysis.includes('ãƒ‘ãƒ‘') && analysis.includes('å¨˜'))) {
                    specialCasePrompt = `CRITICAL: This must show exactly one adult man and one young girl child. Do not change the man to a woman. Do not change the girl to a boy. Keep exactly these two people with their correct genders and the same size relationship.`;
                }
                
                // é‡èœè¤‡æ•°æœ¬ã‚±ãƒ¼ã‚¹
                else if (analysis.includes('ãã‚…ã†ã‚Š') && (analysis.includes('æœ¬') || analysis.includes('å€‹'))) {
                    const countMatch = analysis.match(/(\d+)æœ¬|(\d+)å€‹/);
                    const number = countMatch ? (countMatch[1] || countMatch[2]) : 'multiple';
                    specialCasePrompt = `CRITICAL: Show exactly ${number} cucumber vegetables only. Do not change cucumbers to other vegetables. Do not add faces or eyes to the vegetables. Keep them as simple vegetable shapes with the same size and arrangement.`;
                }
                
                // æ‰‹ã®ã¿ã‚±ãƒ¼ã‚¹
                else if ((analysis.includes('æ‰‹') && (analysis.includes('ã®ã¿') || analysis.includes('ã ã‘'))) ||
                         (analysis.includes('hand') && !analysis.includes('full body'))) {
                    specialCasePrompt = `CRITICAL: Show only the hand part visible in the original image. Do not add full body or person. Keep it as just a hand drawing with the same size and position.`;
                }

                updateProgress(70, 'ã‹ã‚ã„ãã¦è¶…å¿ å®Ÿãª ã¬ã‚Šãˆã‚’ ã¤ãã£ã¦ã„ã¾ã™... âœ¨');

                // === æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ ===
                let finalPrompt = `${finalDescription}

CRITICAL FAITHFULNESS REQUIREMENTS:
ğŸ¯ PRESERVE EXACTLY AS ANALYZED:
- Number and gender of people (NEVER change male to female or vice versa)
- Number and type of objects (NEVER change cucumber to eggplant, etc.)
- Exact poses and orientations described in analysis
- Body parts visible (full body, upper body, hands only, etc.)
- Subject size and position in frame (large/medium/small, center/left/right)
- Basic composition and layout from original image
- Background elements and their relationship to subjects

ğŸš« ABSOLUTELY FORBIDDEN:
- Changing genders (ç”·æ€§â†’å¥³æ€§, å¥³æ€§â†’ç”·æ€§)
- Changing object types (ãã‚…ã†ã‚Šâ†’ãªã™, catâ†’dog, etc.)
- Adding extra objects or characters not in original
- Adding facial features to inanimate objects (no eyes on vegetables/food)
- Changing poses, orientations, or viewing angles
- Changing subject size or position in composition
- Adding colors, patterns, or shading (pure black and white only)
- Changing the number of subjects (people, animals, objects)
- Altering the basic composition or framing

âœ… MINIMAL ALLOWED MODIFICATIONS:
- Simplify complex details into basic geometric shapes
- Make facial expressions slightly gentler (but keep same direction/mood)
- Round very sharp edges for safety
- Thicken outlines to 5-6px for easy coloring
- Simplify clothing patterns (but keep basic style and type)

COMPOSITION REQUIREMENTS:
ğŸ“ Maintain exact framing and composition of original
ğŸ“ Preserve subject size relative to frame
ğŸ“ Keep subject positioning (center/left/right/top/bottom)
ğŸ  Maintain basic background elements and spatial relationships

STYLE REQUIREMENTS:
ğŸ–¤ Pure black outlines (5-6px thick) on pure white background
ğŸ‘¶ Simple enough for ages 3-6 to color with chunky crayons
ğŸ“– Classic coloring book page style
ğŸ˜Š Gentle, child-friendly expressions (maintain original mood)
ğŸ¨ Minimal kawaii touches that don't alter core subject identity

${specialCasePrompt ? '\n' + specialCasePrompt : ''}

GOAL: Create a version so faithful that parents immediately recognize it as "their exact photo turned into a coloring page" with the same composition, size, and layout rather than "a different cute drawing inspired by their photo."`;

                console.log('Generating ultra-faithful coloring page with composition preservation...');
                console.log('Final prompt length:', finalPrompt.length);

                // === DALL-E 3 ç”Ÿæˆ ===
                const dalle3Response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "dall-e-3",
                        prompt: finalPrompt,
                        n: 1,
                        size: "1024x1024",
                        quality: "standard"
                    }),
                });

                if (!dalle3Response.ok) {
                    const errorData = await dalle3Response.json();
                    throw new Error(`API Error: ${dalle3Response.status} - ${errorData.error?.message}`);
                }

                const dalle3Result = await dalle3Response.json();

                if (dalle3Result.data && dalle3Result.data.length > 0) {
                    updateProgress(100, 'è¶…å¿ å®Ÿã§ ã‹ã‚ã„ã„ ã¬ã‚ŠãˆãŒ ã§ãã¾ã—ãŸï¼');
                    generatedImageUrl = dalle3Result.data[0].url;
                    showResult(dalle3Result.data[0].url, 'DALL-E-3-Ultra-Faithful', 'ğŸ¯ å…ƒã®å†™çœŸã«è¶…å¿ å®Ÿãª ã¬ã‚Šãˆã§ã™ï¼ˆæ§‹å›³ãƒ»ã‚µã‚¤ã‚ºã‚‚ä¿æŒï¼‰ï¼');
                } else {
                    throw new Error('No image generated');
                }

            } catch (error) {
                console.error('Complete faithful version error:', error);
                
                let errorMessage = error.message;
                if (error.message.includes('401')) {
                    errorMessage = 'OpenAI APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ ğŸ”‘';
                } else if (error.message.includes('429')) {
                    errorMessage = 'APIä½¿ç”¨é‡ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸ â°';
                } else if (error.message.includes('network')) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ ğŸŒ';
                }
                
                showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ ğŸ˜¢\n\n${errorMessage}\n\nã‚‚ã†ã„ã¡ã© ãŸã‚ã—ã¦ã­ï¼`);
            } finally {
                loadingContainer.style.display = 'none';
                generateButton.disabled = false;
                progressContainer.style.display = 'none';
            }
        }

        function showResult(imageUrl, model, message) {
            document.getElementById('resultImage').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #FF69B4; font-size: 1.3rem; margin-bottom: 15px;">ğŸ‰ è¶…ã‹ã‚ã„ã„ ã¬ã‚ŠãˆãŒ ã§ããŸã‚ˆï¼</p>
                    <p style="color: #FF69B4; font-size: 1rem; margin-bottom: 10px;">${message}</p>
                    <img src="${imageUrl}" alt="ç”Ÿæˆã•ã‚ŒãŸã¬ã‚Šãˆ" style="max-width: 100%; max-height: 500px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 3px solid #FFB6C1;">
                    <p style="color: #8B4513; font-size: 1rem; margin-top: 10px;">
                        å†™çœŸã‹ã‚‰ä½œã£ãŸ ã‚ªãƒªã‚¸ãƒŠãƒ« ã¬ã‚Šãˆã ã‚ˆï¼ ğŸŒˆ<br>
                        <small>(${model}ã§ ã›ã„ã›ã„)</small>
                    </p>
                </div>
            `;
            
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function printColoring() {
            if (!generatedImageUrl) {
                showError('ãƒ—ãƒªãƒ³ãƒˆã™ã‚‹ ãŒãã†ãŒ ã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>ã›ã‹ã„ã¬ã‚Šãˆ - ãƒ—ãƒªãƒ³ãƒˆ</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                text-align: center; 
                                font-family: 'Comic Sans MS', Arial, sans-serif;
                            }
                            img {
                                max-height: 90vh;
                                border: 2px solid #000;
                            }
                            h1 {
                                color: #FF69B4;
                                font-size: 2rem;
                                margin-bottom: 20px;
                            }
                            @media print {
                                body { margin: 10px; }
                                h1 { font-size: 1.5rem; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>ğŸŒˆ ã›ã‹ã„ã¬ã‚Šãˆ ğŸ¨</h1>
                        <img src="${generatedImageUrl}" alt="ã¬ã‚Šãˆ">
                        <p style="margin-top: 20px; color: #8B4513;">ãŸã®ã—ã ã¬ã£ã¦ã­ï¼</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            
            // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒ—ãƒªãƒ³ãƒˆ
            const img = printWindow.document.querySelector('img');
            img.onload = () => {
                setTimeout(() => printWindow.print(), 500);
            };
        }

        function downloadColoring() {
            if (!generatedImageUrl) {
                showError('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ ãŒãã†ãŒ ã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const link = document.createElement('a');
            link.href = generatedImageUrl;
            link.download = `ã›ã‹ã„ã¬ã‚Šãˆ_${new Date().getTime()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('ã¬ã‚Šãˆã‚’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ ğŸ“¥');
        }

        function resetApp() {
            selectedFile = null;
            generatedImageUrl = null;
            fileInput.value = '';
            previewContainer.innerHTML = '';
            resultContainer.style.display = 'none';
            loadingContainer.style.display = 'none';
            generateButton.disabled = true;
            hideError();
            
            // ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åˆæœŸåŒ–
        console.log('Fixed simple version initialized');
    </script>
</body>
</html>