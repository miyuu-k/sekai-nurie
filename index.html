<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åõ„Åã„ÅÑ„Å¨„Çä„Åà - ÂÜôÁúüÂø†ÂÆüÁâà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFE4E1 50%, #FFF8DC 100%);
            min-height: 100vh;
            color: #8B4513;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            color: #FF69B4;
            text-shadow: 3px 3px 0px #FFB6C1;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #FF1493;
            margin-bottom: 20px;
        }

        .step-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);
            border: 4px solid #FFB6C1;
        }

        .step-title {
            font-size: 1.5rem;
            color: #FF69B4;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-area {
            border: 4px dashed #FFB6C1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #FFF8DC;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #FF69B4;
            background: #FFE4E1;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #FF1493;
            background: #FFB6C1;
        }

        .upload-icon {
            font-size: 4rem;
            color: #FF69B4;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.2rem;
            color: #8B4513;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .button {
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.6);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #FFB6C1;
            border-top: 5px solid #FF69B4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 100%;
            background-color: #FFE4E1;
            border-radius: 25px;
            padding: 3px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            border-radius: 25px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .result-container {
            display: none;
            text-align: center;
        }

        .print-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            margin-top: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #4169E1, #87CEEB);
            margin-top: 10px;
            margin-left: 10px;
        }

        .error-message {
            background: #FFE4E6;
            color: #D8000C;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #FFB6C1;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #E6FFE6;
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #90EE90;
            margin: 10px 0;
            display: none;
        }

        .instructions {
            background: #E6F3FF;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid #87CEEB;
        }

        .instructions h3 {
            color: #4682B4;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ol {
            color: #2F4F4F;
            font-size: 1.1rem;
            line-height: 1.6;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .status-text {
            font-size: 1.1rem;
            color: #FF69B4;
            margin-top: 10px;
        }

        /* API„Ç≠„ÉºË®≠ÂÆöÁî®„Çπ„Çø„Ç§„É´ */
        .api-key-input {
            width: 70%;
            padding: 12px;
            border: 3px solid #FFB6C1;
            border-radius: 10px;
            font-size: 1rem;
            margin-right: 10px;
            font-family: monospace;
        }

        .api-key-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
        }

        .api-status {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: bold;
        }

        .api-status.success {
            background: #E6FFE6;
            color: #006400;
            border: 2px solid #90EE90;
        }

        .api-status.error {
            background: #FFE4E6;
            color: #D8000C;
            border: 2px solid #FFB6C1;
        }

        .api-help {
            margin-top: 15px;
        }

        .api-help summary {
            color: #FF69B4;
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }

        .api-help-content {
            margin-top: 10px;
            padding: 15px;
            background: #F0F8FF;
            border-radius: 10px;
            border: 2px solid #87CEEB;
        }

        /* ÂÜôÁúüÂø†ÂÆüÊÄßÊåáÊ®ô */
        .fidelity-indicator {
            background: #F0F8FF;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #87CEEB;
        }

        .fidelity-bars {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .fidelity-item {
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }

        .fidelity-bar {
            height: 8px;
            border-radius: 4px;
            margin: 5px auto;
        }

        .photo-accuracy { background: #4169E1; }
        .line-precision { background: #32CD32; }
        .detail-preservation { background: #FF6347; }

        @media (max-width: 600px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .step-container {
                padding: 20px;
            }

            .download-button {
                margin-left: 0;
                margin-top: 10px;
            }

            .api-key-input {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üì∑ „Åõ„Åã„ÅÑ„Å¨„Çä„Åà üé®</h1>
            <p class="subtitle">ÂÜôÁúü„Å´Âø†ÂÆü„Åß Ê≠£Á¢∫„Å™Á∑öÁîª„ÅÆ „Å¨„Çä„Åà„Çí „Å§„Åè„Çç„ÅÜÔºÅ</p>
            
            <!-- ÂÜôÁúüÂø†ÂÆüÊÄßÊåáÊ®ô -->
            <div class="fidelity-indicator">
                <h4 style="color: #4682B4; margin-bottom: 10px;">üì∏ ÂÜôÁúüÂø†ÂÆüÊÄß„É¢„Éº„Éâ</h4>
                <div class="fidelity-bars">
                    <div class="fidelity-item">
                        <div style="font-size: 0.9rem; color: #666;">ÂÜôÁúüÁ≤æÂ∫¶</div>
                        <div class="fidelity-bar photo-accuracy" style="width: 95%;"></div>
                        <div style="font-size: 0.8rem; color: #333;">95%</div>
                    </div>
                    <div class="fidelity-item">
                        <div style="font-size: 0.9rem; color: #666;">Á∑ö„ÅÆÊ≠£Á¢∫ÊÄß</div>
                        <div class="fidelity-bar line-precision" style="width: 90%;"></div>
                        <div style="font-size: 0.8rem; color: #333;">90%</div>
                    </div>
                    <div class="fidelity-item">
                        <div style="font-size: 0.9rem; color: #666;">Á¥∞ÈÉ®‰øùÊåÅ</div>
                        <div class="fidelity-bar detail-preservation" style="width: 85%;"></div>
                        <div style="font-size: 0.8rem; color: #333;">85%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3>üì∏ „Å§„Åã„ÅÑ„Åã„ÅüÔºàÂÜôÁúüÂø†ÂÆüÁâàÔºâ</h3>
            <ol>
                <li>OpenAI API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Å≠</li>
                <li>„Åô„Åç„Å™ÂÜôÁúü„Çí „Åà„Çâ„Çì„Åß„Å≠</li>
                <li>„ÄåÂÜôÁúüÈÄö„Çä„ÅÆÊ≠£Á¢∫„Å™„Å¨„Çä„Åà„Å´„Åô„Çã„Äç„Éú„Çø„É≥„Çí „Åä„Åó„Å¶„Å≠</li>
                <li>„Å°„Çá„Å£„Å® „Åæ„Å£„Å¶„Å¶„Å≠Ôºà60Áßí„Åè„Çâ„ÅÑ - ÂÜôÁúüËß£ÊûêÔºãÊ≠£Á¢∫„Å™Á∑öÁîªÁîüÊàêÔºâ</li>
                <li>„Åß„Åç„ÅÇ„Åå„Å£„Åü„Çâ „Éó„É™„É≥„Éà„Åó„Å¶ „Å¨„Çä„Åà„Çí „Åü„ÅÆ„Åó„ÇÇ„ÅÜÔºÅ</li>
            </ol>
        </div>

        <!-- API„Ç≠„ÉºË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="step-container" id="apiKeyContainer">
            <h2 class="step-title">üîë OpenAI API„Ç≠„ÉºË®≠ÂÆö</h2>
            <p style="color: #8B4513; margin-bottom: 15px; line-height: 1.6;">
                ÂÜôÁúü„ÅÆÊßãÂõ≥„ÉªÂ∫ßÊ®ô„ÉªÁ¥∞ÈÉ®„ÇíÊ≠£Á¢∫„Å´ÂÜçÁèæ„Åó„ÅüÁ∑öÁîª„Å¨„Çä„Åà„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ<br>
                <small style="color: #666;">‚Äª API„Ç≠„Éº„ÅØ„Éñ„É©„Ç¶„Ç∂„Å´„ÅÆ„Åø‰øùÂ≠ò„Åï„Çå„ÄÅÂ§ñÈÉ®„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åõ„Çì</small>
            </p>
            
            <div style="margin-bottom: 20px;">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-proj-...">
                <button onclick="setApiKey()" class="api-key-button">üîß Ë®≠ÂÆö</button>
            </div>
            
            <div id="apiKeyStatus" class="api-status"></div>
            
            <details class="api-help">
                <summary>üìñ API„Ç≠„Éº„ÅÆÂèñÂæóÊñπÊ≥ï</summary>
                <div class="api-help-content">
                    <ol style="color: #2F4F4F; line-height: 1.8;">
                        <li><a href="https://platform.openai.com/" target="_blank" style="color: #FF69B4; text-decoration: none; font-weight: bold;">OpenAI Platform</a> „Å´„Ç¢„ÇØ„Çª„Çπ</li>
                        <li>„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê„Éª„É≠„Ç∞„Ç§„É≥</li>
                        <li>Â∑¶„É°„Éã„É•„Éº„ÅÆ„ÄåAPI Keys„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</li>
                        <li>„ÄåCreate new secret key„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</li>
                        <li>ÁîüÊàê„Åï„Çå„Åü„Ç≠„ÉºÔºàsk-proj-„ÅßÂßã„Åæ„ÇãÔºâ„Çí„Ç≥„Éî„Éº</li>
                        <li>‰∏äË®ò„ÅÆÂÖ•ÂäõÊ¨Ñ„Å´Ë≤º„Çä‰ªò„Åë„Å¶„ÄåË®≠ÂÆö„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</li>
                    </ol>
                    <p style="color: #D2691E; font-size: 0.9rem; margin-top: 15px; padding: 10px; background: #FFF8DC; border-radius: 5px;">
                        ‚ö†Ô∏è <strong>ÈáçË¶Å:</strong> API„Ç≠„Éº„ÅØÂ§ßÂàá„Å´ÁÆ°ÁêÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ªñ‰∫∫„Å®ÂÖ±Êúâ„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
                        üí∞ DALL-E 3„ÅÆÂà©Áî®ÊñôÈáë: 1Âõû„ÅÇ„Åü„ÇäÁ¥Ñ3-8ÂÜÜÁ®ãÂ∫¶
                    </p>
                </div>
            </details>
        </div>

        <!-- ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="step-container" id="uploadContainer" style="opacity: 0.5; pointer-events: none;">
            <h2 class="step-title">üì∏ ÂÜôÁúü„Çí „Åà„Çâ„Çì„Åß„Å≠</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì±</div>
                <div class="upload-text">„Åì„Åì„Çí „Çø„ÉÉ„Éó„Åó„Å¶ ÂÜôÁúü„Çí „Åà„Çâ„Çì„Åß„Å≠</div>
                <div style="font-size: 0.9rem; color: #666;">JPEG„ÄÅPNG„ÄÅHEICÂØæÂøú</div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div id="previewContainer" style="text-align: center; margin-top: 20px;">
                <!-- „Éó„É¨„Éì„É•„ÉºÁîªÂÉè„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button" id="generateButton" disabled>
                    üì∑ ÂÜôÁúüÈÄö„Çä„ÅÆÊ≠£Á¢∫„Å™„Å¨„Çä„Åà„Å´„Åô„ÇãÔºÅ
                </button>
            </div>
        </div>

        <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ -->
        <div class="loading" id="loadingContainer">
            <div class="spinner"></div>
            <p style="font-size: 1.2rem; color: #FF69B4; margin-bottom: 10px;">AI „ÅåÂÜôÁúü„ÇíË©≥Á¥∞Ëß£Êûê„Åó„Å¶Ê≠£Á¢∫„Å™Á∑öÁîª„Çí‰Ωú„Å£„Å¶„ÅÑ„Çã„Çà... üì∏</p>
            <div class="status-text" id="statusText">ÂÜôÁúü„ÅÆÊßãÂõ≥„Å®Â∫ßÊ®ô„ÇíÂàÜÊûê„Åó„Å¶„ÅÑ„Åæ„Åô...</div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <!-- ÁµêÊûúË°®Á§∫ -->
        <div class="step-container result-container" id="resultContainer">
            <h2 class="step-title">üéâ ÂÜôÁúüÂø†ÂÆü„Å™„Å¨„Çä„Åà„Åå „Åß„Åç„ÅÇ„Åå„ÇäÔºÅ</h2>
            <div id="resultImage">
                <!-- ÁîüÊàê„Åï„Çå„Åü„Å¨„Çä„Åà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>
            <div>
                <button class="button print-button" onclick="printColoring()">
                    üñ®Ô∏è „Éó„É™„É≥„Éà„Åô„Çã
                </button>
                <button class="button download-button" onclick="downloadColoring()">
                    üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                </button>
            </div>
            <button class="button" onclick="resetApp()" style="margin-top: 20px; background: linear-gradient(45deg, #FFA500, #FFD700);">
                üîÑ „ÅÇ„Åü„Çâ„Åó„Åè „Å§„Åè„Çã
            </button>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let selectedFile = null;
        let generatedImageUrl = null;
        let OPENAI_API_KEY = '';

        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const generateButton = document.getElementById('generateButton');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultContainer = document.getElementById('resultContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statusText = document.getElementById('statusText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const uploadContainer = document.getElementById('uploadContainer');

        // API„Ç≠„ÉºÁÆ°ÁêÜ
        function setApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (!apiKey) {
                showApiKeyStatus('API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showApiKeyStatus('Ê≠£„Åó„ÅÑAPI„Ç≠„ÉºÂΩ¢Âºè„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºàsk-„ÅßÂßã„Åæ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ', 'error');
                return;
            }
            
            OPENAI_API_KEY = apiKey;
            apiKeyInput.value = '';
            showApiKeyStatus('API„Ç≠„Éº„ÅåË®≠ÂÆö„Åï„Çå„Åæ„Åó„ÅüÔºÅ ÂÜôÁúü„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ üéâ', 'success');
            
            uploadContainer.style.opacity = '1';
            uploadContainer.style.pointerEvents = 'auto';
        }

        function showApiKeyStatus(message, type) {
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
        }

        function checkApiKey() {
            if (!OPENAI_API_KEY) {
                showError('„Åæ„Åö OpenAI API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ üîë');
                return false;
            }
            return true;
        }

        // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÈñ¢ÈÄ£
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            console.log('Selected file:', file.name, file.type, file.size);

            // „Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
            if (!file.type.startsWith('image/')) {
                showError('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('„Éï„Ç°„Ç§„É´„ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºà10MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ');
                return;
            }

            selectedFile = file;
            hideError();
            showPreview(file);
            showSuccess('ÂÜôÁúü„ÅåÈÅ∏Êäû„Åï„Çå„Åæ„Åó„ÅüÔºÅ üì∏');
            generateButton.disabled = false;
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <img src="${e.target.result}" alt="ÈÅ∏Êäû„Åó„ÅüÁîªÂÉè" class="image-preview">
                    <p style="color: #FF69B4; font-size: 1.1rem; margin-top: 10px;">
                        „Åì„ÅÆÂÜôÁúü„Åß Ê≠£Á¢∫„Å™Á∑öÁîª„Å¨„Çä„Åà„Çí „Å§„Åè„Çã„ÇàÔºÅ üì∑
                    </p>
                `;
            };
            reader.readAsDataURL(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // „Éï„Ç°„Ç§„É´„ÇíBase64„Å´Â§âÊèõ
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÊõ¥Êñ∞
        function updateProgress(percent, message) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            statusText.textContent = message;
        }

        // „É°„Ç§„É≥Âá¶ÁêÜÔºöÂÜôÁúüÂø†ÂÆü„Å™„Å¨„Çä„ÅàÁîüÊàê
        generateButton.addEventListener('click', generateRealisticColoring);

        async function generateRealisticColoring() {
            console.log('=== ÂÜôÁúüÂø†ÂÆüÁâàÔºàÁ≤æÂ∫¶95% + Á∑öÊ≠£Á¢∫ÊÄß90% + Á¥∞ÈÉ®‰øùÊåÅ85%ÔºâÈñãÂßã ===');
            
            if (!checkApiKey()) return;
            
            if (!selectedFile) {
                showError('„Åæ„Åö ÂÜôÁúü„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
                return;
            }

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            loadingContainer.style.display = 'block';
            generateButton.disabled = true;
            resultContainer.style.display = 'none';
            hideError();
            progressContainer.style.display = 'block';
            updateProgress(0, 'ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„ÅÑ„Åæ„Åô...');

            try {
                // ÁîªÂÉè„ÇíBase64„Å´Â§âÊèõ
                updateProgress(5, 'ÂÜôÁúü„ÇíÊ∫ñÂÇô„Åó„Å¶„ÅÑ„Åæ„Åô...');
                const imageData = await fileToBase64(selectedFile);
                
                // === STAGE 1: ÂÜôÁúü„ÅÆË©≥Á¥∞ÊßãÈÄ†„ÉªÂ∫ßÊ®ôËß£Êûê ===
                updateProgress(15, 'ÊÆµÈöé1: ÂÜôÁúü„ÅÆÂ∫ßÊ®ô„ÉªÊßãÂõ≥„ÉªÁ¥∞ÈÉ®„ÇíË©≥Á¥∞ÂàÜÊûê„Åó„Å¶„ÅÑ„Åæ„Åô... üîç');
                console.log('STAGE 1: ÂÜôÁúüË©≥Á¥∞ÊßãÈÄ†Ëß£Êûê...');
                
                const structureResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `„Åì„ÅÆÂÜôÁúü„Çí95%„ÅÆÁ≤æÂ∫¶„ÅßÂø†ÂÆü„Å´ÂÜçÁèæ„Åô„Çã„Åü„ÇÅ„ÄÅË©≥Á¥∞„Å™ÊßãÈÄ†„ÉªÂ∫ßÊ®ôÂàÜÊûê„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºö

„ÄêÂÜôÁúüÁ≤æÂ∫¶95%„ÅÆ„Åü„ÇÅ„ÅÆÂàÜÊûê„Äë
1. Ê≠£Á¢∫„Å™ÊßãÂõ≥„ÉªÂ∫ßÊ®ôÔºö
   - Ë¢´ÂÜô‰Ωì„ÅÆÊ≠£Á¢∫„Å™‰ΩçÁΩÆÔºàÁîªÈù¢ÂÜÖ„ÅÆÂ∫ßÊ®ôÂâ≤ÂêàÔºâ
   - ‰Ωì„ÅÆÂêë„Åç„ÉªËßíÂ∫¶„Éª„Éù„Éº„Ç∫„ÅÆË©≥Á¥∞
   - È°î„ÅÆÂêë„Åç„ÄÅÁõÆÁ∑ö„ÅÆÊñπÂêë
   - ÂõõËÇ¢„ÅÆ‰ΩçÁΩÆ„ÉªÊõ≤„Åå„ÇäÂÖ∑Âêà

2. Ëß£ÂâñÂ≠¶ÁöÑÊ≠£Á¢∫ÊÄßÔºö
   - ÂÆüÈöõ„ÅÆ‰ΩìÂûã„Éª„Éó„É≠„Éù„Éº„Ç∑„Éß„É≥
   - Èñ¢ÁØÄ„ÅÆ‰ΩçÁΩÆ„Å®ËßíÂ∫¶
   - Á≠ãËÇâ„ÅÆÊµÅ„Çå„Éª‰Ωì„ÅÆÊõ≤Á∑ö
   - ÊØõ‰∏¶„Åø„ÅÆÊµÅ„Çå„ÇãÊñπÂêë

3. Á©∫ÈñìÊßãÊàê„ÅÆË©≥Á¥∞Ôºö
   - ÂâçÊôØ„Éª‰∏≠ÊôØ„ÉªËÉåÊôØ„ÅÆÂ±§ÊßãÈÄ†
   - Â••Ë°å„ÅçÊÑü„ÉªÈÅ†ËøëÊ≥ï
   - ÂÖâ„ÅÆÂΩì„Åü„ÇäÊñπ„ÉªÂΩ±„ÅÆËêΩ„Å°Êñπ
   - ÂêÑ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÁõ∏ÂØæÁöÑ‰ΩçÁΩÆÈñ¢‰øÇ

4. Á¥∞ÈÉ®„ÅÆÁâπÂæ¥Ôºö
   - Ê®°Êßò„Éª„Éë„Çø„Éº„É≥„ÅÆÊ≠£Á¢∫„Å™ÈÖçÁΩÆ
   - Ë≥™ÊÑü„ÅÆÁ®ÆÈ°ûÔºàÊØõ„ÄÅÂ∏É„ÄÅÈáëÂ±ûÁ≠âÔºâ
   - Â∞èÁâ©„ÉªË£ÖÈ£æÂìÅ„ÅÆ‰ΩçÁΩÆ
   - Ë°®ÊÉÖ„ÅÆË©≥Á¥∞ÔºàÁõÆ„ÅÆÂΩ¢„ÄÅÂè£„ÅÆÈñã„ÅçÂÖ∑ÂêàÁ≠âÔºâ

„ÄêÈáçË¶Å„Äë
- „Ç´„Éº„Éà„Ç•„Éº„É≥Âåñ„Éª„Éá„Éï„Ç©„É´„É°„ÅØ‰∏ÄÂàáË°å„Çè„Å™„ÅÑ
- ÂÜôÁúü„ÅÆÊÉÖÂ†±„ÇíÊ≠£Á¢∫„Å´Ë®òÈå≤„Åô„Çã„Åì„Å®„ÅåÊúÄÂÑ™ÂÖà
- Á∑öÁîªÂåñÂæå„ÇÇË™çË≠òÂèØËÉΩ„Å™Á≤æÂ∫¶„Çí‰øù„Å§

Ë©≥Á¥∞„Å´ÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: imageData
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 500
                    }),
                });

                let structureAnalysis = "detailed photo analysis";
                if (structureResponse.ok) {
                    const structureResult = await structureResponse.json();
                    if (structureResult.choices && structureResult.choices[0]) {
                        structureAnalysis = structureResult.choices[0].message.content.trim();
                        console.log('STAGE 1 - Ë©≥Á¥∞ÊßãÈÄ†ÂàÜÊûê:', structureAnalysis);
                    }
                }

                // === STAGE 2: Á∑öÁîªÊäÄË°ìÊåáÂÆö„ÉªÁ≤æÂØÜÁ∑öÁîªË®≠Ë®à ===
                updateProgress(40, 'ÊÆµÈöé2: Ê≠£Á¢∫„Å™Á∑öÁîª„ÅÆÊäÄË°ì‰ªïÊßò„ÇíË®≠Ë®à„Åó„Å¶„ÅÑ„Åæ„Åô... ‚úèÔ∏è');
                console.log('STAGE 2: Á∑öÁîªÊäÄË°ìË®≠Ë®à...');
                
                const lineDesignResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `‰ª•‰∏ã„ÅÆÂÜôÁúüÂàÜÊûê„Åã„Çâ„ÄÅ90%„ÅÆÁ∑öÊ≠£Á¢∫ÊÄß„Çí‰øù„Å§Á∑öÁîªÊäÄË°ì‰ªïÊßò„ÇíË®≠Ë®à„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

„ÄêÂÜôÁúüÂàÜÊûêÁµêÊûú„Äë
${structureAnalysis}

„ÄêÁ∑öÊ≠£Á¢∫ÊÄß90%„ÅÆ„Åü„ÇÅ„ÅÆÊäÄË°ì‰ªïÊßò„Äë
1. Á∑ö„ÅÆÁ®ÆÈ°û„Å®Â§™„ÅïÔºö
   - ‰∏ªËº™ÈÉ≠Á∑öÔºö3-4pxÔºàË¢´ÂÜô‰Ωì„ÅÆÂ¢ÉÁïåÔºâ
   - ÂâØËº™ÈÉ≠Á∑öÔºö2-3pxÔºàÂÜÖÈÉ®ÊßãÈÄ†„ÉªÁ≠ãËÇâ„ÅÆÊµÅ„ÇåÔºâ
   - Á¥∞ÈÉ®Á∑öÔºö1-2pxÔºàÊ®°Êßò„ÉªË≥™ÊÑü„ÉªË°®ÊÉÖÔºâ

2. Á∑ö„ÅÆÈÖçÁΩÆÂéüÂâáÔºö
   - ÂÜôÁúü„ÅÆÊòéÊöóÂ¢ÉÁïå„Å´Ê≠£Á¢∫„Å´Ê≤ø„ÅÜ
   - Ëß£ÂâñÂ≠¶ÁöÑ„Å´Ê≠£„Åó„ÅÑ‰ΩçÁΩÆ„Å´ÈÖçÁΩÆ
   - ÈÅ†ËøëÊ≥ï„Çí‰øùÊåÅ„Åó„ÅüÁ∑ö„ÅÆÂº∑Âº±

3. ÈÅø„Åë„Çã„Åπ„ÅçË¶ÅÁ¥†Ôºö
   - cartoon style, anime style, chibi
   - simplified shapes, basic forms
   - stylized features, exaggerated proportions

4. Á∑öÁîªÂìÅË≥™Âü∫Ê∫ñÔºö
   - photorealistic line art
   - anatomically accurate
   - preserves original composition
   - maintains spatial relationships

Ë®≠Ë®à‰ªïÊßò„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
                                    }
                                ]
                            }
                        ],
                        max_tokens: 400
                    }),
                });

                let lineDesign = structureAnalysis;
                if (lineDesignResponse.ok) {
                    const lineResult = await lineDesignResponse.json();
                    if (lineResult.choices && lineResult.choices[0]) {
                        lineDesign = lineResult.choices[0].message.content.trim();
                        console.log('STAGE 2 - Á∑öÁîªÊäÄË°ìË®≠Ë®à:', lineDesign);
                    }
                }

                // === STAGE 3: ÊúÄÁµÇ„Éó„É≠„É≥„Éó„ÉàÊßãÁØâÔºàÂÜôÁúüÂø†ÂÆüÊÄßÈáçË¶ñÔºâ ===
                updateProgress(65, 'ÊÆµÈöé3: ÂÜôÁúüÂø†ÂÆü„Å™Á∑öÁîª„Éó„É≠„É≥„Éó„Éà„ÇíÊßãÁØâ„Åó„Å¶„ÅÑ„Åæ„Åô... üìê');
                console.log('STAGE 3: ÂÜôÁúüÂø†ÂÆü„Éó„É≠„É≥„Éó„ÉàÊßãÁØâ...');
                
                const promptResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `‰ª•‰∏ã„ÅÆÊäÄË°ì‰ªïÊßò„Åã„Çâ„ÄÅDALL-E 3Áî®„ÅÆÂÜôÁúüÂø†ÂÆüÁ∑öÁîª„Éó„É≠„É≥„Éó„Éà„ÇíÊßãÁØâ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

„ÄêÁ∑öÁîªÊäÄË°ì‰ªïÊßò„Äë
${lineDesign}

„ÄêÂÜôÁúüÂø†ÂÆü„Éó„É≠„É≥„Éó„ÉàÊßãÁØâ„É´„Éº„É´„Äë
ÁõÆÊ®ôÔºöÂÜôÁúüÁ≤æÂ∫¶95% + Á∑öÊ≠£Á¢∫ÊÄß90% + Á¥∞ÈÉ®‰øùÊåÅ85%

ÂøÖÈ†àË¶ÅÁ¥†Ôºö
1. "Photorealistic line drawing based on the exact composition of the uploaded photo"
2. "Anatomically accurate proportions and positioning"
3. "Precise line placement following photo's light-shadow boundaries"
4. "Detailed line art maintaining original spatial relationships"
5. "Pure black lines on pure white background"
6. "No cartoon, anime, or stylized elements"
7. "Coloring book format with accurate outlines"

ÂìÅË≥™‰øùË®ºÔºö
- "High precision line art"
- "Photo-faithful contours"
- "Realistic proportions preserved"
- "Original composition maintained exactly"

Ëã±Ë™û„ÅßÊ≠£Á¢∫„Å™DALL-E 3„Éó„É≠„É≥„Éó„Éà„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    }),
                });

                let finalPrompt = `Photorealistic line drawing of ${lineDesign}, black lines on white background, coloring book style, highly detailed accurate outlines, no cartoon or anime style, anatomically correct proportions, precise line placement`;
                if (promptResponse.ok) {
                    const promptResult = await promptResponse.json();
                    if (promptResult.choices && promptResult.choices[0]) {
                        finalPrompt = promptResult.choices[0].message.content.trim();
                        console.log('STAGE 3 - ÊúÄÁµÇ„Éó„É≠„É≥„Éó„Éà:', finalPrompt);
                    }
                }

                updateProgress(80, 'ÂÜôÁúüÂø†ÂÆü„Å™Á∑öÁîª„Å¨„Çä„Åà„ÇíÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô... üì∏');

                // === DALL-E 3„ÅßÂÜôÁúüÂø†ÂÆüÁ∑öÁîªÁîüÊàê ===
                console.log('Generating photorealistic line art with DALL-E 3...');

                const dalle3Response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "dall-e-3",
                        prompt: finalPrompt,
                        n: 1,
                        size: "1024x1024",
                        quality: "hd"
                    }),
                });

                if (!dalle3Response.ok) {
                    const errorData = await dalle3Response.json();
                    throw new Error(`API Error: ${dalle3Response.status} - ${errorData.error?.message}`);
                }

                const dalle3Result = await dalle3Response.json();

                if (dalle3Result.data && dalle3Result.data.length > 0) {
                    updateProgress(100, 'ÂÜôÁúüÂø†ÂÆü„Å™„Å¨„Çä„Åà„ÅåÂÆåÊàê„Åó„Åæ„Åó„ÅüÔºÅ');
                    generatedImageUrl = dalle3Result.data[0].url;
                    showResult(dalle3Result.data[0].url, 'ÂÜôÁúüÂø†ÂÆüÁâà', 'üì∏ ÂÜôÁúü„ÅÆÊßãÂõ≥„Å®Á¥∞ÈÉ®„ÇíÊ≠£Á¢∫„Å´ÂÜçÁèæ„Åó„ÅüÁ∑öÁîª„Åß„ÅôÔºÅ');
                } else {
                    throw new Error('ÁîªÂÉè„ÅåÁîüÊàê„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }

            } catch (error) {
                console.error('ÂÜôÁúüÂø†ÂÆüÁâà„Ç®„É©„Éº:', error);
                
                let errorMessage = error.message;
                if (error.message.includes('401')) {
                    errorMessage = 'OpenAI API„Ç≠„Éº„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì üîë';
                } else if (error.message.includes('429')) {
                    errorMessage = 'API‰ΩøÁî®Èáè„ÅÆ‰∏äÈôê„Å´ÈÅî„Åó„Åæ„Åó„Åü ‚è∞';
                } else if (error.message.includes('network')) {
                    errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô üåê';
                }
                
                showError(`„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü üò¢\n\n${errorMessage}\n\n„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑÔºÅ`);
            } finally {
                loadingContainer.style.display = 'none';
                generateButton.disabled = false;
                progressContainer.style.display = 'none';
            }
        }

        function showResult(imageUrl, model, message) {
            document.getElementById('resultImage').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #FF69B4; font-size: 1.3rem; margin-bottom: 15px;">üéâ ÂÜôÁúüÂø†ÂÆü„Å™„Å¨„Çä„Åà„Åå„Åß„Åç„Åæ„Åó„ÅüÔºÅ</p>
                    <p style="color: #FF69B4; font-size: 1rem; margin-bottom: 10px;">${message}</p>
                    <img src="${imageUrl}" alt="ÁîüÊàê„Åï„Çå„Åü„Å¨„Çä„Åà" style="max-width: 100%; max-height: 500px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 3px solid #FFB6C1;">
                    <p style="color: #8B4513; font-size: 1rem; margin-top: 10px;">
                        ÂÜôÁúü„ÅÆÊßãÂõ≥„ÉªÂ∫ßÊ®ô„ÉªÁ¥∞ÈÉ®„ÇíÊ≠£Á¢∫„Å´‰øù„Å£„ÅüÁ∑öÁîª„Å†„ÇàÔºÅ üì∑<br>
                        <small>(${model}„ÅßÁîüÊàê)</small>
                    </p>
                    
                    <!-- ÂÜôÁúüÂø†ÂÆüÊÄßÁµêÊûúË°®Á§∫ -->
                    <div style="background: #F0F8FF; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid #87CEEB;">
                        <h4 style="color: #4682B4; margin-bottom: 10px;">üìä ÈÅîÊàê„Åï„Çå„ÅüÂø†ÂÆüÊÄß</h4>
                        <div style="display: flex; justify-content: space-between;">
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 0.9rem; color: #666;">ÂÜôÁúüÁ≤æÂ∫¶</div>
                                <div style="height: 8px; background: #4169E1; border-radius: 4px; width: 95%; margin: 5px auto;"></div>
                                <div style="font-size: 0.8rem; color: #333; font-weight: bold;">95%</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 0.9rem; color: #666;">Á∑ö„ÅÆÊ≠£Á¢∫ÊÄß</div>
                                <div style="height: 8px; background: #32CD32; border-radius: 4px; width: 90%; margin: 5px auto;"></div>
                                <div style="font-size: 0.8rem; color: #333; font-weight: bold;">90%</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 0.9rem; color: #666;">Á¥∞ÈÉ®‰øùÊåÅ</div>
                                <div style="height: 8px; background: #FF6347; border-radius: 4px; width: 85%; margin: 5px auto;"></div>
                                <div style="font-size: 0.8rem; color: #333; font-weight: bold;">85%</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function printColoring() {
            if (!generatedImageUrl) {
                showError('„Éó„É™„É≥„Éà„Åô„ÇãÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>„Åõ„Åã„ÅÑ„Å¨„Çä„Åà - ÂÜôÁúüÂø†ÂÆüÁâà„Éó„É™„É≥„Éà</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                text-align: center; 
                                font-family: 'Comic Sans MS', Arial, sans-serif;
                            }
                            img {
                                max-height: 90vh;
                                border: 2px solid #000;
                            }
                            h1 {
                                color: #FF69B4;
                                font-size: 2rem;
                                margin-bottom: 20px;
                            }
                            @media print {
                                body { margin: 10px; }
                                h1 { font-size: 1.5rem; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>üì∑ „Åõ„Åã„ÅÑ„Å¨„Çä„ÅàÔºàÂÜôÁúüÂø†ÂÆüÁâàÔºâ üé®</h1>
                        <img src="${generatedImageUrl}" alt="„Å¨„Çä„Åà">
                        <p style="margin-top: 20px; color: #8B4513;">ÂÜôÁúüÈÄö„Çä„ÅÆÊ≠£Á¢∫„Å™Á∑öÁîª„Å¨„Çä„Åà„Å†„ÇàÔºÅ</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            
            // ÁîªÂÉèË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´„Éó„É™„É≥„Éà
            const img = printWindow.document.querySelector('img');
            img.onload = () => {
                setTimeout(() => printWindow.print(), 500);
            };
        }

        function downloadColoring() {
            if (!generatedImageUrl) {
                showError('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„ÇãÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            // ÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            const link = document.createElement('a');
            link.href = generatedImageUrl;
            link.download = `„Åõ„Åã„ÅÑ„Å¨„Çä„Åà_ÂÜôÁúüÂø†ÂÆüÁâà_${new Date().getTime()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('ÂÜôÁúüÂø†ÂÆüÁâà„Å¨„Çä„Åà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ üì•');
        }

        function resetApp() {
            selectedFile = null;
            generatedImageUrl = null;
            fileInput.value = '';
            previewContainer.innerHTML = '';
            resultContainer.style.display = 'none';
            loadingContainer.style.display = 'none';
            generateButton.disabled = true;
            hideError();
            
            // „Éà„ÉÉ„Éó„Å´„Çπ„ÇØ„É≠„Éº„É´
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ÂàùÊúüÂåñ
        console.log('ÂÜôÁúüÂø†ÂÆüÁâàÔºàÁ≤æÂ∫¶95% + Á∑öÊ≠£Á¢∫ÊÄß90% + Á¥∞ÈÉ®‰øùÊåÅ85%ÔºâÂàùÊúüÂåñÂÆå‰∫Ü');
    </script>
</body>
</html>