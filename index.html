<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã›ã‹ã„ã¬ã‚Šãˆ - ä¿®æ­£ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFE4E1 50%, #FFF8DC 100%);
            min-height: 100vh;
            color: #8B4513;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            color: #FF69B4;
            text-shadow: 3px 3px 0px #FFB6C1;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #FF1493;
            margin-bottom: 20px;
        }

        .step-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);
            border: 4px solid #FFB6C1;
        }

        .step-title {
            font-size: 1.5rem;
            color: #FF69B4;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-area {
            border: 4px dashed #FFB6C1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #FFF8DC;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #FF69B4;
            background: #FFE4E1;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #FF1493;
            background: #FFB6C1;
        }

        .upload-icon {
            font-size: 4rem;
            color: #FF69B4;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.2rem;
            color: #8B4513;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .button {
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.6);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #FFB6C1;
            border-top: 5px solid #FF69B4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 100%;
            background-color: #FFE4E1;
            border-radius: 25px;
            padding: 3px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            border-radius: 25px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .result-container {
            display: none;
            text-align: center;
        }

        .print-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            margin-top: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #4169E1, #87CEEB);
            margin-top: 10px;
            margin-left: 10px;
        }

        .error-message {
            background: #FFE4E6;
            color: #D8000C;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #FFB6C1;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #E6FFE6;
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #90EE90;
            margin: 10px 0;
            display: none;
        }

        .instructions {
            background: #E6F3FF;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid #87CEEB;
        }

        .instructions h3 {
            color: #4682B4;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ol {
            color: #2F4F4F;
            font-size: 1.1rem;
            line-height: 1.6;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .status-text {
            font-size: 1.1rem;
            color: #FF69B4;
            margin-top: 10px;
        }

        /* APIã‚­ãƒ¼è¨­å®šç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .api-key-input {
            width: 70%;
            padding: 12px;
            border: 3px solid #FFB6C1;
            border-radius: 10px;
            font-size: 1rem;
            margin-right: 10px;
            font-family: monospace;
        }

        .api-key-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
        }

        .api-status {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: bold;
        }

        .api-status.success {
            background: #E6FFE6;
            color: #006400;
            border: 2px solid #90EE90;
        }

        .api-status.error {
            background: #FFE4E6;
            color: #D8000C;
            border: 2px solid #FFB6C1;
        }

        .api-help {
            margin-top: 15px;
        }

        .api-help summary {
            color: #FF69B4;
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }

        .api-help-content {
            margin-top: 10px;
            padding: 15px;
            background: #F0F8FF;
            border-radius: 10px;
            border: 2px solid #87CEEB;
        }

        @media (max-width: 600px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .step-container {
                padding: 20px;
            }

            .download-button {
                margin-left: 0;
                margin-top: 10px;
            }

            .api-key-input {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸŒˆ ã›ã‹ã„ã¬ã‚Šãˆ ğŸ¨</h1>
            <p class="subtitle">å†™çœŸã«å¿ å®Ÿã§ ã‹ã‚ã„ã„ ã¬ã‚Šãˆã‚’ ã¤ãã‚ã†ï¼</p>
        </div>

        <div class="instructions">
            <h3>ğŸ¯ ã¤ã‹ã„ã‹ãŸ</h3>
            <ol>
                <li>OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ã­</li>
                <li>ã™ããªå†™çœŸã‚’ ãˆã‚‰ã‚“ã§ã­</li>
                <li>ã€Œã¬ã‚Šãˆã«ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ ãŠã—ã¦ã­</li>
                <li>ã¡ã‚‡ã£ã¨ ã¾ã£ã¦ã¦ã­ï¼ˆ30ç§’ãã‚‰ã„ï¼‰</li>
                <li>ã§ãã‚ãŒã£ãŸã‚‰ ãƒ—ãƒªãƒ³ãƒˆã—ã¦ ã¬ã‚Šãˆã‚’ ãŸã®ã—ã‚‚ã†ï¼</li>
            </ol>
        </div>

        <!-- APIã‚­ãƒ¼è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="step-container" id="apiKeyContainer">
            <h2 class="step-title">ğŸ”‘ OpenAI APIã‚­ãƒ¼è¨­å®š</h2>
            <p style="color: #8B4513; margin-bottom: 15px; line-height: 1.6;">
                ã‚ˆã‚Šé«˜å“è³ªã§å†™çœŸã«å¿ å®Ÿãªç·šç”»ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ã€OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
                <small style="color: #666;">â€» APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“</small>
            </p>
            
            <div style="margin-bottom: 20px;">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-proj-...">
                <button onclick="setApiKey()" class="api-key-button">ğŸ”§ è¨­å®š</button>
            </div>
            
            <div id="apiKeyStatus" class="api-status"></div>
            
            <details class="api-help">
                <summary>ğŸ“– APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•</summary>
                <div class="api-help-content">
                    <ol style="color: #2F4F4F; line-height: 1.8;">
                        <li><a href="https://platform.openai.com/" target="_blank" style="color: #FF69B4; text-decoration: none; font-weight: bold;">OpenAI Platform</a> ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                        <li>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³</li>
                        <li>å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€ŒAPI Keysã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ã€ŒCreate new secret keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ï¼ˆsk-proj-ã§å§‹ã¾ã‚‹ï¼‰ã‚’ã‚³ãƒ”ãƒ¼</li>
                        <li>ä¸Šè¨˜ã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ã€Œè¨­å®šã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    </ol>
                    <p style="color: #D2691E; font-size: 0.9rem; margin-top: 15px; padding: 10px; background: #FFF8DC; border-radius: 5px;">
                        âš ï¸ <strong>é‡è¦:</strong> APIã‚­ãƒ¼ã¯å¤§åˆ‡ã«ç®¡ç†ã—ã¦ãã ã•ã„ã€‚ä»–äººã¨å…±æœ‰ã—ãªã„ã§ãã ã•ã„ã€‚<br>
                        ğŸ’° DALL-E 3ã®åˆ©ç”¨æ–™é‡‘: 1å›ã‚ãŸã‚Šç´„3-8å††ç¨‹åº¦
                    </p>
                </div>
            </details>
        </div>

        <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="step-container" id="uploadContainer" style="opacity: 0.5; pointer-events: none;">
            <h2 class="step-title">ğŸ“¸ å†™çœŸã‚’ ãˆã‚‰ã‚“ã§ã­</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“±</div>
                <div class="upload-text">ã“ã“ã‚’ ã‚¿ãƒƒãƒ—ã—ã¦ å†™çœŸã‚’ ãˆã‚‰ã‚“ã§ã­</div>
                <div style="font-size: 0.9rem; color: #666;">JPEGã€PNGã€HEICå¯¾å¿œ</div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div id="previewContainer" style="text-align: center; margin-top: 20px;">
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button" id="generateButton" disabled>
                    ğŸ¨ å¿ å®Ÿã§ ã‹ã‚ã„ã„ ã¬ã‚Šãˆã«ã™ã‚‹ï¼
                </button>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div class="loading" id="loadingContainer">
            <div class="spinner"></div>
            <p style="font-size: 1.2rem; color: #FF69B4; margin-bottom: 10px;">AI ãŒ å†™çœŸã«å¿ å®Ÿãª ã¬ã‚Šãˆã‚’ ã¤ãã£ã¦ã„ã‚‹ã‚ˆ... âœ¨</p>
            <div class="status-text" id="statusText">ã—ã‚ƒã—ã‚“ã‚’ ã‹ã„ã›ãã—ã¦ã„ã¾ã™...</div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div class="step-container result-container" id="resultContainer">
            <h2 class="step-title">ğŸ‰ ã§ãã‚ãŒã‚Šï¼</h2>
            <div id="resultImage">
                <!-- ç”Ÿæˆã•ã‚ŒãŸã¬ã‚ŠãˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
            <div>
                <button class="button print-button" onclick="printColoring()">
                    ğŸ–¨ï¸ ãƒ—ãƒªãƒ³ãƒˆã™ã‚‹
                </button>
                <button class="button download-button" onclick="downloadColoring()">
                    ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
            <button class="button" onclick="resetApp()" style="margin-top: 20px; background: linear-gradient(45deg, #FFA500, #FFD700);">
                ğŸ”„ ã‚ãŸã‚‰ã—ã ã¤ãã‚‹
            </button>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let selectedFile = null;
        let generatedImageUrl = null;
        let OPENAI_API_KEY = '';

        // DOMè¦ç´ ã®å–å¾—
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const generateButton = document.getElementById('generateButton');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultContainer = document.getElementById('resultContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statusText = document.getElementById('statusText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const uploadContainer = document.getElementById('uploadContainer');

        // APIã‚­ãƒ¼ç®¡ç†
        function setApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (!apiKey) {
                showApiKeyStatus('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showApiKeyStatus('æ­£ã—ã„APIã‚­ãƒ¼å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆsk-ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰', 'error');
                return;
            }
            
            OPENAI_API_KEY = apiKey;
            apiKeyInput.value = '';
            showApiKeyStatus('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸï¼ å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ ğŸ‰', 'success');
            
            uploadContainer.style.opacity = '1';
            uploadContainer.style.pointerEvents = 'auto';
        }

        function showApiKeyStatus(message, type) {
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
        }

        function checkApiKey() {
            if (!OPENAI_API_KEY) {
                showError('ã¾ãš OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ ğŸ”‘');
                return false;
            }
            return true;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            console.log('Selected file:', file.name, file.type, file.size);

            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (!file.type.startsWith('image/')) {
                showError('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰');
                return;
            }

            selectedFile = file;
            hideError();
            showPreview(file);
            showSuccess('å†™çœŸãŒé¸æŠã•ã‚Œã¾ã—ãŸï¼ ğŸŒŸ');
            generateButton.disabled = false;
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <img src="${e.target.result}" alt="é¸æŠã—ãŸç”»åƒ" class="image-preview">
                    <p style="color: #FF69B4; font-size: 1.1rem; margin-top: 10px;">
                        ã“ã®å†™çœŸã§ å¿ å®Ÿã§è¶…ã‹ã‚ã„ã„ ã¬ã‚Šãˆã‚’ ã¤ãã‚‹ã‚ˆï¼ ğŸ¨
                    </p>
                `;
            };
            reader.readAsDataURL(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        function updateProgress(percent, message) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            statusText.textContent = message;
        }

        // ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šã¬ã‚Šãˆç”Ÿæˆï¼ˆå®Œå…¨å¿ å®Ÿç‰ˆã«ç½®ãæ›ãˆï¼‰
        generateButton.addEventListener('click', generateColoring);

        // ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ç‰ˆã®generateColoringé–¢æ•°ï¼ˆå¿ å®Ÿ+ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡+ç°¡ç´ åŒ–ï¼‰

async function generateColoring() {
    console.log('=== ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ç‰ˆ DALL-E 3 ===');
    
    if (!checkApiKey()) return;
    
    if (!selectedFile) {
        showError('ã¾ãš å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ï¼');
        return;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    loadingContainer.style.display = 'block';
    generateButton.disabled = true;
    resultContainer.style.display = 'none';
    hideError();
    progressContainer.style.display = 'block';
    updateProgress(0, 'ã—ã‚ƒã—ã‚“ã‚’ ã‚ã£ã·ã‚ãƒ¼ã©ã—ã¦ã„ã¾ã™...');

    try {
        // ç”»åƒã‚’Base64ã«å¤‰æ›
        updateProgress(10, 'ã—ã‚ƒã—ã‚“ã‚’ ã˜ã‚…ã‚“ã³ã—ã¦ã„ã¾ã™...');
        const imageData = await fileToBase64(selectedFile);
        
        // === STAGE 1: æ§‹å›³ä¸­å¿ƒã®åˆ†æ ===
        updateProgress(25, 'AI ãŒ æ§‹å›³ã‚’ ã‹ã„ã›ãã—ã¦ã„ã¾ã™ï¼ˆæ®µéš1/3ï¼‰...');
        console.log('STAGE 1: Composition-focused analysis...');
        
        const compositionResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: `ã“ã®ç”»åƒã‚’ã¬ã‚Šãˆç”¨ã«åˆ†æã—ã¦ãã ã•ã„ã€‚è©³ç´°ã™ãã‚‹ãƒªã‚¢ãƒ«ãªæå†™ã§ã¯ãªãã€6æ­³å…å‘ã‘ã®åŸºæœ¬è¦ç´ ã«æ³¨ç›®ã—ã¦ãã ã•ã„ï¼š

ã€åŸºæœ¬æ§‹æˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«é‡è¦–ï¼‰ã€‘
- è¢«å†™ä½“ï¼šä½•ï¼Ÿï¼ˆäºº/å‹•ç‰©/ç‰©ä½“ï¼‰æ€§åˆ¥ãƒ»å¹´é½¢ãƒ»åŸºæœ¬ãƒãƒ¼ã‚º
- ä½ç½®ï¼šã©ã“ã«ã„ã‚‹ï¼Ÿï¼ˆä¸­å¤®/å·¦/å³ã€åº§ã‚‹/ç«‹ã¤ã®åŸºæœ¬å‹•ä½œï¼‰
- èƒŒæ™¯ï¼šä¸»è¦ãªè¦ç´ ã®ã¿ï¼ˆçª“/ãƒ‰ã‚¢/å®¶å…·ç­‰ã®å¤§ããªè¦ç´ ï¼‰
- ã‚µã‚¤ã‚ºæ„Ÿï¼šç”»é¢ã§ã®å¤§ãã•ï¼ˆå¤§/ä¸­/å°ï¼‰

ã€6æ­³å…å‘ã‘ç°¡ç´ åŒ–ãƒã‚¤ãƒ³ãƒˆã€‘
- è¤‡é›‘ãªæ¯›ä¸¦ã¿ã‚„æ¨¡æ§˜ã¯ã€Œã‚·ãƒ³ãƒ—ãƒ«ãªè‰²åˆ†ã‘ã€ã¨ã—ã¦è¨˜éŒ²
- ç´°ã‹ã„ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ã¯ã€ŒåŸºæœ¬å½¢çŠ¶ã€ã¨ã—ã¦è¨˜éŒ²
- èƒŒæ™¯ã¯ã€Œå¤§ããªè¦ç´ ã€ã®ã¿æŠ½å‡º

ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡åŒ–æ–¹é‡ã€‘
- å¯æ„›ã‚‰ã—ãã§ãã‚‹è¦ç´ ï¼ˆç›®ãƒ»è¡¨æƒ…ãƒ»ä½“å‹ï¼‰ã‚’ç‰¹å®š
- kawaiiåŒ–å¯èƒ½ãªéƒ¨åˆ†ã‚’è¨˜éŒ²

æ­£ç¢ºæ€§ã¯ä¿ã¡ã¤ã¤ã‚‚ã€6æ­³å…ãŒå¡—ã‚Šã‚„ã™ã„ã€ŒåŸºæœ¬è¦ç´ ã€ä¸­å¿ƒã§åˆ†æã—ã¦ãã ã•ã„ã€‚`
                            },
                            {
                                type: "image_url",
                                image_url: {
                                    url: imageData
                                }
                            }
                        ]
                    }
                ],
                max_tokens: 300
            }),
        });

        let basicAnalysis = "a cute subject";
        if (compositionResponse.ok) {
            const compositionResult = await compositionResponse.json();
            if (compositionResult.choices && compositionResult.choices[0]) {
                basicAnalysis = compositionResult.choices[0].message.content.trim();
                console.log('STAGE 1 - Basic analysis:', basicAnalysis);
            }
        }

        // === STAGE 2: ãƒãƒ©ãƒ³ã‚¹è¨­è¨ˆ ===
        updateProgress(45, 'AI ãŒ ãƒãƒ©ãƒ³ã‚¹ã‚’ è¨­è¨ˆã—ã¦ã„ã¾ã™ï¼ˆæ®µéš2/3ï¼‰...');
        console.log('STAGE 2: Balance design...');
        
        const balanceResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: `ä»¥ä¸‹ã®åˆ†æã‹ã‚‰ã€ã€Œå¿ å®Ÿ+ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡+ç°¡ç´ åŒ–ã€ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã£ãŸDALL-E 3ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ï¼š

ã€åˆ†æçµæœã€‘
${basicAnalysis}

ã€ãƒãƒ©ãƒ³ã‚¹è¨­è¨ˆæ–¹é‡ã€‘
ğŸ¯ å¿ å®Ÿæ€§ï¼ˆä¿æŒã™ã‚‹è¦ç´ ï¼‰ï¼š
- åŸºæœ¬æ§‹å›³ãƒ»è¢«å†™ä½“ã®ä½ç½®ãƒ»ã‚µã‚¤ã‚ºæ„Ÿ
- ä¸»è¦ãªèƒŒæ™¯è¦ç´ ï¼ˆçª“ãƒ»å®¶å…·ç­‰ï¼‰
- è¢«å†™ä½“ã®åŸºæœ¬ãƒãƒ¼ã‚ºãƒ»å‘ã
- æ€§åˆ¥ãƒ»å¹´é½¢ãƒ»äººæ•°

ğŸ¨ ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡åŒ–ï¼ˆå¯æ„›ãèª¿æ•´ï¼‰ï¼š
- ç›®ã‚’å¤§ããä¸¸ãï¼ˆkawaiiåŒ–ï¼‰
- ä½“å‹ã‚’ã‚„ã‚„ä¸¸ããƒ»ãµã‚“ã‚ã‚Š
- è¡¨æƒ…ã‚’å„ªã—ããƒ»ç¬‘é¡”ã«
- å…¨ä½“çš„ã«chibié¢¨å‘³

ğŸ“ ç°¡ç´ åŒ–ï¼ˆ6æ­³å…å‘ã‘ï¼‰ï¼š
- æ¯›ä¸¦ã¿ãƒ»æ¨¡æ§˜ã¯å¤§ããªè‰²åˆ†ã‘åŒºåŸŸã«
- ç´°ã‹ã„ãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ã¯å¤ªã„ç·šã®åŸºæœ¬å½¢çŠ¶ã«
- èƒŒæ™¯ã¯ä¸»è¦è¦ç´ ã®ã¿ã®ã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆ
- ç·šæ•°ã‚’æœ€å°é™ã«ï¼ˆå¤ªã„ç·šã§åŒºåˆ‡ã‚Šï¼‰

ã€å‡ºåŠ›å½¢å¼ã€‘
"A coloring book page showing [å¿ å®ŸãªåŸºæœ¬æ§‹å›³] with [kawaiiè¦ç´ ] simplified for ages 3-6"

ã€ç¦æ­¢äº‹é …ã€‘
- æ€§åˆ¥ãƒ»äººæ•°ãƒ»åŸºæœ¬ãƒãƒ¼ã‚ºã®å¤‰æ›´
- ä¸»è¦èƒŒæ™¯è¦ç´ ã®å‰Šé™¤
- éåº¦ã«ãƒªã‚¢ãƒ«ãªç·šç”»
- 6æ­³å…ã«è¤‡é›‘ã™ãã‚‹ç·š

ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸè¨­è¨ˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`
                            }
                        ]
                    }
                ],
                max_tokens: 200
            }),
        });

        let balancedDescription = basicAnalysis;
        if (balanceResponse.ok) {
            const balanceResult = await balanceResponse.json();
            if (balanceResult.choices && balanceResult.choices[0]) {
                balancedDescription = balanceResult.choices[0].message.content.trim();
                console.log('STAGE 2 - Balanced description:', balancedDescription);
            }
        }

        // === STAGE 3: æœ€çµ‚èª¿æ•´ ===
        updateProgress(60, 'AI ãŒ æœ€çµ‚èª¿æ•´ã‚’ ã—ã¦ã„ã¾ã™ï¼ˆæ®µéš3/3ï¼‰...');
        console.log('STAGE 3: Final adjustment...');
        
        const adjustmentResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: `ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã€Œå¿ å®Ÿã™ãã¦ãƒªã‚¢ãƒ«ã€ã€Œç°¡ç´ ã™ãã¦å¯æ„›ããªã„ã€ã€Œè¤‡é›‘ã™ãã¦6æ­³å…ã«ä¸é©åˆ‡ã€ã®ã„ãšã‚Œã‹ã«ãªã£ã¦ã„ãªã„ã‹èª¿æ•´ã—ã¦ãã ã•ã„ï¼š

ã€ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€‘
${balancedDescription}

ã€èª¿æ•´åŸºæº–ã€‘
âœ… é©åˆ‡ãªãƒãƒ©ãƒ³ã‚¹ï¼š
- å…ƒå†™çœŸã®åŸºæœ¬æ§‹å›³ã¯ä¿æŒ
- kawaiiè¦ç´ ã§å¯æ„›ã•ã‚¢ãƒƒãƒ—
- 6æ­³å…ãŒå¡—ã‚Šã‚„ã™ã„å¤ªã„ç·šãƒ»å¤§ããªåŒºåŸŸ

âŒ é¿ã‘ã‚‹ã¹ãçŠ¶æ…‹ï¼š
- ãƒªã‚¢ãƒ«ã™ãã‚‹æ¯›ä¸¦ã¿ãƒ»æ¨¡æ§˜ã®æå†™
- ç´°ã‹ã™ãã‚‹ç·šãƒ»å°ã•ã™ãã‚‹å¡—ã‚ŠåŒºåŸŸ
- å¯æ„›ã•ã®ãªã„ãŸã ã®ç·šç”»
- å…ƒå†™çœŸã¨å…¨ãé•ã†æ§‹å›³

ã€èª¿æ•´æŒ‡ç¤ºã€‘
å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ä¿®æ­£ç‰ˆã‚’å‡ºåŠ›
é©åˆ‡ãªå ´åˆã¯ã€Œèª¿æ•´å®Œäº†ï¼šãƒãƒ©ãƒ³ã‚¹è‰¯å¥½ã€

ç›®æ¨™ï¼š6æ­³å…ãŒå–œã‚“ã§å¡—ã‚Œã‚‹ã€å¯æ„›ãã¦å¿ å®Ÿãªã¬ã‚Šãˆ`
                            }
                        ]
                    }
                ],
                max_tokens: 250
            }),
        });

        let finalDescription = balancedDescription;
        if (adjustmentResponse.ok) {
            const adjustmentResult = await adjustmentResponse.json();
            if (adjustmentResult.choices && adjustmentResult.choices[0]) {
                const adjustmentOutput = adjustmentResult.choices[0].message.content.trim();
                console.log('STAGE 3 - Adjustment result:', adjustmentOutput);
                
                if (!adjustmentOutput.includes('èª¿æ•´å®Œäº†ï¼šãƒãƒ©ãƒ³ã‚¹è‰¯å¥½')) {
                    finalDescription = adjustmentOutput;
                    console.log('STAGE 3 - Applied balance adjustment');
                }
            }
        }

        updateProgress(75, 'ã‹ã‚ã„ãã¦ ã¬ã‚Šã‚„ã™ã„ ã¬ã‚Šãˆã‚’ ã¤ãã£ã¦ã„ã¾ã™... âœ¨');

        // === æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆãƒãƒ©ãƒ³ã‚¹é‡è¦–ï¼‰ ===
        let finalPrompt = `${finalDescription}

BALANCED COLORING BOOK REQUIREMENTS:

ğŸ¯ FAITHFULNESS (Preserve Core Elements):
- Basic composition and subject positioning from original
- Main background elements (windows, furniture, etc.)
- Subject's basic pose and orientation
- Number of people/animals and their genders

ğŸ¨ KAWAII DEFORMATION (Make it Cute for Kids):
- Enlarge eyes to be big and round (kawaii style)
- Make body proportions slightly rounder and softer
- Add gentle, friendly facial expressions
- Slight chibi-style proportions (bigger head ratio)
- Make everything look fluffy and huggable

ğŸ“ SIMPLIFICATION (Perfect for Ages 3-6):
- Convert complex fur patterns to simple color zones (2-3 large areas max)
- Use thick outlines (6-7px) with minimal internal lines
- Background elements as simple geometric shapes
- Large coloring areas - avoid tiny details or thin lines
- Maximum 5-6 main coloring sections per subject

STYLE BALANCE:
ğŸ–¤ Pure black outlines on pure white background
ğŸ‘¶ Chunky crayon-friendly thick lines
ğŸ˜Š Kawaii cute expressions while keeping original mood
ğŸ“ Simple geometric shapes replacing complex details
ğŸ  Background simplified to essential large elements only

FORBIDDEN (Maintain Balance):
- Overly realistic fur/hair textures (too complex for kids)
- Tiny intricate details or thin lines (too hard to color)
- Changing basic composition or subject identity
- Making it so simple it loses cuteness
- Adding colors or shading

GOAL: Create a coloring page that makes parents say "That's our photo made cute and simple!" while making kids say "I want to color this adorable picture!"

The result should be recognizably faithful to the original but transformed into an irresistibly cute, easy-to-color masterpiece perfect for young children.`;

        console.log('Generating balanced faithful coloring page...');

        // === DALL-E 3 ç”Ÿæˆ ===
        const dalle3Response = await fetch('https://api.openai.com/v1/images/generations', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: "dall-e-3",
                prompt: finalPrompt,
                n: 1,
                size: "1024x1024",
                quality: "standard"
            }),
        });

        if (!dalle3Response.ok) {
            const errorData = await dalle3Response.json();
            throw new Error(`API Error: ${dalle3Response.status} - ${errorData.error?.message}`);
        }

        const dalle3Result = await dalle3Response.json();

        if (dalle3Result.data && dalle3Result.data.length > 0) {
            updateProgress(100, 'ã‹ã‚ã„ãã¦ ã¬ã‚Šã‚„ã™ã„ ã¬ã‚ŠãˆãŒ ã§ãã¾ã—ãŸï¼');
            generatedImageUrl = dalle3Result.data[0].url;
            showResult(dalle3Result.data[0].url, 'DALL-E-3-Balanced', 'ğŸ¯ å¿ å®Ÿã§å¯æ„›ãã¦å¡—ã‚Šã‚„ã™ã„ ã¬ã‚Šãˆã§ã™ï¼');
        } else {
            throw new Error('No image generated');
        }

    } catch (error) {
        console.error('Balanced version error:', error);
        
        let errorMessage = error.message;
        if (error.message.includes('401')) {
            errorMessage = 'OpenAI APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ ğŸ”‘';
        } else if (error.message.includes('429')) {
            errorMessage = 'APIä½¿ç”¨é‡ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸ â°';
        } else if (error.message.includes('network')) {
            errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ ğŸŒ';
        }
        
        showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ ğŸ˜¢\n\n${errorMessage}\n\nã‚‚ã†ã„ã¡ã© ãŸã‚ã—ã¦ã­ï¼`);
    } finally {
        loadingContainer.style.display = 'none';
        generateButton.disabled = false;
        progressContainer.style.display = 'none';
    }
}

        function showResult(imageUrl, model, message) {
            document.getElementById('resultImage').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #FF69B4; font-size: 1.3rem; margin-bottom: 15px;">ğŸ‰ è¶…ã‹ã‚ã„ã„ ã¬ã‚ŠãˆãŒ ã§ããŸã‚ˆï¼</p>
                    <p style="color: #FF69B4; font-size: 1rem; margin-bottom: 10px;">${message}</p>
                    <img src="${imageUrl}" alt="ç”Ÿæˆã•ã‚ŒãŸã¬ã‚Šãˆ" style="max-width: 100%; max-height: 500px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 3px solid #FFB6C1;">
                    <p style="color: #8B4513; font-size: 1rem; margin-top: 10px;">
                        å†™çœŸã‹ã‚‰ä½œã£ãŸ ã‚ªãƒªã‚¸ãƒŠãƒ« ã¬ã‚Šãˆã ã‚ˆï¼ ğŸŒˆ<br>
                        <small>(${model}ã§ ã›ã„ã›ã„)</small>
                    </p>
                </div>
            `;
            
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function printColoring() {
            if (!generatedImageUrl) {
                showError('ãƒ—ãƒªãƒ³ãƒˆã™ã‚‹ ãŒãã†ãŒ ã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>ã›ã‹ã„ã¬ã‚Šãˆ - ãƒ—ãƒªãƒ³ãƒˆ</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                text-align: center; 
                                font-family: 'Comic Sans MS', Arial, sans-serif;
                            }
                            img {
                                max-height: 90vh;
                                border: 2px solid #000;
                            }
                            h1 {
                                color: #FF69B4;
                                font-size: 2rem;
                                margin-bottom: 20px;
                            }
                            @media print {
                                body { margin: 10px; }
                                h1 { font-size: 1.5rem; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>ğŸŒˆ ã›ã‹ã„ã¬ã‚Šãˆ ğŸ¨</h1>
                        <img src="${generatedImageUrl}" alt="ã¬ã‚Šãˆ">
                        <p style="margin-top: 20px; color: #8B4513;">ãŸã®ã—ã ã¬ã£ã¦ã­ï¼</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            
            // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒ—ãƒªãƒ³ãƒˆ
            const img = printWindow.document.querySelector('img');
            img.onload = () => {
                setTimeout(() => printWindow.print(), 500);
            };
        }

        function downloadColoring() {
            if (!generatedImageUrl) {
                showError('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ ãŒãã†ãŒ ã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const link = document.createElement('a');
            link.href = generatedImageUrl;
            link.download = `ã›ã‹ã„ã¬ã‚Šãˆ_${new Date().getTime()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('ã¬ã‚Šãˆã‚’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ ğŸ“¥');
        }

        function resetApp() {
            selectedFile = null;
            generatedImageUrl = null;
            fileInput.value = '';
            previewContainer.innerHTML = '';
            resultContainer.style.display = 'none';
            loadingContainer.style.display = 'none';
            generateButton.disabled = true;
            hideError();
            
            // ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åˆæœŸåŒ–
        console.log('Fixed simple version initialized');
    </script>
</body>
</html>