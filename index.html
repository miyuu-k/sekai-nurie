<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã›ã‹ã„ã¬ã‚Šãˆ â€“ ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header>
    <label for="uploadInput" class="upload-btn">ã—ã‚ƒã—ã‚“ã‚’ã‚ã£ã·ã™ã‚‹</label>
    <input type="file" id="uploadInput" accept="image/*" multiple />
  </header>

  <!-- â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main>
    <div id="gallery" class="gallery"></div>
    <div id="pagination" class="pagination"></div>
  </main>

  <!-- â”€â”€ ACTION BUTTONS (å›ºå®š) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="convert-wrap">
    <button id="convertBtn" class="convert-btn" disabled>
      ãˆã‚‰ã‚“ã ã—ã‚ƒã—ã‚“ã‚’ã¬ã‚Šãˆã«ã™ã‚‹
    </button>
    <button id="makeBtn" class="make-btn">
      ã¬ã‚Šãˆã‚’ã¤ãã‚‹
    </button>
    <button id="clearBtn" class="clear-btn">
      ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»
    </button>
  </div>

  <!-- â”€â”€ LOADING OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="loading" class="loading">
    <p>ã¬ã‚Šãˆã•ãã›ã„ã¡ã‚…ã†<span>â€¦</span></p>
    <button id="cancelBtn" class="cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <!-- â”€â”€ SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script>
  /* ===== DOM ===== */
  const uploadInput = document.getElementById("uploadInput");
  const galleryEl   = document.getElementById("gallery");
  const paginationEl= document.getElementById("pagination");
  const convertBtn  = document.getElementById("convertBtn");
  const makeBtn     = document.getElementById("makeBtn");
  const clearBtn    = document.getElementById("clearBtn");
  const loadingEl   = document.getElementById("loading");
  const cancelBtn   = document.getElementById("cancelBtn");

  /* ===== STATE ===== */
  let images=[]; let currentPage=1;
  const perPage=9, KEY="sekai-enogu-images-v1";

  /* === INIT === */
  loadImages(); renderAll();

  /* === Upload & resize === */
  uploadInput.onchange=e=>{
    const files=[...(e.target.files||[])];
    if(!files.length) return;
    Promise.all(files.map(f=>resizeToBase64(f,600,0.7)
      .then(data=>({data,name:f.name,selected:false}))))
      .then(list=>{
        images=images.concat(list); saveImages();
        currentPage=1; renderAll(); uploadInput.value="";
      });
  };
  /* ç”»åƒã‚’ 600px æ­£æ–¹å½¢ PNG ã«ç¸®å°ã—ã¦ Base64 æ–‡å­—åˆ—ã§è¿”ã™ */
function resizeToBase64(file, max = 600) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      /* ç¸¦æ¨ªã©ã¡ã‚‰ã‹é•·ã„æ–¹ã‚’ max ã«åˆã‚ã›ã‚‹ */
      const scale = Math.min(max / img.width, max / img.height, 1);
      const w = img.width * scale;
      const h = img.height * scale;

      /* æ­£æ–¹å½¢ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œã‚Šä¸­å¤®ã«é…ç½® */
      const cv = document.createElement("canvas");
      const side = Math.max(w, h);          // ä¸€ç•ªé•·ã„è¾ºï¼ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸€è¾º
      cv.width = cv.height = side;
      const ctx = cv.getContext("2d");
      ctx.drawImage(img, (side - w) / 2, (side - h) / 2, w, h);

      /* PNG å‡ºåŠ›ï¼ˆquality æŒ‡å®šã¯ä¸è¦ï¼‰ */
      resolve(cv.toDataURL("image/png"));
    };
    img.src = URL.createObjectURL(file);
  });
}

  /* === localStorage === */
  function saveImages(){try{localStorage.setItem(KEY,JSON.stringify(images));}
    catch{alert("ä¿å­˜å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚ã„ãã¤ã‹ç”»åƒã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚")}}
  function loadImages(){const j=localStorage.getItem(KEY);if(j) images=JSON.parse(j);}  

  /* === Gallery === */
  function renderGallery(){
    galleryEl.innerHTML="";
    const start=(currentPage-1)*perPage;
    images.slice(start,start+perPage).forEach((img,i)=>{
      const w=document.createElement("div");
      w.className="thumb"+(img.selected?" selected":"");
      w.onclick=()=>toggle(start+i);
      w.innerHTML=`<img src="${img.data}" alt="${img.name}" loading="lazy">\n                   <span class="check">âœ“</span>`;
      galleryEl.appendChild(w);
    });
  }
  function toggle(idx){images[idx].selected=!images[idx].selected;saveImages();renderGallery();updateButtons();}

  /* === Pagination === */
  function renderPagination(){
    paginationEl.innerHTML="";
    const tot=Math.max(1,Math.ceil(images.length/perPage));
    const mk=(t,d,cb)=>{const b=document.createElement("button");b.textContent=t;b.disabled=d;b.onclick=cb;return b};
    paginationEl.append(mk("<",currentPage===1,()=>{currentPage--;renderAll()}));
    for(let i=1;i<=tot;i++){
      const b=mk(i,false,()=>{currentPage=i;renderAll()});
      if(i===currentPage) b.classList.add("active");
      paginationEl.append(b);
    }
    paginationEl.append(mk(">",currentPage===tot,()=>{currentPage++;renderAll()}));
  }

  /* === Buttons === */
  function updateButtons(){
    convertBtn.disabled=!images.some(i=>i.selected);
  }

  // ---------- â˜… ã¬ã‚ŠãˆåŒ–å‡¦ç†ã‚’è¿½åŠ  ----------
  convertBtn.onclick = async () => {
    if (convertBtn.disabled) return;
    const targets = images.filter(i => i.selected);
    if (!targets.length) return;

    showLoading();
    try {
      const fd = new FormData();
      fd.append("file", dataURLtoBlob(targets[0].data), "upload.jpg");
const payload = { dataURL: targets[0].data };

const r = await fetch("/.netlify/functions/lineart-background", {
  method: "POST",                                 // â† å¿…ãš POST
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload)
});

      if (!r.ok) throw new Error("API Error");
      const { url } = await r.json();

      window.open(url, "_blank"); // åˆ¥ã‚¿ãƒ–ã§ç·šç”»è¡¨ç¤º
    } catch (e) {
      console.error(e);
      alert("ã¬ã‚ŠãˆåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸğŸ’¦");
    } finally {
      hideLoading();
    }
  };

  makeBtn.onclick   =()=>alert("ã¬ã‚Šãˆã‚’ä½œã‚‹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸï¼");
  clearBtn.onclick  =()=>{ if(confirm("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){localStorage.removeItem(KEY);images=[];renderAll();} };

  /* === Loading === */
  function showLoading(){ loadingEl.classList.add("show"); convertBtn.disabled=true; }
  function hideLoading(){ loadingEl.classList.remove("show"); updateButtons(); }
  cancelBtn.onclick=hideLoading;

  /* === Helpers === */
  function renderAll(){ renderGallery(); renderPagination(); updateButtons(); }

  // DataURL â†’ Blob å¤‰æ›
  function dataURLtoBlob(dataURL){
    const [meta,base64]=dataURL.split(",");
    const mime=meta.match(/:(.*?);/)[1];
    const bin=atob(base64); const len=bin.length;
    const u8=new Uint8Array(len);
    for(let i=0;i<len;i++) u8[i]=bin.charCodeAt(i);
    return new Blob([u8],{type:mime});
  }
  </script>
</body>
</html>