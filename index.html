<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>せかいぬりえ - 2段階処理版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFE4E1 50%, #FFF8DC 100%);
            min-height: 100vh;
            color: #8B4513;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            color: #FF69B4;
            text-shadow: 3px 3px 0px #FFB6C1;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #FF1493;
            margin-bottom: 20px;
        }

        .step-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);
            border: 4px solid #FFB6C1;
        }

        .step-title {
            font-size: 1.5rem;
            color: #FF69B4;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-area {
            border: 4px dashed #FFB6C1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #FFF8DC;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #FF69B4;
            background: #FFE4E1;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #FF1493;
            background: #FFB6C1;
        }

        .upload-icon {
            font-size: 4rem;
            color: #FF69B4;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.2rem;
            color: #8B4513;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .button {
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.6);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #FFB6C1;
            border-top: 5px solid #FF69B4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 100%;
            background-color: #FFE4E1;
            border-radius: 25px;
            padding: 3px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            border-radius: 25px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .result-container {
            display: none;
            text-align: center;
        }

        .print-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            margin-top: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #4169E1, #87CEEB);
            margin-top: 10px;
            margin-left: 10px;
        }

        .error-message {
            background: #FFE4E6;
            color: #D8000C;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #FFB6C1;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #E6FFE6;
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #90EE90;
            margin: 10px 0;
            display: none;
        }

        .instructions {
            background: #E6F3FF;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid #87CEEB;
        }

        .instructions h3 {
            color: #4682B4;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ol {
            color: #2F4F4F;
            font-size: 1.1rem;
            line-height: 1.6;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .status-text {
            font-size: 1.1rem;
            color: #FF69B4;
            margin-top: 10px;
        }

        /* APIキー設定用スタイル */
        .api-key-input {
            width: 70%;
            padding: 12px;
            border: 3px solid #FFB6C1;
            border-radius: 10px;
            font-size: 1rem;
            margin-right: 10px;
            font-family: monospace;
        }

        .api-key-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
        }

        .api-status {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: bold;
        }

        .api-status.success {
            background: #E6FFE6;
            color: #006400;
            border: 2px solid #90EE90;
        }

        .api-status.error {
            background: #FFE4E6;
            color: #D8000C;
            border: 2px solid #FFB6C1;
        }

        .api-help {
            margin-top: 15px;
        }

        .api-help summary {
            color: #FF69B4;
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }

        .api-help-content {
            margin-top: 10px;
            padding: 15px;
            background: #F0F8FF;
            border-radius: 10px;
            border: 2px solid #87CEEB;
        }

        /* 処理ステップ表示 */
        .process-steps {
            background: #F0F8FF;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #87CEEB;
        }

        .process-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            border-radius: 8px;
        }

        .process-step.active {
            background: #FFE4E1;
            border: 2px solid #FF69B4;
        }

        .process-step.completed {
            background: #E6FFE6;
            border: 2px solid #90EE90;
        }

        .step-icon {
            font-size: 1.5rem;
            margin-right: 10px;
            min-width: 30px;
        }

        .step-text {
            flex: 1;
            font-size: 1rem;
            color: #2F4F4F;
        }

        /* 結果比較表示 */
        .result-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .comparison-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #FFB6C1;
        }

        .comparison-item h4 {
            color: #FF69B4;
            margin-bottom: 10px;
        }

        .comparison-item img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        @media (max-width: 600px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .step-container {
                padding: 20px;
            }

            .download-button {
                margin-left: 0;
                margin-top: 10px;
            }

            .api-key-input {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }

            .result-comparison {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">🌈 せかいぬりえ 🎨</h1>
            <p class="subtitle">写真を段階的にイラスト化して、忠実で塗りやすいぬりえを作ろう！</p>
            
            <!-- 処理ステップ表示 -->
            <div class="process-steps">
                <h4 style="color: #4682B4; margin-bottom: 10px;">🔄 2段階処理フロー</h4>
                <div class="process-step" id="step1">
                    <div class="step-icon">📸</div>
                    <div class="step-text">ステップ1: 写真をかわいいイラストに変換</div>
                </div>
                <div class="process-step" id="step2">
                    <div class="step-icon">🎨</div>
                    <div class="step-text">ステップ2: イラストを白黒ぬりえに変換</div>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3>🎯 つかいかた</h3>
            <ol>
                <li>OpenAI APIキーを設定してね</li>
                <li>すきな写真を えらんでね</li>
                <li>「2段階でぬりえにする」ボタンを おしてね</li>
                <li>ちょっと まっててね（60-90秒くらい - 2段階処理）</li>
                <li>できあがったら プリントして ぬりえを たのしもう！</li>
            </ol>
        </div>

        <!-- APIキー設定セクション -->
        <div class="step-container" id="apiKeyContainer">
            <h2 class="step-title">🔑 OpenAI APIキー設定</h2>
            <p style="color: #8B4513; margin-bottom: 15px; line-height: 1.6;">
                写真を段階的に処理して、忠実で塗りやすいぬりえを2段階で生成します。<br>
                <small style="color: #666;">※ APIキーはブラウザにのみ保存され、外部に送信されません</small>
            </p>
            
            <div style="margin-bottom: 20px;">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-proj-...">
                <button onclick="setApiKey()" class="api-key-button">🔧 設定</button>
            </div>
            
            <div id="apiKeyStatus" class="api-status"></div>
            
            <details class="api-help">
                <summary>📖 APIキーの取得方法</summary>
                <div class="api-help-content">
                    <ol style="color: #2F4F4F; line-height: 1.8;">
                        <li><a href="https://platform.openai.com/" target="_blank" style="color: #FF69B4; text-decoration: none; font-weight: bold;">OpenAI Platform</a> にアクセス</li>
                        <li>アカウントを作成・ログイン</li>
                        <li>左メニューの「API Keys」をクリック</li>
                        <li>「Create new secret key」をクリック</li>
                        <li>生成されたキー（sk-proj-で始まる）をコピー</li>
                        <li>上記の入力欄に貼り付けて「設定」をクリック</li>
                    </ol>
                    <p style="color: #D2691E; font-size: 0.9rem; margin-top: 15px; padding: 10px; background: #FFF8DC; border-radius: 5px;">
                        ⚠️ <strong>重要:</strong> APIキーは大切に管理してください。他人と共有しないでください。<br>
                        💰 DALL-E 2の利用料金: 1回あたり約4-6円程度（2段階処理）
                    </p>
                </div>
            </details>
        </div>

        <!-- 画像アップロードセクション -->
        <div class="step-container" id="uploadContainer" style="opacity: 0.5; pointer-events: none;">
            <h2 class="step-title">📸 写真を えらんでね</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📱</div>
                <div class="upload-text">ここを タップして 写真を えらんでね</div>
                <div style="font-size: 0.9rem; color: #666;">JPEG、PNG、HEIC対応</div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div id="previewContainer" style="text-align: center; margin-top: 20px;">
                <!-- プレビュー画像がここに表示される -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button" id="generateButton" disabled>
                    🔄 2段階でぬりえにする！
                </button>
            </div>
        </div>

        <!-- ローディング表示 -->
        <div class="loading" id="loadingContainer">
            <div class="spinner"></div>
            <p style="font-size: 1.2rem; color: #FF69B4; margin-bottom: 10px;">AI が 2段階で忠実なぬりえを つくっているよ... ✨</p>
            <div class="status-text" id="statusText">写真をアップロードしています...</div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <!-- 結果表示 -->
        <div class="step-container result-container" id="resultContainer">
            <h2 class="step-title">🎉 2段階処理完了！</h2>
            
            <div class="result-comparison" id="resultComparison">
                <!-- ステップ1とステップ2の結果がここに表示される -->
            </div>
            
            <div id="resultImage">
                <!-- 最終的なぬりえがここに表示される -->
            </div>
            <div>
                <button class="button print-button" onclick="printColoring()">
                    🖨️ プリントする
                </button>
                <button class="button download-button" onclick="downloadColoring()">
                    💾 ダウンロード
                </button>
            </div>
            <button class="button" onclick="resetApp()" style="margin-top: 20px; background: linear-gradient(45deg, #FFA500, #FFD700);">
                🔄 あたらしく つくる
            </button>
        </div>
    </div>

    <script>
        // グローバル変数
        let selectedFile = null;
        let generatedImageUrl = null;
        let illustrationImageUrl = null;
        let OPENAI_API_KEY = '';

        // DOM要素の取得
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const generateButton = document.getElementById('generateButton');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultContainer = document.getElementById('resultContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statusText = document.getElementById('statusText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const uploadContainer = document.getElementById('uploadContainer');

        // APIキー管理
        function setApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (!apiKey) {
                showApiKeyStatus('APIキーを入力してください', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showApiKeyStatus('正しいAPIキー形式ではありません（sk-で始まる必要があります）', 'error');
                return;
            }
            
            OPENAI_API_KEY = apiKey;
            apiKeyInput.value = '';
            showApiKeyStatus('APIキーが設定されました！ 写真を選択してください 🎉', 'success');
            
            uploadContainer.style.opacity = '1';
            uploadContainer.style.pointerEvents = 'auto';
        }

        function showApiKeyStatus(message, type) {
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
        }

        function checkApiKey() {
            if (!OPENAI_API_KEY) {
                showError('まず OpenAI APIキーを設定してください 🔑');
                return false;
            }
            return true;
        }

        // ファイルアップロード関連
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            console.log('Selected file:', file.name, file.type, file.size);

            // ファイル形式チェック
            if (!file.type.startsWith('image/')) {
                showError('画像ファイルを選択してください');
                return;
            }

            // ファイルサイズチェック (4MB - DALL-E 2の制限)
            if (file.size > 4 * 1024 * 1024) {
                showError('ファイルが大きすぎます（4MB以下にしてください）');
                return;
            }

            selectedFile = file;
            hideError();
            showPreview(file);
            showSuccess('写真が選択されました！ 🌟');
            generateButton.disabled = false;
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <img src="${e.target.result}" alt="選択した画像" class="image-preview">
                    <p style="color: #FF69B4; font-size: 1.1rem; margin-top: 10px;">
                        この写真を2段階でぬりえにするよ！ 🔄
                    </p>
                `;
            };
            reader.readAsDataURL(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // プログレスバー更新
        function updateProgress(percent, message) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            statusText.textContent = message;
        }

        // ステップ表示の更新
        function updateStepStatus(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `process-step ${status}`;
        }

        // メイン処理：2段階ぬりえ生成
        generateButton.addEventListener('click', generateTwoStageColoring);

        async function generateTwoStageColoring() {
            console.log('=== 2段階処理開始 ===');
            
            if (!checkApiKey()) return;
            
            if (!selectedFile) {
                showError('まず 写真を選択してください！');
                return;
            }

            // ローディング表示
            loadingContainer.style.display = 'block';
            generateButton.disabled = true;
            resultContainer.style.display = 'none';
            hideError();
            progressContainer.style.display = 'block';
            updateProgress(0, '写真をアップロードしています...');

            try {
                // === STAGE 1: 写真をかわいいイラストに変換 ===
                updateProgress(10, 'ステップ1: 写真をかわいいイラストに変換しています... 🎨');
                updateStepStatus(1, 'active');
                console.log('STAGE 1: 写真→イラスト変換...');

                const illustrationResponse = await fetch('https://api.openai.com/v1/images/edits', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                    },
                    body: createFormData(selectedFile, 
                        'Transform this photo into a cute, kawaii-style illustration. Make it colorful, friendly, and charming while keeping the main subject and composition. The style should be anime/manga inspired with soft colors, big expressive eyes if there are characters, and an overall adorable aesthetic. Maintain the original pose and setting but enhance the cuteness factor.'
                    )
                });

                if (!illustrationResponse.ok) {
                    const errorData = await illustrationResponse.json();
                    throw new Error(`Stage 1 API Error: ${illustrationResponse.status} - ${errorData.error?.message}`);
                }

                const illustrationResult = await illustrationResponse.json();
                
                if (!illustrationResult.data || illustrationResult.data.length === 0) {
                    throw new Error('イラストが生成されませんでした');
                }

                illustrationImageUrl = illustrationResult.data[0].url;
                updateProgress(50, 'ステップ1完了！ ステップ2: イラストを白黒ぬりえに変換しています... ✏️');
                updateStepStatus(1, 'completed');
                updateStepStatus(2, 'active');

                // イラスト画像をダウンロードしてファイル化
                const illustrationBlob = await fetch(illustrationImageUrl).then(r => r.blob());
                const illustrationFile = new File([illustrationBlob], 'illustration.png', { type: 'image/png' });

                // === STAGE 2: イラストを白黒ぬりえに変換 ===
                console.log('STAGE 2: イラスト→ぬりえ変換...');

                const coloringResponse = await fetch('https://api.openai.com/v1/images/edits', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                    },
                    body: createFormData(illustrationFile, 
                        'Convert this colorful illustration into a black and white coloring book page. Create clean, thick black outlines (3-4px thick) with no fill colors or shading. The lines should be simple enough for children aged 4-8 to color easily. Remove all colors and gradients, keeping only the essential outlines and shapes. Make sure there are large, clear areas perfect for coloring. Pure white background with bold black lines only.'
                    )
                });

                if (!coloringResponse.ok) {
                    const errorData = await coloringResponse.json();
                    throw new Error(`Stage 2 API Error: ${coloringResponse.status} - ${errorData.error?.message}`);
                }

                const coloringResult = await coloringResponse.json();

                if (!coloringResult.data || coloringResult.data.length === 0) {
                    throw new Error('ぬりえが生成されませんでした');
                }

                generatedImageUrl = coloringResult.data[0].url;
                updateProgress(100, '2段階処理完了！忠実なぬりえができました！');
                updateStepStatus(2, 'completed');

                showTwoStageResult(illustrationImageUrl, generatedImageUrl);

            } catch (error) {
                console.error('2段階処理エラー:', error);
                
                let errorMessage = error.message;
                if (error.message.includes('401')) {
                    errorMessage = 'OpenAI APIキーが正しくありません 🔑';
                } else if (error.message.includes('429')) {
                    errorMessage = 'API使用量の上限に達しました ⏰';
                } else if (error.message.includes('network')) {
                    errorMessage = 'ネットワーク接続に問題があります 🌐';
                }
                
                showError(`エラーが発生しました 😢\n\n${errorMessage}\n\nもう一度お試しください！`);
            } finally {
                loadingContainer.style.display = 'none';
                generateButton.disabled = false;
                progressContainer.style.display = 'none';
                updateStepStatus(1, '');
                updateStepStatus(2, '');
            }
        }

        // FormData作成ヘルパー関数
        function createFormData(imageFile, prompt) {
            const formData = new FormData();
            formData.append('image', imageFile);
            formData.append('prompt', prompt);
            formData.append('n', '1');
            formData.append('size', '1024x1024');
            return formData;
        }

        // 2段階結果表示
        function showTwoStageResult(illustrationUrl, coloringUrl) {
            // 比較表示
            document.getElementById('resultComparison').innerHTML = `
                <div class="comparison-item">
                    <h4>📸➡️🎨 ステップ1: イラスト化</h4>
                    <img src="${illustrationUrl}" alt="イラスト版">
                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">写真をかわいいイラストに変換</p>
                </div>
                <div class="comparison-item">
                    <h4>🎨➡️✏️ ステップ2: ぬりえ化</h4>
                    <img src="${coloringUrl}" alt="ぬりえ版">
                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">イラストを白黒ぬりえに変換</p>
                </div>
            `;

            // 最終結果表示
            document.getElementById('resultImage').innerHTML = `
                <div style="margin-top: 30px;">
                    <h3 style="color: #FF69B4; font-size: 1.4rem; margin-bottom: 15px;">🎉 完成したぬりえ</h3>
                    <img src="${coloringUrl}" alt="完成したぬりえ" style="max-width: 100%; max-height: 400px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 3px solid #FFB6C1;">
                    <p style="color: #8B4513; font-size: 1rem; margin-top: 15px; line-height: 1.6;">
                        2段階処理で写真の特徴を保ちながら、塗りやすいぬりえができました！ 🌈<br>
                        <small style="color: #666;">✨ 写真→イラスト→ぬりえの順番で忠実性を高めました</small>
                    </p>
                    
                    <!-- 処理結果の特徴 -->
                    <div style="background: #F0F8FF; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid #87CEEB;">
                        <h4 style="color: #4682B4; margin-bottom: 10px;">📊 2段階処理の効果</h4>
                        <ul style="text-align: left; color: #2F4F4F; line-height: 1.6;">
                            <li><strong>忠実性向上:</strong> 写真の構図・特徴を段階的に保持</li>
                            <li><strong>可愛さ追加:</strong> イラスト化でkawaii要素をプラス</li>
                            <li><strong>塗りやすさ:</strong> 最適化された太い線と大きな領域</li>
                            <li><strong>自然な仕上がり:</strong> 急激な変換を避けてスムーズに</li>
                        </ul>
                    </div>
                </div>
            `;
            
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function printColoring() {
            if (!generatedImageUrl) {
                showError('プリントする画像がありません');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>せかいぬりえ - 2段階処理版プリント</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                text-align: center; 
                                font-family: 'Comic Sans MS', Arial, sans-serif;
                            }
                            img {
                                max-height: 90vh;
                                border: 2px solid #000;
                            }
                            h1 {
                                color: #FF69B4;
                                font-size: 2rem;
                                margin-bottom: 20px;
                            }
                            @media print {
                                body { margin: 10px; }
                                h1 { font-size: 1.5rem; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>🌈 せかいぬりえ（2段階処理版） 🎨</h1>
                        <img src="${generatedImageUrl}" alt="ぬりえ">
                        <p style="margin-top: 20px; color: #8B4513;">写真→イラスト→ぬりえの2段階で作りました！</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            
            // 画像読み込み完了後にプリント
            const img = printWindow.document.querySelector('img');
            img.onload = () => {
                setTimeout(() => printWindow.print(), 500);
            };
        }

        function downloadColoring() {
            if (!generatedImageUrl) {
                showError('ダウンロードする画像がありません');
                return;
            }

            // 画像をダウンロード
            const link = document.createElement('a');
            link.href = generatedImageUrl;
            link.download = `せかいぬりえ_2段階処理版_${new Date().getTime()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('2段階処理版ぬりえをダウンロードしました！ 📥');
        }

        function resetApp() {
            selectedFile = null;
            generatedImageUrl = null;
            illustrationImageUrl = null;
            fileInput.value = '';
            previewContainer.innerHTML = '';
            resultContainer.style.display = 'none';
            loadingContainer.style.display = 'none';
            generateButton.disabled = true;
            hideError();
            
            // ステップ表示リセット
            updateStepStatus(1, '');
            updateStepStatus(2, '');
            
            // トップにスクロール
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 初期化
        console.log('2段階処理版（写真→イラスト→ぬりえ）初期化完了');
    </script>
</body>
</html>