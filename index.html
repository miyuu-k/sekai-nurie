<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>せかいぬりえ</title>

  <!-- 🎨 既存のスタイルはそのまま -->
  <style>
    /* （★★ ここはご提示のスタイルを丸ごと残しています ★★） */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Comic Sans MS',cursive,sans-serif;background:linear-gradient(135deg,#FFB6C1 0%,#FFE4E1 50%,#FFF8DC 100%);min-height:100vh;color:#8B4513}
    .container{max-width:800px;margin:0 auto;padding:20px}
    .header{text-align:center;margin-bottom:30px}
    .title{font-size:3rem;color:#FF69B4;text-shadow:3px 3px 0#FFB6C1;margin-bottom:10px;animation:bounce 2s infinite}
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
    .subtitle{font-size:1.2rem;color:#FF1493;margin-bottom:20px}
    .step-container{background:#fff;border-radius:20px;padding:30px;margin-bottom:20px;box-shadow:0 8px 32px rgba(255,105,180,.3);border:4px solid #FFB6C1}
    .step-title{font-size:1.5rem;color:#FF69B4;margin-bottom:20px;text-align:center}
    .upload-area{border:4px dashed #FFB6C1;border-radius:15px;padding:40px;text-align:center;background:#FFF8DC;cursor:pointer;transition:.3s;position:relative;overflow:hidden}
    .upload-area:hover{border-color:#FF69B4;background:#FFE4E1;transform:scale(1.02)}
    .upload-area.dragover{border-color:#FF1493;background:#FFB6C1}
    .upload-icon{font-size:4rem;color:#FF69B4;margin-bottom:15px;animation:float 3s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    .upload-text{font-size:1.2rem;color:#8B4513;margin-bottom:10px}
    .file-input{display:none}
    .image-preview{max-width:100%;max-height:300px;border-radius:15px;margin:20px 0;box-shadow:0 4px 20px rgba(0,0,0,.1)}
    .button{background:linear-gradient(45deg,#FF69B4,#FFB6C1);color:#fff;border:none;padding:15px 30px;font-size:1.2rem;border-radius:25px;cursor:pointer;box-shadow:0 6px 20px rgba(255,105,180,.4);transition:.3s;font-family:inherit;font-weight:bold;text-transform:uppercase;letter-spacing:1px}
    .button:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(255,105,180,.6)}
    .button:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .loading{display:none;text-align:center;padding:30px}
    .spinner{width:50px;height:50px;border:5px solid #FFB6C1;border-top:5px solid #FF69B4;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .result-container{display:none;text-align:center}
    .print-button{background:linear-gradient(45deg,#32CD32,#98FB98);margin-top:20px}
    .error-message{background:#FFE4E6;color:#D8000C;padding:15px;border-radius:10px;border:2px solid #FFB6C1;margin:10px 0;display:none}
    .instructions{background:#E6F3FF;padding:20px;border-radius:15px;margin-bottom:20px;border:3px solid #87CEEB}
    .instructions h3{color:#4682B4;margin-bottom:15px;font-size:1.3rem}
    .instructions ol{color:#2F4F4F;font-size:1.1rem;line-height:1.6;padding-left:20px}
    .instructions li{margin-bottom:8px}
    @media(max-width:600px){.title{font-size:2rem}.container{padding:10px}.step-container{padding:20px}}
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1 class="title">🌈 せかいぬりえ 🎨</h1>
      <p class="subtitle">じぶんだけの オリジナル ぬりえを つくろう！</p>
    </div>

    <div class="instructions">
      <h3>🎯 つかいかた</h3>
      <ol>
        <li>すきなものの しゃしんを えらんでね</li>
        <li>「ぬりえにする」ボタンを おしてね</li>
        <li>できあがったら プリントして ぬりえを たのしもう！</li>
      </ol>
    </div>

    <div class="step-container">
      <h2 class="step-title">📸 しゃしんを えらんでね</h2>

      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">📷</div>
        <div class="upload-text">ここを タップして しゃしんを えらんでね</div>
        <div style="font-size:0.9rem;color:#666;">または しゃしんを ドラッグしてね</div>
        <input type="file" id="fileInput" class="file-input" accept="image/*">
      </div>

      <div class="error-message" id="errorMessage"></div>

      <div id="previewContainer" style="text-align:center;margin-top:20px;"></div>

      <div style="text-align:center;margin-top:20px;">
        <button class="button" id="generateButton" disabled>🎨 ぬりえにする！</button>
      </div>
    </div>

    <div class="loading" id="loadingContainer">
      <div class="spinner"></div>
      <p style="font-size:1.2rem;color:#FF69B4;">ぬりえを つくっているよ... ちょっと まってね！ ✨</p>
    </div>

    <div class="step-container result-container" id="resultContainer">
      <h2 class="step-title">🎉 できあがり！</h2>
      <div id="resultImage"></div>
      <button class="button print-button" onclick="printColoring()">🖨️ プリントする</button>
    </div>
  </div>

  <!-- ==================== JavaScript ==================== -->
  <script>
    /* ---------- 変数 ---------- */
    let selectedFile   = null;
    let pollTimer      = null;
    let processedBase64 = '', maskBase64 = '';

    /* DOM取得 */
    const uploadArea      = document.getElementById('uploadArea');
    const fileInput       = document.getElementById('fileInput');
    const previewContainer= document.getElementById('previewContainer');
    const generateButton  = document.getElementById('generateButton');
    const loadingContainer= document.getElementById('loadingContainer');
    const resultContainer = document.getElementById('resultContainer');
    const errorMessage    = document.getElementById('errorMessage');

    /* ---------- アップロード UI ---------- */
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover',  e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop',      e => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change',     e => handleFile(e.target.files[0]));

    function handleFile(file){
      if(!file){ return; }

      if(!file.type.startsWith('image/')){
        showError('しゃしんファイルを えらんでね！'); return;
      }
      if(file.size > 10*1024*1024){
        showError('しゃしんが おおきすぎるよ！'); return;
      }
      selectedFile = file;
      hideError();
      showPreview(file);
      generateButton.disabled = false;
    }

    function showPreview(file){
      const reader = new FileReader();
      reader.onload = e => {
        previewContainer.innerHTML = `
          <img src="${e.target.result}" alt="選択した画像" class="image-preview">
          <p style="color:#FF69B4;font-size:1.1rem;margin-top:10px;">いいしゃしんだね！ 🌟</p>
        `;
      };
      reader.readAsDataURL(file);
    }

    function showError(msg){
      errorMessage.textContent = msg;
      errorMessage.style.display = 'block';
    }
    function hideError(){ errorMessage.style.display = 'none'; }

    /* ---------- ぬりえ生成フロー（非同期） ---------- */
    generateButton.addEventListener('click', async () => {
      if(!selectedFile){ showError('まず しゃしんを えらんでね！'); return; }

      // ボタン無効化＆ローディング
      generateButton.disabled = true;
      loadingContainer.style.display = 'block';
      resultContainer.style.display  = 'none';
      hideError();

      try{
        /* 1) 画像を 512×512 PNG に加工し、透明マスク生成 */
        processedBase64 = await toSquarePNG(selectedFile, 512);
        maskBase64      = createTransparentMask(512);

        /* 2) ジョブ登録 */
        const res = await fetch('/.netlify/functions/start-coloring', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ imageData: processedBase64, maskData: maskBase64 })
        });
        const { jobId } = await res.json();
        if(!jobId) throw new Error('ジョブIDが取得できませんでした');

        /* 3) 5 秒おきに結果チェック */
        pollTimer = setInterval(async () => {
          const chk = await fetch(`/.netlify/functions/check-coloring?id=${jobId}`);
          const data = await chk.json();
          if(data.status === 'done'){
            clearInterval(pollTimer);
            showResult(data.imageUrl);
            loadingContainer.style.display = 'none';
            generateButton.disabled = false;
          }
        }, 5000);

      }catch(err){
        console.error(err);
        showError('ごめんね、エラーが おきちゃった。もういちど ためしてね！\n' + err.message);
        loadingContainer.style.display = 'none';
        generateButton.disabled = false;
      }
    });

    /* ---------- 共通ユーティリティ ---------- */
    function toSquarePNG(file, size=512){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = canvas.height = size;
          const ctx = canvas.getContext('2d');
          const shorter = Math.min(img.width, img.height);
          const sx = (img.width - shorter) / 2;
          const sy = (img.height - shorter) / 2;
          ctx.drawImage(img, sx, sy, shorter, shorter, 0, 0, size, size);
          canvas.toBlob(blob => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror   = reject;
            reader.readAsDataURL(blob);
          }, 'image/png');
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    function createTransparentMask(size=512){
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = size;
      return canvas.toDataURL('image/png');
    }

    function showResult(url){
      document.getElementById('resultImage').innerHTML = `
        <div style="margin-bottom:20px;">
          <p style="color:#FF69B4;font-size:1.3rem;margin-bottom:15px;">🎉 ぬりえが できたよ！</p>
          <img src="${url}" alt="生成されたぬりえ" style="max-width:100%;max-height:500px;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,.1);">
          <p style="color:#8B4513;font-size:1rem;margin-top:10px;">すてきな ぬりえが できました！<br>いろんないろで ぬってみてね 🌈</p>
        </div>
      `;
      resultContainer.style.display = 'block';
      resultContainer.scrollIntoView({ behavior:'smooth' });
    }

    function printColoring(){
      const html = document.getElementById('resultImage').innerHTML;
      const w = window.open('','_blank');
      w.document.write(`
        <html><head><title>せかいぬりえ</title>
        <style>
          body{margin:0;padding:20px;text-align:center;font-family:Arial,sans-serif}
          img{max-width:100%;border:2px solid #000}
          @media print{body{margin:10px}}
        </style></head><body>
        <h1>🌈 せかいぬりえ 🎨</h1>${html}</body></html>
      `);
      w.document.close();
      w.print();
    }
  </script>
</body>
</html>
