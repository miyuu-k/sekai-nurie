<!DOCTYPE html><html lang="ja"><head>
<meta charset="UTF-8"><title>線画ジェネレーター</title>
<link rel="stylesheet" href="style.css"></head><body>
<h1>ぬりえ線画ジェネレーター</h1>
<input type="file" id="file" accept="image/*">
<button id="btn" disabled>線画にする</button>
<p id="msg"></p><img id="out" alt="">
<script>
const $ = (id)=>document.getElementById(id);
let file=null;

$("file").onchange = (e)=>{file=e.target.files[0];$("btn").disabled=!file;$("out").src="";$("msg").textContent="";};

$("btn").onclick = async ()=>{
  if(!file)return;
  $("btn").disabled=true;$("msg").textContent="アップロード中…";
  try{
    const blob = await resize(file,512);
    const fd=new FormData();fd.append("file",blob,"img.png");
    /* 1. BG 関数起動 */
    const bgRes = await fetch("/.netlify/functions/lineart-background",{method:"POST",body:fd});
    if(!bgRes.ok) throw new Error(await bgRes.text());
    const {jobId}=await bgRes.json();

    /* 2. ポーリングで結果取得 */
    let url=null, retry=0;
    while(retry<40){      // 最大 40×1.5s ≒ 1 分
      const r=await fetch(`/.netlify/functions/lineart-result?id=${jobId}`);
      if(r.status===200){ ({url}=await r.json());break;}
      await new Promise(s=>setTimeout(s,1500));
      retry++;
    }
    if(!url) throw new Error("timeout");
    $("out").src=url;$("msg").textContent="完了！";
  }catch(e){$("msg").textContent="ERR: "+e.message;}
  $("btn").disabled=false;
};

/* helper: 画像を 512px PNG に */
function resize(file,size){
  return new Promise((ok,ng)=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement("canvas");
      c.width=c.height=size;
      c.getContext("2d").drawImage(img,0,0,size,size);
      c.toBlob(b=>b?ok(b):ng("blob err"),"image/png");
    };
    img.onerror=ng;img.src=URL.createObjectURL(file);
  });
}
</script></body></html>
