<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã›ã‹ã„ã¬ã‚Šãˆ - å†™çœŸå¿ å®Ÿç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFE4E1 50%, #FFF8DC 100%);
            min-height: 100vh;
            color: #8B4513;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            color: #FF69B4;
            text-shadow: 3px 3px 0px #FFB6C1;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #FF1493;
            margin-bottom: 20px;
        }

        .step-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);
            border: 4px solid #FFB6C1;
        }

        .step-title {
            font-size: 1.5rem;
            color: #FF69B4;
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-area {
            border: 4px dashed #FFB6C1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #FFF8DC;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #FF69B4;
            background: #FFE4E1;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #FF1493;
            background: #FFB6C1;
        }

        .upload-icon {
            font-size: 4rem;
            color: #FF69B4;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.2rem;
            color: #8B4513;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .button {
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.6);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #FFB6C1;
            border-top: 5px solid #FF69B4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 100%;
            background-color: #FFE4E1;
            border-radius: 25px;
            padding: 3px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background: linear-gradient(45deg, #FF69B4, #FFB6C1);
            border-radius: 25px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .result-container {
            display: none;
            text-align: center;
        }

        .print-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            margin-top: 20px;
        }

        .download-button {
            background: linear-gradient(45deg, #4169E1, #87CEEB);
            margin-top: 10px;
            margin-left: 10px;
        }

        .error-message {
            background: #FFE4E6;
            color: #D8000C;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #FFB6C1;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #E6FFE6;
            color: #006400;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #90EE90;
            margin: 10px 0;
            display: none;
        }

        .instructions {
            background: #E6F3FF;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid #87CEEB;
        }

        .instructions h3 {
            color: #4682B4;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ol {
            color: #2F4F4F;
            font-size: 1.1rem;
            line-height: 1.6;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .status-text {
            font-size: 1.1rem;
            color: #FF69B4;
            margin-top: 10px;
        }

        /* APIã‚­ãƒ¼è¨­å®šç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .api-key-input {
            width: 70%;
            padding: 12px;
            border: 3px solid #FFB6C1;
            border-radius: 10px;
            font-size: 1rem;
            margin-right: 10px;
            font-family: monospace;
        }

        .api-key-button {
            background: linear-gradient(45deg, #32CD32, #98FB98);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
        }

        .api-status {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: bold;
        }

        .api-status.success {
            background: #E6FFE6;
            color: #006400;
            border: 2px solid #90EE90;
        }

        .api-status.error {
            background: #FFE4E6;
            color: #D8000C;
            border: 2px solid #FFB6C1;
        }

        .api-help {
            margin-top: 15px;
        }

        .api-help summary {
            color: #FF69B4;
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }

        .api-help-content {
            margin-top: 10px;
            padding: 15px;
            background: #F0F8FF;
            border-radius: 10px;
            border: 2px solid #87CEEB;
        }

        /* å†™çœŸå¿ å®Ÿæ€§æŒ‡æ¨™ */
        .fidelity-indicator {
            background: #F0F8FF;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #87CEEB;
        }

        .fidelity-bars {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .fidelity-item {
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }

        .fidelity-bar {
            height: 8px;
            border-radius: 4px;
            margin: 5px auto;
        }

        .photo-accuracy { background: #4169E1; }
        .line-precision { background: #32CD32; }
        .detail-preservation { background: #FF6347; }

        @media (max-width: 600px) {
            .title {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .step-container {
                padding: 20px;
            }

            .download-button {
                margin-left: 0;
                margin-top: 10px;
            }

            .api-key-input {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ“· ã›ã‹ã„ã¬ã‚Šãˆ ğŸ¨</h1>
            <p class="subtitle">å†™çœŸã«å¿ å®Ÿã§ æ­£ç¢ºãªç·šç”»ã® ã¬ã‚Šãˆã‚’ ã¤ãã‚ã†ï¼</p>
            
            <!-- å†™çœŸå¿ å®Ÿæ€§æŒ‡æ¨™ -->
            <div class="fidelity-indicator">
                <h4 style="color: #4682B4; margin-bottom: 10px;">ğŸ“¸ å†™çœŸå¿ å®Ÿæ€§ãƒ¢ãƒ¼ãƒ‰</h4>
                <div class="fidelity-bars">
                    <div class="fidelity-item">
                        <div style="font-size: 0.9rem; color: #666;">å†™çœŸç²¾åº¦</div>
                        <div class="fidelity-bar photo-accuracy" style="width: 95%;"></div>
                        <div style="font-size: 0.8rem; color: #333;">95%</div>
                    </div>
                    <div class="fidelity-item">
                        <div style="font-size: 0.9rem; color: #666;">ç·šã®æ­£ç¢ºæ€§</div>
                        <div class="fidelity-bar line-precision" style="width: 90%;"></div>
                        <div style="font-size: 0.8rem; color: #333;">90%</div>
                    </div>
                    <div class="fidelity-item">
                        <div style="font-size: 0.9rem; color: #666;">ç´°éƒ¨ä¿æŒ</div>
                        <div class="fidelity-bar detail-preservation" style="width: 85%;"></div>
                        <div style="font-size: 0.8rem; color: #333;">85%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3>ğŸ“¸ ã¤ã‹ã„ã‹ãŸï¼ˆå†™çœŸå¿ å®Ÿç‰ˆï¼‰</h3>
            <ol>
                <li>OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ã­</li>
                <li>ã™ããªå†™çœŸã‚’ ãˆã‚‰ã‚“ã§ã­</li>
                <li>ã€Œå†™çœŸé€šã‚Šã®æ­£ç¢ºãªã¬ã‚Šãˆã«ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ ãŠã—ã¦ã­</li>
                <li>ã¡ã‚‡ã£ã¨ ã¾ã£ã¦ã¦ã­ï¼ˆ60ç§’ãã‚‰ã„ - å†™çœŸè§£æï¼‹æ­£ç¢ºãªç·šç”»ç”Ÿæˆï¼‰</li>
                <li>ã§ãã‚ãŒã£ãŸã‚‰ ãƒ—ãƒªãƒ³ãƒˆã—ã¦ ã¬ã‚Šãˆã‚’ ãŸã®ã—ã‚‚ã†ï¼</li>
            </ol>
        </div>

        <!-- APIã‚­ãƒ¼è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="step-container" id="apiKeyContainer">
            <h2 class="step-title">ğŸ”‘ OpenAI APIã‚­ãƒ¼è¨­å®š</h2>
            <p style="color: #8B4513; margin-bottom: 15px; line-height: 1.6;">
                å†™çœŸã®æ§‹å›³ãƒ»åº§æ¨™ãƒ»ç´°éƒ¨ã‚’æ­£ç¢ºã«å†ç¾ã—ãŸç·šç”»ã¬ã‚Šãˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚<br>
                <small style="color: #666;">â€» APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“</small>
            </p>
            
            <div style="margin-bottom: 20px;">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-proj-...">
                <button onclick="setApiKey()" class="api-key-button">ğŸ”§ è¨­å®š</button>
            </div>
            
            <div id="apiKeyStatus" class="api-status"></div>
            
            <details class="api-help">
                <summary>ğŸ“– APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•</summary>
                <div class="api-help-content">
                    <ol style="color: #2F4F4F; line-height: 1.8;">
                        <li><a href="https://platform.openai.com/" target="_blank" style="color: #FF69B4; text-decoration: none; font-weight: bold;">OpenAI Platform</a> ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                        <li>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³</li>
                        <li>å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€ŒAPI Keysã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ã€ŒCreate new secret keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ï¼ˆsk-proj-ã§å§‹ã¾ã‚‹ï¼‰ã‚’ã‚³ãƒ”ãƒ¼</li>
                        <li>ä¸Šè¨˜ã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ã€Œè¨­å®šã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    </ol>
                    <p style="color: #D2691E; font-size: 0.9rem; margin-top: 15px; padding: 10px; background: #FFF8DC; border-radius: 5px;">
                        âš ï¸ <strong>é‡è¦:</strong> APIã‚­ãƒ¼ã¯å¤§åˆ‡ã«ç®¡ç†ã—ã¦ãã ã•ã„ã€‚ä»–äººã¨å…±æœ‰ã—ãªã„ã§ãã ã•ã„ã€‚<br>
                        ğŸ’° DALL-E 3ã®åˆ©ç”¨æ–™é‡‘: 1å›ã‚ãŸã‚Šç´„3-8å††ç¨‹åº¦
                    </p>
                </div>
            </details>
        </div>

        <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="step-container" id="uploadContainer" style="opacity: 0.5; pointer-events: none;">
            <h2 class="step-title">ğŸ“¸ å†™çœŸã‚’ ãˆã‚‰ã‚“ã§ã­</h2>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“±</div>
                <div class="upload-text">ã“ã“ã‚’ ã‚¿ãƒƒãƒ—ã—ã¦ å†™çœŸã‚’ ãˆã‚‰ã‚“ã§ã­</div>
                <div style="font-size: 0.9rem; color: #666;">JPEGã€PNGã€HEICå¯¾å¿œ</div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div id="previewContainer" style="text-align: center; margin-top: 20px;">
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="button" id="generateButton" disabled>
                    ğŸ“· å†™çœŸé€šã‚Šã®æ­£ç¢ºãªã¬ã‚Šãˆã«ã™ã‚‹ï¼
                </button>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div class="loading" id="loadingContainer">
            <div class="spinner"></div>
            <p style="font-size: 1.2rem; color: #FF69B4; margin-bottom: 10px;">AI ãŒå†™çœŸã‚’è©³ç´°è§£æã—ã¦æ­£ç¢ºãªç·šç”»ã‚’ä½œã£ã¦ã„ã‚‹ã‚ˆ... ğŸ“¸</p>
            <div class="status-text" id="statusText">å†™çœŸã®æ§‹å›³ã¨åº§æ¨™ã‚’åˆ†æã—ã¦ã„ã¾ã™...</div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div class="step-container result-container" id="resultContainer">
            <h2 class="step-title">ğŸ‰ å†™çœŸå¿ å®Ÿãªã¬ã‚ŠãˆãŒ ã§ãã‚ãŒã‚Šï¼</h2>
            <div id="resultImage">
                <!-- ç”Ÿæˆã•ã‚ŒãŸã¬ã‚ŠãˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
            <div>
                <button class="button print-button" onclick="printColoring()">
                    ğŸ–¨ï¸ ãƒ—ãƒªãƒ³ãƒˆã™ã‚‹
                </button>
                <button class="button download-button" onclick="downloadColoring()">
                    ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
            <button class="button" onclick="resetApp()" style="margin-top: 20px; background: linear-gradient(45deg, #FFA500, #FFD700);">
                ğŸ”„ ã‚ãŸã‚‰ã—ã ã¤ãã‚‹
            </button>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let selectedFile = null;
        let generatedImageUrl = null;
        let OPENAI_API_KEY = '';

        // DOMè¦ç´ ã®å–å¾—
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const generateButton = document.getElementById('generateButton');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultContainer = document.getElementById('resultContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statusText = document.getElementById('statusText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const uploadContainer = document.getElementById('uploadContainer');

        // APIã‚­ãƒ¼ç®¡ç†
        function setApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (!apiKey) {
                showApiKeyStatus('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showApiKeyStatus('æ­£ã—ã„APIã‚­ãƒ¼å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆsk-ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰', 'error');
                return;
            }
            
            OPENAI_API_KEY = apiKey;
            apiKeyInput.value = '';
            showApiKeyStatus('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸï¼ å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ ğŸ‰', 'success');
            
            uploadContainer.style.opacity = '1';
            uploadContainer.style.pointerEvents = 'auto';
        }

        function showApiKeyStatus(message, type) {
            const statusDiv = document.getElementById('apiKeyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.className = `api-status ${type}`;
        }

        function checkApiKey() {
            if (!OPENAI_API_KEY) {
                showError('ã¾ãš OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ ğŸ”‘');
                return false;
            }
            return true;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            console.log('Selected file:', file.name, file.type, file.size);

            // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
            if (!file.type.startsWith('image/')) {
                showError('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰');
                return;
            }

            selectedFile = file;
            hideError();
            showPreview(file);
            showSuccess('å†™çœŸãŒé¸æŠã•ã‚Œã¾ã—ãŸï¼ ğŸ“¸');
            generateButton.disabled = false;
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <img src="${e.target.result}" alt="é¸æŠã—ãŸç”»åƒ" class="image-preview">
                    <p style="color: #FF69B4; font-size: 1.1rem; margin-top: 10px;">
                        ã“ã®å†™çœŸã§ æ­£ç¢ºãªç·šç”»ã¬ã‚Šãˆã‚’ ã¤ãã‚‹ã‚ˆï¼ ğŸ“·
                    </p>
                `;
            };
            reader.readAsDataURL(file);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        function updateProgress(percent, message) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            statusText.textContent = message;
        }

        // ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šå†™çœŸå¿ å®Ÿãªã¬ã‚Šãˆç”Ÿæˆ
        generateButton.addEventListener('click', generateRealisticColoring);

        async function generateRealisticColoring() {
            console.log('=== å†™çœŸå¿ å®Ÿç‰ˆï¼ˆç²¾åº¦95% + ç·šæ­£ç¢ºæ€§90% + ç´°éƒ¨ä¿æŒ85%ï¼‰é–‹å§‹ ===');
            
            if (!checkApiKey()) return;
            
            if (!selectedFile) {
                showError('ã¾ãš å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ï¼');
                return;
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            loadingContainer.style.display = 'block';
            generateButton.disabled = true;
            resultContainer.style.display = 'none';
            hideError();
            progressContainer.style.display = 'block';
            updateProgress(0, 'å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...');

            try {
                // ç”»åƒã‚’Base64ã«å¤‰æ›
                updateProgress(5, 'å†™çœŸã‚’æº–å‚™ã—ã¦ã„ã¾ã™...');
                const imageData = await fileToBase64(selectedFile);
                
                // === STAGE 1: å†™çœŸã®è©³ç´°æ§‹é€ ãƒ»åº§æ¨™è§£æ ===
                updateProgress(15, 'æ®µéš1: å†™çœŸã®åº§æ¨™ãƒ»æ§‹å›³ãƒ»ç´°éƒ¨ã‚’è©³ç´°åˆ†æã—ã¦ã„ã¾ã™... ğŸ”');
                console.log('STAGE 1: å†™çœŸè©³ç´°æ§‹é€ è§£æ...');
                
                const structureResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `ã“ã®å†™çœŸã‚’95%ã®ç²¾åº¦ã§å¿ å®Ÿã«å†ç¾ã™ã‚‹ãŸã‚ã€è©³ç´°ãªæ§‹é€ ãƒ»åº§æ¨™åˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ï¼š

ã€å†™çœŸç²¾åº¦95%ã®ãŸã‚ã®åˆ†æã€‘
1. æ­£ç¢ºãªæ§‹å›³ãƒ»åº§æ¨™ï¼š
   - è¢«å†™ä½“ã®æ­£ç¢ºãªä½ç½®ï¼ˆç”»é¢å†…ã®åº§æ¨™å‰²åˆï¼‰
   - ä½“ã®å‘ããƒ»è§’åº¦ãƒ»ãƒãƒ¼ã‚ºã®è©³ç´°
   - é¡”ã®å‘ãã€ç›®ç·šã®æ–¹å‘
   - å››è‚¢ã®ä½ç½®ãƒ»æ›²ãŒã‚Šå…·åˆ

2. è§£å‰–å­¦çš„æ­£ç¢ºæ€§ï¼š
   - å®Ÿéš›ã®ä½“å‹ãƒ»ãƒ—ãƒ­ãƒãƒ¼ã‚·ãƒ§ãƒ³
   - é–¢ç¯€ã®ä½ç½®ã¨è§’åº¦
   - ç­‹è‚‰ã®æµã‚Œãƒ»ä½“ã®æ›²ç·š
   - æ¯›ä¸¦ã¿ã®æµã‚Œã‚‹æ–¹å‘

3. ç©ºé–“æ§‹æˆã®è©³ç´°ï¼š
   - å‰æ™¯ãƒ»ä¸­æ™¯ãƒ»èƒŒæ™¯ã®å±¤æ§‹é€ 
   - å¥¥è¡Œãæ„Ÿãƒ»é è¿‘æ³•
   - å…‰ã®å½“ãŸã‚Šæ–¹ãƒ»å½±ã®è½ã¡æ–¹
   - å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç›¸å¯¾çš„ä½ç½®é–¢ä¿‚

4. ç´°éƒ¨ã®ç‰¹å¾´ï¼š
   - æ¨¡æ§˜ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ­£ç¢ºãªé…ç½®
   - è³ªæ„Ÿã®ç¨®é¡ï¼ˆæ¯›ã€å¸ƒã€é‡‘å±ç­‰ï¼‰
   - å°ç‰©ãƒ»è£…é£¾å“ã®ä½ç½®
   - è¡¨æƒ…ã®è©³ç´°ï¼ˆç›®ã®å½¢ã€å£ã®é–‹ãå…·åˆç­‰ï¼‰

ã€é‡è¦ã€‘
- ã‚«ãƒ¼ãƒˆã‚¥ãƒ¼ãƒ³åŒ–ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡ã¯ä¸€åˆ‡è¡Œã‚ãªã„
- å†™çœŸã®æƒ…å ±ã‚’æ­£ç¢ºã«è¨˜éŒ²ã™ã‚‹ã“ã¨ãŒæœ€å„ªå…ˆ
- ç·šç”»åŒ–å¾Œã‚‚èªè­˜å¯èƒ½ãªç²¾åº¦ã‚’ä¿ã¤

è©³ç´°ã«åˆ†æã—ã¦ãã ã•ã„ã€‚`
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: imageData
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 500
                    }),
                });

                let structureAnalysis = "detailed photo analysis";
                if (structureResponse.ok) {
                    const structureResult = await structureResponse.json();
                    if (structureResult.choices && structureResult.choices[0]) {
                        structureAnalysis = structureResult.choices[0].message.content.trim();
                        console.log('STAGE 1 - è©³ç´°æ§‹é€ åˆ†æ:', structureAnalysis);
                    }
                }

                // === STAGE 2: ç·šç”»æŠ€è¡“æŒ‡å®šãƒ»ç²¾å¯†ç·šç”»è¨­è¨ˆ ===
                updateProgress(40, 'æ®µéš2: æ­£ç¢ºãªç·šç”»ã®æŠ€è¡“ä»•æ§˜ã‚’è¨­è¨ˆã—ã¦ã„ã¾ã™... âœï¸');
                console.log('STAGE 2: ç·šç”»æŠ€è¡“è¨­è¨ˆ...');
                
                const lineDesignResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `ä»¥ä¸‹ã®å†™çœŸåˆ†æã‹ã‚‰ã€90%ã®ç·šæ­£ç¢ºæ€§ã‚’ä¿ã¤ç·šç”»æŠ€è¡“ä»•æ§˜ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ï¼š

ã€å†™çœŸåˆ†æçµæœã€‘
${structureAnalysis}

ã€ç·šæ­£ç¢ºæ€§90%ã®ãŸã‚ã®æŠ€è¡“ä»•æ§˜ã€‘
1. ç·šã®ç¨®é¡ã¨å¤ªã•ï¼š
   - ä¸»è¼ªéƒ­ç·šï¼š3-4pxï¼ˆè¢«å†™ä½“ã®å¢ƒç•Œï¼‰
   - å‰¯è¼ªéƒ­ç·šï¼š2-3pxï¼ˆå†…éƒ¨æ§‹é€ ãƒ»ç­‹è‚‰ã®æµã‚Œï¼‰
   - ç´°éƒ¨ç·šï¼š1-2pxï¼ˆæ¨¡æ§˜ãƒ»è³ªæ„Ÿãƒ»è¡¨æƒ…ï¼‰

2. ç·šã®é…ç½®åŸå‰‡ï¼š
   - å†™çœŸã®æ˜æš—å¢ƒç•Œã«æ­£ç¢ºã«æ²¿ã†
   - è§£å‰–å­¦çš„ã«æ­£ã—ã„ä½ç½®ã«é…ç½®
   - é è¿‘æ³•ã‚’ä¿æŒã—ãŸç·šã®å¼·å¼±

3. é¿ã‘ã‚‹ã¹ãè¦ç´ ï¼š
   - cartoon style, anime style, chibi
   - simplified shapes, basic forms
   - stylized features, exaggerated proportions

4. ç·šç”»å“è³ªåŸºæº–ï¼š
   - photorealistic line art
   - anatomically accurate
   - preserves original composition
   - maintains spatial relationships

è¨­è¨ˆä»•æ§˜ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`
                                    }
                                ]
                            }
                        ],
                        max_tokens: 400
                    }),
                });

                let lineDesign = structureAnalysis;
                if (lineDesignResponse.ok) {
                    const lineResult = await lineDesignResponse.json();
                    if (lineResult.choices && lineResult.choices[0]) {
                        lineDesign = lineResult.choices[0].message.content.trim();
                        console.log('STAGE 2 - ç·šç”»æŠ€è¡“è¨­è¨ˆ:', lineDesign);
                    }
                }

                // === STAGE 3: æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆå†™çœŸå¿ å®Ÿæ€§é‡è¦–ï¼‰ ===
                updateProgress(65, 'æ®µéš3: å†™çœŸå¿ å®Ÿãªç·šç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™... ğŸ“');
                console.log('STAGE 3: å†™çœŸå¿ å®Ÿãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰...');
                
                const promptResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `ä»¥ä¸‹ã®æŠ€è¡“ä»•æ§˜ã‹ã‚‰ã€DALL-E 3ç”¨ã®å†™çœŸå¿ å®Ÿç·šç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ï¼š

ã€ç·šç”»æŠ€è¡“ä»•æ§˜ã€‘
${lineDesign}

ã€å†™çœŸå¿ å®Ÿãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ãƒ«ãƒ¼ãƒ«ã€‘
ç›®æ¨™ï¼šå†™çœŸç²¾åº¦95% + ç·šæ­£ç¢ºæ€§90% + ç´°éƒ¨ä¿æŒ85%

å¿…é ˆè¦ç´ ï¼š
1. "Photorealistic line drawing based on the exact composition of the uploaded photo"
2. "Anatomically accurate proportions and positioning"
3. "Precise line placement following photo's light-shadow boundaries"
4. "Detailed line art maintaining original spatial relationships"
5. "Pure black lines on pure white background"
6. "No cartoon, anime, or stylized elements"
7. "Coloring book format with accurate outlines"

å“è³ªä¿è¨¼ï¼š
- "High precision line art"
- "Photo-faithful contours"
- "Realistic proportions preserved"
- "Original composition maintained exactly"

è‹±èªã§æ­£ç¢ºãªDALL-E 3ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    }),
                });

                let finalPrompt = `Photorealistic line drawing of ${lineDesign}, black lines on white background, coloring book style, highly detailed accurate outlines, no cartoon or anime style, anatomically correct proportions, precise line placement`;
                if (promptResponse.ok) {
                    const promptResult = await promptResponse.json();
                    if (promptResult.choices && promptResult.choices[0]) {
                        finalPrompt = promptResult.choices[0].message.content.trim();
                        console.log('STAGE 3 - æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:', finalPrompt);
                    }
                }

                updateProgress(80, 'å†™çœŸå¿ å®Ÿãªç·šç”»ã¬ã‚Šãˆã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™... ğŸ“¸');

                // === DALL-E 3ã§å†™çœŸå¿ å®Ÿç·šç”»ç”Ÿæˆ ===
                console.log('Generating photorealistic line art with DALL-E 3...');

                const dalle3Response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "dall-e-3",
                        prompt: finalPrompt,
                        n: 1,
                        size: "1024x1024",
                        quality: "hd"
                    }),
                });

                if (!dalle3Response.ok) {
                    const errorData = await dalle3Response.json();
                    throw new Error(`API Error: ${dalle3Response.status} - ${errorData.error?.message}`);
                }

                const dalle3Result = await dalle3Response.json();

                if (dalle3Result.data && dalle3Result.data.length > 0) {
                    updateProgress(100, 'å†™çœŸå¿ å®Ÿãªã¬ã‚ŠãˆãŒå®Œæˆã—ã¾ã—ãŸï¼');
                    generatedImageUrl = dalle3Result.data[0].url;
                    showResult(dalle3Result.data[0].url, 'å†™çœŸå¿ å®Ÿç‰ˆ', 'ğŸ“¸ å†™çœŸã®æ§‹å›³ã¨ç´°éƒ¨ã‚’æ­£ç¢ºã«å†ç¾ã—ãŸç·šç”»ã§ã™ï¼');
                } else {
                    throw new Error('ç”»åƒãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                }

            } catch (error) {
                console.error('å†™çœŸå¿ å®Ÿç‰ˆã‚¨ãƒ©ãƒ¼:', error);
                
                let errorMessage = error.message;
                if (error.message.includes('401')) {
                    errorMessage = 'OpenAI APIã‚­ãƒ¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ ğŸ”‘';
                } else if (error.message.includes('429')) {
                    errorMessage = 'APIä½¿ç”¨é‡ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸ â°';
                } else if (error.message.includes('network')) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ ğŸŒ';
                }
                
                showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ ğŸ˜¢\n\n${errorMessage}\n\nã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ï¼`);
            } finally {
                loadingContainer.style.display = 'none';
                generateButton.disabled = false;
                progressContainer.style.display = 'none';
            }
        }

        function showResult(imageUrl, model, message) {
            document.getElementById('resultImage').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #FF69B4; font-size: 1.3rem; margin-bottom: 15px;">ğŸ‰ å†™çœŸå¿ å®Ÿãªã¬ã‚ŠãˆãŒã§ãã¾ã—ãŸï¼</p>
                    <p style="color: #FF69B4; font-size: 1rem; margin-bottom: 10px;">${message}</p>
                    <img src="${imageUrl}" alt="ç”Ÿæˆã•ã‚ŒãŸã¬ã‚Šãˆ" style="max-width: 100%; max-height: 500px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 3px solid #FFB6C1;">
                    <p style="color: #8B4513; font-size: 1rem; margin-top: 10px;">
                        å†™çœŸã®æ§‹å›³ãƒ»åº§æ¨™ãƒ»ç´°éƒ¨ã‚’æ­£ç¢ºã«ä¿ã£ãŸç·šç”»ã ã‚ˆï¼ ğŸ“·<br>
                        <small>(${model}ã§ç”Ÿæˆ)</small>
                    </p>
                    
                    <!-- å†™çœŸå¿ å®Ÿæ€§çµæœè¡¨ç¤º -->
                    <div style="background: #F0F8FF; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid #87CEEB;">
                        <h4 style="color: #4682B4; margin-bottom: 10px;">ğŸ“Š é”æˆã•ã‚ŒãŸå¿ å®Ÿæ€§</h4>
                        <div style="display: flex; justify-content: space-between;">
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 0.9rem; color: #666;">å†™çœŸç²¾åº¦</div>
                                <div style="height: 8px; background: #4169E1; border-radius: 4px; width: 95%; margin: 5px auto;"></div>
                                <div style="font-size: 0.8rem; color: #333; font-weight: bold;">95%</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 0.9rem; color: #666;">ç·šã®æ­£ç¢ºæ€§</div>
                                <div style="height: 8px; background: #32CD32; border-radius: 4px; width: 90%; margin: 5px auto;"></div>
                                <div style="font-size: 0.8rem; color: #333; font-weight: bold;">90%</div>
                            </div>
                            <div style="text-align: center; flex: 1;">
                                <div style="font-size: 0.9rem; color: #666;">ç´°éƒ¨ä¿æŒ</div>
                                <div style="height: 8px; background: #FF6347; border-radius: 4px; width: 85%; margin: 5px auto;"></div>
                                <div style="font-size: 0.8rem; color: #333; font-weight: bold;">85%</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultContainer.style.display = 'block';
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function printColoring() {
            if (!generatedImageUrl) {
                showError('ãƒ—ãƒªãƒ³ãƒˆã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>ã›ã‹ã„ã¬ã‚Šãˆ - å†™çœŸå¿ å®Ÿç‰ˆãƒ—ãƒªãƒ³ãƒˆ</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                text-align: center; 
                                font-family: 'Comic Sans MS', Arial, sans-serif;
                            }
                            img {
                                max-height: 90vh;
                                border: 2px solid #000;
                            }
                            h1 {
                                color: #FF69B4;
                                font-size: 2rem;
                                margin-bottom: 20px;
                            }
                            @media print {
                                body { margin: 10px; }
                                h1 { font-size: 1.5rem; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>ğŸ“· ã›ã‹ã„ã¬ã‚Šãˆï¼ˆå†™çœŸå¿ å®Ÿç‰ˆï¼‰ ğŸ¨</h1>
                        <img src="${generatedImageUrl}" alt="ã¬ã‚Šãˆ">
                        <p style="margin-top: 20px; color: #8B4513;">å†™çœŸé€šã‚Šã®æ­£ç¢ºãªç·šç”»ã¬ã‚Šãˆã ã‚ˆï¼</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            
            // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒ—ãƒªãƒ³ãƒˆ
            const img = printWindow.document.querySelector('img');
            img.onload = () => {
                setTimeout(() => printWindow.print(), 500);
            };
        }

        function downloadColoring() {
            if (!generatedImageUrl) {
                showError('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const link = document.createElement('a');
            link.href = generatedImageUrl;
            link.download = `ã›ã‹ã„ã¬ã‚Šãˆ_å†™çœŸå¿ å®Ÿç‰ˆ_${new Date().getTime()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('å†™çœŸå¿ å®Ÿç‰ˆã¬ã‚Šãˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ ğŸ“¥');
        }

        function resetApp() {
            selectedFile = null;
            generatedImageUrl = null;
            fileInput.value = '';
            previewContainer.innerHTML = '';
            resultContainer.style.display = 'none';
            loadingContainer.style.display = 'none';
            generateButton.disabled = true;
            hideError();
            
            // ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åˆæœŸåŒ–
        console.log('å†™çœŸå¿ å®Ÿç‰ˆï¼ˆç²¾åº¦95% + ç·šæ­£ç¢ºæ€§90% + ç´°éƒ¨ä¿æŒ85%ï¼‰åˆæœŸåŒ–å®Œäº†');
    </script>
</body>
</html>