<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ぬりえ線画ジェネレーター</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>ぬりえ線画ジェネレーター</h1>

  <input type="file" id="file" accept="image/*" />
  <button id="btn" disabled>ぬりえを作る</button>

  <p id="msg"></p>
  <img id="result" alt="線画が表示されます" />

  <script>
    const fileInput = document.getElementById("file");
    const btn       = document.getElementById("btn");
    const msg       = document.getElementById("msg");
    const resultImg = document.getElementById("result");

    let selected;   // File オブジェクト保持

    fileInput.addEventListener("change", (e) => {
      selected = e.target.files[0] || null;
      btn.disabled = !selected;
      resultImg.src = "";
      msg.textContent = "";
    });

    btn.addEventListener("click", async () => {
      if (!selected) return;

      btn.disabled = true;
      msg.textContent = "アップロード中…";

      /* --- 1. 512×512 PNG Base64 にリサイズ --- */
      const blob512 = await resize(selected, 512);
      const form    = new FormData();
      form.append("file", blob512, "image.png");

      /* --- 2. Netlify Function へ POST --- */
      try {
        const res = await fetch("/.netlify/functions/lineart", {
          method: "POST",
          body: form
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const { url, error } = await res.json();
        if (error) throw new Error(error);

        /* --- 3. 線画表示 --- */
        resultImg.src = url;
        msg.textContent = "完了！";
      } catch (err) {
        msg.textContent = `エラー: ${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });

    /* ---------- helper: リサイズ ---------- */
    async function resize(file, size) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const cvs = document.createElement("canvas");
          cvs.width = cvs.height = size;
          const ctx = cvs.getContext("2d");
          ctx.drawImage(img, 0, 0, size, size);
          cvs.toBlob((b) => (b ? resolve(b) : reject("toBlob failed")), "image/png");
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }
  </script>
</body>
</html>
